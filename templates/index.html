<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rooh HMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* FORCE HIDE MODALS BY DEFAULT & ON PRINT */
      #success-modal,
      #confirm-modal,
      #emergency-modal {
        display: none;
        /* Default state */
      }

      #success-modal:not(.hidden),
      #confirm-modal:not(.hidden),
      #emergency-modal:not(.hidden) {
        display: flex;
        /* Only show when 'hidden' class is removed */
      }

      @media print {
        /* Critical: Hide all modals during print */
        #success-modal,
        #confirm-modal,
        #emergency-modal,
        .fixed {
          display: none !important;
        }
      }

      @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Manrope:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

      :root {
        --shamrock: #c9a749;
        /* Gold */
        --shamrock-strong: #b8941f;
        /* Darker Gold */
        --forest: #5c4d1f;
        /* Dark Brown/Gold */
        --amber: #f59e0b;
        --sky: #1d9bf0;
        --surface: #fffbf0;
        /* Off-white */
        --card: #ffffff;
        --text-main: #2c241b;
        --text-muted: #5c5c5c;
        --border-soft: #e8c547;
      }

      .urdu-text {
        font-family: 'Noto Nastaliq Urdu', 'Arial', sans-serif;
        direction: rtl;
        text-align: right;
        line-height: 1.8;
      }

      /* --- SEARCHABLE DROPDOWN STYLES --- */
      .searchable-dropdown {
        position: relative;
      }

      .searchable-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        z-index: 1000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .searchable-dropdown-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        transition: background-color 0.15s;
      }

      .searchable-dropdown-item:hover {
        background-color: #f3f4f6;
      }

      .searchable-dropdown-item.selected {
        background-color: #dbeafe;
      }

      /* --- EDITABLE CELL STYLES --- */
      .editable-cell {
        border: 1px solid transparent;
        transition: all 0.2s;
      }

      .editable-cell:focus {
        outline: 2px solid #3b82f6;
        background-color: #eff6ff !important;
        border-color: #3b82f6;
      }

      .editable-cell:hover {
        border-color: #93c5fd;
      }

      /* --- CALENDAR STYLES --- */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        text-align: center;
        font-size: 0.8rem;
        margin-top: 10px;
      }

      .calendar-day-header {
        font-weight: bold;
        color: #555;
        padding-bottom: 4px;
      }

      .calendar-day {
        padding: 6px;
        border-radius: 4px;
        background-color: #f9fafb;
      }

      .calendar-day.today {
        border: 2px solid #c9a749;
      }

      .calendar-day.call-day {
        background-color: #fffbf0;
        color: #b8941f;
        font-weight: bold;
        border: 1px solid #c9a749;
      }

      /* --- PRINT STYLES --- */
      @media print {
        .print-active {
          display: block !important;
        }

        body * {
          visibility: hidden;
        }

        /* Visible Areas */
        #printable-area,
        #printable-area * {
          visibility: visible;
        }

        #printable-discharge-slip,
        #printable-discharge-slip * {
          visibility: visible;
        }

        /* Ensure Font Awesome icons are visible */
        .fas,
        .far,
        .fab,
        .fa {
          visibility: visible !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        /* Positioning */
        #printable-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }

        #printable-discharge-slip {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          background: white;
          color: black;
          padding: 40px;
        }

        .no-print {
          display: none !important;
        }

        .page-break {
          page-break-after: always;
        }

        /* Discharge Slip Table */
        .discharge-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }

        .discharge-table th,
        .discharge-table td {
          border: 1px solid black;
          padding: 8px;
          text-align: left;
          font-size: 14px;
        }

        .discharge-header {
          margin-bottom: 30px;
          font-size: 16px;
          line-height: 2;
        }

        /* === DISCHARGE SLIP A4 SINGLE PAGE OPTIMIZATION === */
        @page discharge-slip-page {
          size: A4 portrait;
          margin: 10mm;
        }

        #printable-discharge-slip {
          page: discharge-slip-page;
          width: 190mm;
          margin: 0 auto;
          padding: 5px 15px;
          font-size: 10px !important;
          line-height: 1.3 !important;
          text-align: center;
        }

        /* Center all direct children */
        #printable-discharge-slip > * {
          margin-left: auto;
          margin-right: auto;
        }

        /* But keep text left-aligned inside elements */
        #printable-discharge-slip table,
        #printable-discharge-slip .bg-gray-50,
        #printable-discharge-slip .grid {
          text-align: left;
        }

        /* Allow content to flow naturally */
        #printable-discharge-slip * {
          page-break-inside: auto !important;
          page-break-before: auto !important;
          page-break-after: auto !important;
        }

        /* Only prevent breaks within individual table rows */
        #printable-discharge-slip tr {
          page-break-inside: avoid !important;
        }

        /* Header styling */
        #printable-discharge-slip .border-b-4 {
          padding-bottom: 8px !important;
          margin-bottom: 0 !important;
          border-width: 2px !important;
          text-align: center !important;
        }

        #printable-discharge-slip h1 {
          font-size: 20px !important;
          margin: 0 0 4px 0 !important;
          line-height: 1.2 !important;
        }

        #printable-discharge-slip h2 {
          font-size: 14px !important;
          margin: 0 0 4px 0 !important;
          line-height: 1.2 !important;
        }

        #printable-discharge-slip h3 {
          font-size: 12px !important;
          margin-bottom: 6px !important;
          margin-top: 0 !important;
          line-height: 1.2 !important;
        }

        #printable-discharge-slip .text-xs {
          font-size: 9px !important;
          line-height: 1.3 !important;
        }

        #printable-discharge-slip .text-sm {
          font-size: 10px !important;
          line-height: 1.3 !important;
        }

        #printable-discharge-slip .text-lg {
          font-size: 12px !important;
        }

        #printable-discharge-slip .text-2xl {
          font-size: 16px !important;
        }

        #printable-discharge-slip .text-3xl {
          font-size: 18px !important;
        }

        #printable-discharge-slip .text-5xl {
          font-size: 18px !important;
        }

        /* Patient info section */
        #printable-discharge-slip .bg-gray-50 {
          padding: 10px !important;
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .grid-cols-2 {
          gap: 8px !important;
        }

        #printable-discharge-slip .gap-y-4 {
          row-gap: 6px !important;
        }

        #printable-discharge-slip .gap-x-8 {
          column-gap: 12px !important;
        }

        /* Tables with proper spacing */
        #printable-discharge-slip table {
          font-size: 10px !important;
          margin-bottom: 0 !important;
          line-height: 1.3 !important;
          width: 100% !important;
        }

        #printable-discharge-slip thead th {
          padding: 6px 8px !important;
          line-height: 1.3 !important;
        }

        #printable-discharge-slip tbody td,
        #printable-discharge-slip tfoot td {
          padding: 5px 8px !important;
          line-height: 1.3 !important;
        }

        /* Payment history rows */
        #printable-discharge-slip #ds-payment-history-body td {
          padding: 4px 8px !important;
          font-size: 9px !important;
          line-height: 1.3 !important;
        }

        /* Balance box - centered */
        #printable-discharge-slip .bg-gray-900 {
          padding: 8px 15px !important;
          margin: 8px auto !important;
        }

        #printable-discharge-slip .flex.justify-end {
          justify-content: center !important;
        }

        /* Signature section */
        #printable-discharge-slip .flex.justify-between.items-end {
          margin-top: 10px !important;
          padding-top: 8px !important;
        }

        #printable-discharge-slip .mb-2.pb-4 {
          margin-bottom: 2px !important;
          padding-bottom: 8px !important;
        }

        #printable-discharge-slip .pt-6 {
          padding-top: 0 !important;
        }

        #printable-discharge-slip .w-48 {
          width: 140px !important;
        }

        /* Remove BR tags */
        #printable-discharge-slip br {
          display: none !important;
        }

        /* Spacing adjustments */
        #printable-discharge-slip .gap-4 {
          gap: 6px !important;
        }

        #printable-discharge-slip .mb-12 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mb-8 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mb-6 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mb-3 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mb-2 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mb-1 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .mt-20 {
          margin-top: 0 !important;
        }

        #printable-discharge-slip .mt-8 {
          margin-top: 0 !important;
        }

        #printable-discharge-slip .mt-4 {
          margin-top: 1px !important;
        }

        #printable-discharge-slip .mt-3 {
          margin-top: 0 !important;
        }

        #printable-discharge-slip .mt-1 {
          margin-bottom: 0 !important;
        }

        #printable-discharge-slip .pt-8 {
          padding-top: 0 !important;
        }

        #printable-discharge-slip .pb-6 {
          padding-bottom: 4px !important;
        }

        #printable-discharge-slip .pb-4 {
          padding-bottom: 3px !important;
        }

        #printable-discharge-slip .pb-1 {
          padding-bottom: 1px !important;
        }

        #printable-discharge-slip .p-8 {
          padding: 8px !important;
        }

        #printable-discharge-slip .p-6 {
          padding: 6px !important;
        }

        #printable-discharge-slip .p-4 {
          padding: 5px !important;
        }

        #printable-discharge-slip .p-3 {
          padding: 4px !important;
        }

        #printable-discharge-slip .p-2 {
          padding: 3px !important;
        }

        #printable-discharge-slip .p-1 {
          padding: 2px !important;
        }

        #printable-discharge-slip .pl-3 {
          padding-left: 4px !important;
        }

        #printable-discharge-slip .w-48 p {
          margin: 0 !important;
          line-height: 1.3 !important;
        }

        /* Rounded corners */
        #printable-discharge-slip .rounded-lg {
          border-radius: 4px !important;
        }

        /* Compact borders */
        #printable-discharge-slip .border {
          border-width: 0.5px !important;
        }

        #printable-discharge-slip .border-b {
          border-bottom-width: 0.5px !important;
        }

        #printable-discharge-slip .border-l-4 {
          border-left-width: 2px !important;
        }

        #printable-discharge-slip .border-t {
          border-top-width: 0.5px !important;
        }

        #printable-discharge-slip .border-t-2 {
          border-top-width: 1px !important;
        }

        /* Icons smaller */
        #printable-discharge-slip .fa-brain {
          font-size: 32px !important;
        }

        /* Ensure no page breaks */
        #printable-discharge-slip,
        #printable-discharge-slip > div {
          page-break-inside: avoid;
          page-break-after: avoid;
        }

        /* Force content to fit on one page */
        #printable-discharge-slip.print-active {
          max-height: 277mm;
          /* A4 height */
          overflow: hidden;
        }

        /* Original Profile Print Styles */
        .print-container {
          padding: 20px;
          font-family: 'Times New Roman', serif;
        }

        .print-header {
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          border-bottom: 2px solid #c9a749;
          padding-bottom: 10px;
          gap: 20px;
        }

        .print-logo-icon {
          font-size: 40pt;
          color: #c9a749;
        }

        .print-title-block {
          text-align: left;
        }

        .print-pro {
          font-size: 36pt;
          font-weight: bold;
          color: #c9a749;
          line-height: 1;
          letter-spacing: 2px;
        }

        .print-sub-pro {
          font-size: 14pt;
          font-weight: bold;
          color: #333;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        .print-tagline {
          font-size: 10pt;
          color: #555;
        }

        .print-row {
          display: flex;
          margin-bottom: 8px;
          border-bottom: 1px dotted #ccc;
          padding-bottom: 2px;
        }

        .print-label {
          font-weight: bold;
          width: 180px;
        }

        .print-value {
          flex: 1;
        }

        .print-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }

        .print-table th,
        .print-table td {
          border: 1px solid black;
          padding: 5px;
          text-align: left;
          font-size: 10pt;
        }

        .urdu-row {
          margin-bottom: 15px;
        }

        .box-section {
          border: 1px solid black;
          padding: 10px;
          margin-top: 20px;
          border-radius: 5px;
        }

        /* Add this: Ensure the receipt takes full screen when active */
        #printable-receipt.print-active,
        #printable-prescription.print-active {
          display: block !important;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: white;
          z-index: 9999;
        }

        /* Hide everything else when receipt is printing */
        body:has(#printable-receipt.print-active) > *:not(#printable-receipt),
        body:has(#printable-prescription.print-active) > *:not(#printable-prescription) {
          display: none;
        }

        /* --- FIX FOR RECEIPT VISIBILITY --- */
        /* --- FIX FOR RECEIPT & PRESCRIPTION VISIBILITY --- */
        #printable-receipt.print-active,
        #printable-receipt.print-active *,
        #printable-prescription.print-active,
        #printable-prescription.print-active * {
          visibility: visible !important;
        }

        #printable-receipt.print-active,
        #printable-prescription.print-active {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          min-height: 100%;
          background: white;
          z-index: 9999;
          margin: 0 !important;
          padding: 0 !important;
        }

        /* === PRESCRIPTION-ONLY PRINT STYLES === */
        @media print {
          /* Page size: Custom short prescription pad (A4 width, short height) */
          @page {
            size: 210mm 130mm;
            margin: 8mm;

            /* Remove browser's default headers/footers */
            @top-left {
              content: '';
            }

            @top-center {
              content: '';
            }

            @top-right {
              content: '';
            }

            @bottom-left {
              content: '';
            }

            @bottom-center {
              content: '';
            }

            @bottom-right {
              content: '';
            }
          }

          /* Only target the prescription container */
          #printable-prescription.print-active {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            z-index: 99999;
          }

          /* Force the inner container to fit one page with dynamic scaling */
          #printable-prescription .prescription-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100vh;
            padding: 0 15px;
            font-size: 14px;
            line-height: 1.3;
          }

          /* Dynamically scale font sizes for more entries */
          #printable-prescription table {
            font-size: 11px;
            line-height: 1.2;
            margin-bottom: 8px;
          }

          #printable-prescription table thead th {
            padding: 4px 6px !important;
            font-size: 9px !important;
          }

          #printable-prescription table tbody td {
            padding: 4px 6px !important;
            font-size: 10px !important;
          }

          /* Reduce padding/margins for tighter layout */
          #printable-prescription .bg-\[#fffbf0\] {
            padding: 6px 8px !important;
            margin-bottom: 6px !important;
          }

          #printable-prescription .grid {
            gap: 8px !important;
            margin-bottom: 6px !important;
          }

          #printable-prescription h3 {
            font-size: 11px !important;
            margin-bottom: 4px !important;
          }

          #printable-prescription .text-sm {
            font-size: 10px !important;
          }

          #printable-prescription .min-h-\[40px\] {
            min-height: 20px !important;
          }

          #printable-prescription .min-h-\[60px\] {
            min-height: 30px !important;
          }

          /* Scale header text */
          #printable-prescription .text-3xl {
            font-size: 24px !important;
          }

          #printable-prescription .text-5xl {
            font-size: 32px !important;
          }

          #printable-prescription .text-xl {
            font-size: 13px !important;
          }

          /* Reduce Rx signature area */
          #printable-prescription .text-4xl {
            font-size: 28px !important;
          }

          /* Remove unnecessary spacing */
          #printable-prescription .pb-4 {
            padding-bottom: 8px !important;
          }

          #printable-prescription .mb-6 {
            margin-bottom: 6px !important;
          }

          #printable-prescription .mb-4 {
            margin-bottom: 4px !important;
          }

          #printable-prescription .mb-2 {
            margin-bottom: 2px !important;
          }

          /* Hide everything else ONLY when prescription is active */
          body:has(#printable-prescription.print-active) > *:not(#printable-prescription) {
            display: none !important;
          }

          /* Ensure visibility */
          #printable-prescription.print-active * {
            visibility: visible !important;
          }
        }

        /* Ensure the container inside prints cleanly */
        #printable-prescription .p-8 {
          padding: 0 !important;
          margin: 20px !important;
          border: none !important;
        }

        /* --- REPORT PRINTING LOGIC (FIXED) --- */

        /* 1. Orientation: Force Landscape so wide tables fit */
        @page {
          size: landscape;
          margin: 10mm 5mm;
        }

        @page :first {
          margin-top: 10mm;
        }

        /* 2. Base: Hide report containers by default */
        #day-report-container,
        #night-report-container {
          display: none;
        }

        /* 3. VISIBILITY: CRITICAL FIX. 
         We must explicitly make the container AND all its children visible 
         to override the global 'body * { visibility: hidden }' rule. */
        body.print-day #day-report-container,
        body.print-day #day-report-container *,
        body.print-night #night-report-container,
        body.print-night #night-report-container *,
        body.print-both #day-report-container *,
        body.print-both #night-report-container * {
          visibility: visible !important;
        }

        /* 4. SCENARIO 1: Print Day Only */
        body.print-day #day-report-container {
          display: block !important;
          position: static !important;
          left: auto !important;
          top: auto !important;
          width: auto !important;
        }

        /* 5. SCENARIO 2: Print Night Only */
        body.print-night #night-report-container {
          display: block !important;
          position: static !important;
          left: auto !important;
          top: auto !important;
          width: auto !important;
        }

        /* 6. SCENARIO 3: Print Both (Stacked Vertically) */
        body.print-both #day-report-container,
        body.print-both #night-report-container {
          display: block !important;
          position: static !important;
          width: auto !important;
          left: auto !important;
          top: auto !important;
        }

        body.print-both #night-report-container {
          margin-top: 20px;
          /* Space between the two tables */
          page-break-before: auto;
        }

        /* Attendance-only print mode */
        .attendance-print-container {
          display: none;
        }

        body.print-attendance > *:not(.attendance-print-container) {
          display: none !important;
        }

        body.print-attendance .attendance-print-container {
          display: block !important;
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          background: white;
          padding: 0 12px;
          visibility: visible !important;
          z-index: 9999;
        }

        body.print-attendance .attendance-print-container * {
          visibility: visible !important;
        }

        /* 7. TABLE STYLING FIXES FOR PRINT */
        /* Expand container to show full width */
        .overflow-x-auto {
          overflow: visible !important;
        }

        /* Day/Night Report Containers: Clean slate for printable */
        #day-report-container,
        #night-report-container {
          background: white !important;
          border: none !important;
          box-shadow: none !important;
          border-radius: 0 !important;
          padding: 0 !important;
          margin: 0 !important;
          page-break-inside: avoid;
          width: 100% !important;
        }

        #day-report-container > div,
        #night-report-container > div {
          background: white !important;
          border-radius: 0 !important;
          box-shadow: none !important;
          border: none !important;
          padding: 0 !important;
          margin: 0 !important;
          overflow: visible !important;
        }

        /* Overflow wrapper must be removed from print */
        #day-report-container .overflow-x-auto,
        #night-report-container .overflow-x-auto {
          overflow: visible !important;
          display: block !important;
          width: 100% !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        /* Report headers: Clean and simple */
        #day-report-container h4,
        #night-report-container h4 {
          display: none;
          /* Hide decorative headers during print */
        }

        /* Reset sticky headers so they print normally as standard table rows */
        #day-report-container thead th,
        #night-report-container thead th {
          position: static !important;
          background-color: #2d5a3d !important;
          color: white !important;
          border: 1px solid #333 !important;
          box-shadow: none !important;
          padding: 8px !important;
          font-size: 11px !important;
          font-weight: bold !important;
          white-space: nowrap;
          text-align: center;
        }

        /* Day/Night table cells */
        #day-report-container tbody td,
        #night-report-container tbody td {
          border: 1px solid #333 !important;
          padding: 6px !important;
          font-size: 10px !important;
          text-align: center;
          background: white !important;
        }

        #day-report-container tbody tr:nth-child(even),
        #night-report-container tbody tr:nth-child(even) {
          background: #f9f9f9 !important;
        }

        /* Reset sticky first column */
        #day-report-container td.sticky,
        #night-report-container td.sticky {
          position: static !important;
          border-right: 1px solid #333 !important;
          box-shadow: none !important;
          text-align: left;
          font-weight: 500;
          background: white !important;
        }

        /* Day and Night Tables */
        #day-report-container table,
        #night-report-container table {
          border-collapse: collapse !important;
          width: 100% !important;
          background: white !important;
          table-layout: auto;
        }
      }

      #printable-area,
      #printable-discharge-slip {
        display: none;
      }

      /* Sidebar Transition */
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }

      body {
        font-family:
          'DM Sans',
          'Inter',
          system-ui,
          -apple-system,
          sans-serif;
        color: var(--text-main);
        background: linear-gradient(180deg, #f7f9fa 0%, #f3f9f5 45%, #f8fcf9 100%);
      }

      .metric-number {
        font-family: 'Manrope', 'Inter', system-ui, sans-serif;
      }

      /* --- DASHBOARD STYLES --- */
      .kpi-card {
        position: relative;
        border-radius: 16px;
        padding: 18px;
        color: #0f172a;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(17, 24, 39, 0.04);
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f7fdf9 100%);
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease;
      }

      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(16, 185, 129, 0.15);
        transition: all 0.25s ease;
      }

      .kpi-card .kpi-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 10px 20px rgba(201, 167, 73, 0.15);
      }

      .kpi-accent-shamrock {
        background: linear-gradient(135deg, #e8c547 0%, #c9a749 100%);
        color: #2c241b;
      }

      .kpi-accent-sky {
        background: linear-gradient(135deg, #e0f2ff 0%, #b7e0ff 100%);
        color: #0f172a;
      }

      .kpi-accent-amber {
        background: linear-gradient(135deg, #fff7e6 0%, #ffe8c2 100%);
        color: #78350f;
      }

      .kpi-accent-forest {
        background: linear-gradient(135deg, #fffbf0 0%, #f0e6c2 100%);
        color: #5c4d1f;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        border: 1px solid var(--border-soft);
        background: rgba(255, 255, 255, 0.7);
        color: var(--text-muted);
      }

      .pill.active {
        border-color: #c9a749;
        background: #fffbf0;
        color: #b8941f;
      }

      .panel-card {
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(17, 24, 39, 0.04);
      }

      /* --- NEW GLOBAL TABLE STYLES --- */

      /* 1. Force Overflow-X Auto on Table Containers */
      .overflow-x-auto {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
      }

      /* Keep native table layout when overflow utility is applied directly */
      table.overflow-x-auto {
        display: table;
        width: 100%;
        overflow: visible !important;
      }

      /* 2. Dual Scrollbar Wrapper - Top and Bottom Scroll */
      .dual-scrollbar-wrapper {
        position: relative;
      }

      .dual-scrollbar-top {
        overflow-x: auto;
        overflow-y: hidden;
        height: 20px;
        margin-bottom: 8px;
      }

      .dual-scrollbar-top-inner {
        height: 1px;
      }

      /* Hide scrollbars on print */
      @media print {
        .dual-scrollbar-top {
          display: none !important;
        }
      }

      /* 2. Zebra Striping (Green Emerald-100 at 20% opacity) */
      /* Target all table body rows, applying color to even rows */
      tbody tr:nth-child(even) {
        background-color: #fffbf0 !important;
        /* light gold/cream */
      }

      /* Optional: Ensure hover effect still looks good over the stripe */
      tbody tr:hover {
        background-color: #f7f1d8 !important;
        /* Darker cream on hover */
      }

      /* --- STRONGER FIX FOR DISCHARGED ROWS --- */
      /* We use the ID #accounts-table-body to make this rule stronger than the generic striping */
      #accounts-table-body tr.discharged-row,
      #accounts-table-body tr.discharged-row:nth-child(even),
      #accounts-table-body tr.discharged-row:hover {
        background-color: #f3f4f6 !important;
        /* Gray-100 */
        color: #9ca3af !important;
        /* Gray-400 */
      }

      /* Also force the specific cells to be gray/dimmed to override Tailwind text colors */
      #accounts-table-body tr.discharged-row td,
      #accounts-table-body tr.discharged-row td div,
      #accounts-table-body tr.discharged-row td span {
        color: #9ca3af !important;
      }

      /* Keep the balance text readable (Red/Green) but slightly dimmed */
      #accounts-table-body tr.discharged-row td.text-red-300 {
        color: #fca5a5 !important;
      }

      #accounts-table-body tr.discharged-row td.text-green-300 {
        color: #86efac !important;
      }

      /* --- FIX FOR PATIENTS DIRECTORY DISCHARGED ROWS --- */
      #patients-table-body tr.discharged-row,
      #patients-table-body tr.discharged-row:nth-child(even),
      #patients-table-body tr.discharged-row:hover {
        background-color: #f3f4f6 !important;
        /* Gray-100 */
        color: #9ca3af !important;
        /* Gray-400 */
      }

      /* Force text in cells to be gray */
      #patients-table-body tr.discharged-row td,
      #patients-table-body tr.discharged-row td div {
        color: #9ca3af !important;
      }

      /* --- FIX FOR CANTEEN TABLE DISCHARGED ROWS --- */
      #canteen-breakdown-body tr.discharged-row,
      #canteen-breakdown-body tr.discharged-row:nth-child(even),
      #canteen-breakdown-body tr.discharged-row:hover {
        background-color: #f3f4f6 !important;
        /* Gray-100 */
        color: #9ca3af !important;
        /* Gray-400 */
      }

      #canteen-breakdown-body tr.discharged-row td {
        color: #9ca3af !important;
      }

      /* --- DAY/NIGHT REPORT TABLE COMPACT STYLES --- */
      #day-report-container table,
      #night-report-container table {
        table-layout: fixed;
        width: 100%;
      }

      #day-report-container th,
      #night-report-container th {
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #day-report-container td,
      #night-report-container td {
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Compact patient name column */
      #day-report-container th:first-child,
      #day-report-container td:first-child,
      #night-report-container th:first-child,
      #night-report-container td:first-child {
        width: 15%;
        min-width: 90px;
        max-width: 140px;
      }

      /* Time slot columns - distribute remaining space evenly */
      #day-report-container th:not(:first-child),
      #day-report-container td:not(:first-child) {
        width: calc(85% / 10);
        /* 10 time slots for day */
      }

      #night-report-container th:not(:first-child),
      #night-report-container td:not(:first-child) {
        width: calc(85% / 16);
        /* 16 time slots for night */
      }

      /* Reduce button size in report cells */
      #day-report-container button,
      #night-report-container button {
        min-width: 0;
        padding: 2px;
      }

      /* Call & Meeting table compact + current-day highlight */
      #call-meeting-table {
        table-layout: fixed;
        width: 100%;
      }

      #call-meeting-table th.call-meeting-name-col,
      #call-meeting-table td.call-meeting-name-col {
        width: 140px;
        min-width: 140px;
        max-width: 200px;
      }

      .call-meeting-day-header,
      .call-meeting-day-cell {
        width: 32px;
        min-width: 28px;
      }

      .call-meeting-day-cell button {
        height: 1.75rem;
        padding: 0;
      }

      .call-meeting-today {
        background: #65edb9 !important;
        color: #ffffff !important;
        font-weight: 700;
        border: none !important;
      }

      .call-meeting-today-button {
        box-shadow: none;
        border: none !important;
        background: transparent !important;
      }

      .call-meeting-day-header.call-meeting-today {
        font-weight: 800;
        border: none !important;
      }

      /* --- MOBILE RESPONSIVE: Day/Night Report Tables --- */
      @media (max-width: 768px) {
        #day-report-container,
        #night-report-container {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch;
          width: 100%;
        }

        #day-report-container > div,
        #night-report-container > div {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch;
        }

        #day-report-container .overflow-x-auto,
        #night-report-container .overflow-x-auto {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch;
        }

        #day-report-container table,
        #night-report-container table {
          min-width: 800px;
          display: table;
          table-layout: auto !important;
        }

        /* Remove text truncation on mobile - allow full display since table scrolls */
        #day-report-container th,
        #night-report-container th,
        #day-report-container td,
        #night-report-container td {
          overflow: visible !important;
          text-overflow: clip !important;
          white-space: nowrap !important;
        }

        /* Reset column width constraints on mobile */
        #day-report-container th:first-child,
        #day-report-container td:first-child,
        #night-report-container th:first-child,
        #night-report-container td:first-child {
          width: auto !important;
          min-width: 120px !important;
          max-width: none !important;
        }

        #day-report-container th:not(:first-child),
        #day-report-container td:not(:first-child),
        #night-report-container th:not(:first-child),
        #night-report-container td:not(:first-child) {
          width: auto !important;
          min-width: 80px !important;
        }

        /* Fix Dashboard KPI Cards on Mobile */
        .kpi-card {
          min-width: 100% !important;
          flex: 1 1 100% !important;
        }

        .kpi-card .flex {
          flex-wrap: wrap;
        }

        .kpi-card .kpi-icon {
          order: -1;
          margin-bottom: 8px;
        }

        /* Ensure month summary content doesn't overflow */
        .kpi-card .flex.items-center.gap-4 {
          flex-wrap: wrap;
          gap: 12px !important;
        }

        /* Fix Attendance Table on Mobile */
        #attendance-view .overflow-x-auto {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch;
        }

        #attendance-view table {
          min-width: 800px;
          display: table;
          table-layout: auto !important;
        }

        #attendance-view th,
        #attendance-view td {
          white-space: nowrap !important;
          padding: 8px 6px !important;
        }

        /* Fix Canteen Table on Mobile */
        #canteen-view .overflow-x-auto,
        #canteen-breakdown-table-container,
        #canteen-breakdown-table-container > div {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch;
          width: 100%;
        }

        /* Ensure the container itself scrolls */
        #canteen-breakdown-table-container {
          display: block !important;
        }

        #canteen-breakdown-body table,
        #canteen-view table,
        #canteen-breakdown-table-container table {
          min-width: 700px;
          display: table;
          table-layout: auto !important;
          width: 100%;
        }

        #canteen-view th,
        #canteen-view td,
        #canteen-breakdown-table-container th,
        #canteen-breakdown-table-container td {
          white-space: nowrap !important;
          padding: 8px 6px !important;
        }
      }
    </style>
    <script>
      let patientsData = [];
      let patientsSearchTerm = '';
      let accountsData = [];
      let receiptPatientOptions = [];
      const dischargedPatientIds = new Set();
      const photoBuffers = {
        new: { photo1: '', photo2: '', photo3: '' },
        detail: { photo1: '', photo2: '', photo3: '' },
      };

      const readFileAsDataURL = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

      function setupPhotoInput(fileInputId, hiddenInputId, imgId, scopeKey, bufferKey) {
        const fileInput = document.getElementById(fileInputId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const img = document.getElementById(imgId);
        if (!fileInput || !hiddenInput || !img) return;

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          try {
            const dataUrl = await readFileAsDataURL(file);
            hiddenInput.value = dataUrl;
            photoBuffers[scopeKey][bufferKey] = dataUrl;
            img.src = dataUrl;
            img.classList.remove('opacity-40');
          } catch (err) {
            console.error('File read error', err);
          }
        });
      }

      let currentPatientId = null;
      let currentUser = { isLoggedIn: false, role: 'Guest', username: '' };
      let totalSalaries = 0;
      let totalBills = 0;
      window.reportTableState = window.reportTableState || {
        day: { showAll: false },
        night: { showAll: false },
      };

      const formatCurrency = (amount) =>
        new Intl.NumberFormat('en-PK', {
          style: 'currency',
          currency: 'PKR',
          minimumFractionDigits: 0,
        }).format(amount);
      const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);

      window.showResetPasswordModal = function (token) {
        const modal = document.getElementById('reset-password-modal');
        const tokenInput = document.getElementById('reset-token-input');
        if (!modal || !tokenInput) return;

        tokenInput.value = token;
        modal.classList.remove('hidden');

        // Ensure the login view is visible behind the modal
        document.querySelectorAll('.view-section').forEach((el) => el.classList.add('hidden'));
        const loginView = document.getElementById('login-view');
        if (loginView) loginView.classList.remove('hidden');

        // Drop the token from the URL once captured
        const url = new URL(window.location.href);
        url.searchParams.delete('reset_token');
        const search = url.searchParams.toString();
        window.history.replaceState(
          {},
          document.title,
          search ? `${url.pathname}?${search}` : url.pathname
        );
      };

      window.closeResetPasswordModal = function () {
        const modal = document.getElementById('reset-password-modal');
        if (modal) modal.classList.add('hidden');
        const tokenInput = document.getElementById('reset-token-input');
        if (tokenInput) tokenInput.value = '';
      };

      window.openForgotPasswordModal = function () {
        const modal = document.getElementById('forgot-password-modal');
        if (modal) modal.classList.remove('hidden');
      };

      window.closeForgotPasswordModal = function () {
        const modal = document.getElementById('forgot-password-modal');
        if (modal) modal.classList.add('hidden');
      };

      // --- AUTH & SETUP ---
      const setLoading = (isLoading) => {
        const overlay = document.getElementById('app-loading-overlay');
        const loginView = document.getElementById('login-view');
        if (overlay) overlay.classList.toggle('hidden', !isLoading);
        // Keep login hidden while we verify session to avoid flashing it briefly
        if (loginView && isLoading) loginView.classList.add('hidden');
      };

      // Dual Scrollbar Initialization - Adds top scrollbar to all horizontally scrollable tables
      function initDualScrollbars() {
        document.querySelectorAll('.overflow-x-auto').forEach((element) => {
          // Skip if already wrapped or if it's inside print media query
          if (element.parentElement?.classList.contains('dual-scrollbar-wrapper')) return;

          // Check if this element actually needs scrolling
          if (element.scrollWidth <= element.clientWidth) return;

          // Create wrapper
          const wrapper = document.createElement('div');
          wrapper.className = 'dual-scrollbar-wrapper';

          // Create top scrollbar container
          const topScroll = document.createElement('div');
          topScroll.className = 'dual-scrollbar-top';

          // Create inner element to force scrollbar
          const topScrollInner = document.createElement('div');
          topScrollInner.className = 'dual-scrollbar-top-inner';
          topScroll.appendChild(topScrollInner);

          // Insert wrapper before the element
          element.parentNode.insertBefore(wrapper, element);

          // Move element into wrapper and add top scroll
          wrapper.appendChild(topScroll);
          wrapper.appendChild(element);

          // Synchronize scrolling
          const syncScroll = (source, target) => {
            target.scrollLeft = source.scrollLeft;
          };

          topScroll.addEventListener('scroll', () => syncScroll(topScroll, element));
          element.addEventListener('scroll', () => syncScroll(element, topScroll));

          // Set initial width for top scrollbar
          const updateTopScrollWidth = () => {
            topScrollInner.style.width = element.scrollWidth + 'px';
            // Update visibility - hide if no scrolling needed
            if (element.scrollWidth <= element.clientWidth) {
              topScroll.style.display = 'none';
            } else {
              topScroll.style.display = 'block';
            }
          };

          updateTopScrollWidth();

          // Update on resize or content change
          const resizeObserver = new ResizeObserver(updateTopScrollWidth);
          resizeObserver.observe(element);
        });
      }

      async function initApp() {
        setLoading(true);
        const url = new URL(window.location.href);
        const tokenFromUrl = url.searchParams.get('reset_token');
        if (tokenFromUrl) {
          window.showResetPasswordModal(tokenFromUrl);
          setLoading(false);
          return;
        }
        if (await checkSession()) {
          updateNavVisibility();
          await fetchPatients();
          window.navigateTo('dashboard-view');
        } else {
          window.navigateTo('login-view');
        }
        setLoading(false);
        // Initialize dual scrollbars after initial render
        setTimeout(initDualScrollbars, 100);
      }

      async function checkSession() {
        try {
          const res = await fetch('/api/auth/session');
          if (res.ok) {
            const data = await res.json();
            if (data.is_logged_in) {
              currentUser = data;
              document.getElementById('logged-in-user').innerText = `${
                data.name || data.username
              } (${data.role})`;
              return true;
            }
          }
        } catch (e) {
          console.error('Session check error:', e);
        }
        currentUser = { isLoggedIn: false, role: 'Guest', username: '' };
        return false;
      }

      function updateNavVisibility() {
        const navMap = {
          'nav-dash': ['Admin', 'General Staff', 'Doctor', 'Psychologist', 'Canteen'],
          'nav-patients': ['Admin'],
          'nav-canteen': ['Admin', 'Canteen'],
          'nav-expenses': ['Admin'],
          'nav-users': ['Admin'],
          'nav-accounts': ['Admin'],
          'nav-overheads-finance': ['Admin'],
          'nav-monthly-overheads': ['Admin'],
          'nav-attendance': ['Admin'],
          'nav-reports': ['Admin', 'General Staff', 'Doctor'],
          'nav-psych-sessions': ['Admin', 'Psychologist'],
          'nav-prescription': ['Admin'],
        };

        for (const [id, roles] of Object.entries(navMap)) {
          const el = document.getElementById(id);
          if (el) el.style.display = roles.includes(currentUser.role) ? 'block' : 'none';
        }

        const newPatientBtn = document.getElementById('add-new-patient-btn');
        if (newPatientBtn)
          newPatientBtn.style.display = currentUser.role === 'Admin' ? 'flex' : 'none';

        const addExpenseBtn = document.getElementById('add-expense-btn');
        if (addExpenseBtn)
          addExpenseBtn.style.display = currentUser.role === 'Admin' ? 'inline-flex' : 'none';

        // Financial Inputs in Details
        const isAdmin = currentUser.role === 'Admin';
        document.querySelectorAll('.financial-input').forEach((el) => {
          el.disabled = !isAdmin;
          if (!isAdmin) el.classList.add('bg-gray-100', 'cursor-not-allowed');
          else el.classList.remove('bg-gray-100', 'cursor-not-allowed');
        });
      }

      function toggleSidebar() {
        const sidebar = document.getElementById('main-sidebar');
        // Toggle between -translate-x-full (hidden) and translate-x-0 (shown) on mobile
        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
        } else {
          sidebar.classList.add('-translate-x-full');
        }
      }

      window.handleLogin = async function (e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          if (res.ok) {
            await initApp();
          } else {
            showSuccessModal('Login failed.', true);
          }
        } catch (e) {
          showSuccessModal('Login error.', true);
        }
      };

      window.handleForgotPassword = async function (e) {
        e.preventDefault();
        const username = document.getElementById('forgot-username').value;
        const email = document.getElementById('forgot-email').value;
        try {
          const res = await fetch('/api/auth/forgot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email }),
          });
          const data = await res.json();
          if (res.ok) {
            showSuccessModal(data.message || 'Reset email sent to your registered address.');
            window.closeForgotPasswordModal();
          } else {
            showSuccessModal(
              data.error || 'Could not start password reset. Check username/email.',
              true
            );
          }
        } catch (err) {
          console.error(err);
          showSuccessModal('Error sending reset request.', true);
        }
      };

      window.handleResetPassword = async function (e) {
        e.preventDefault();
        const token = document.getElementById('reset-token-input').value;
        const newPassword = document.getElementById('reset-new-password').value;
        const confirmPassword = document.getElementById('reset-confirm-password').value;

        if (newPassword !== confirmPassword) {
          showSuccessModal('Passwords do not match.', true);
          return;
        }

        try {
          const res = await fetch('/api/auth/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: newPassword }),
          });
          const data = await res.json();
          if (res.ok) {
            showSuccessModal(data.message || 'Password reset successfully.');
            window.closeResetPasswordModal();
          } else {
            showSuccessModal(data.error || 'Could not reset password.', true);
          }
        } catch (err) {
          console.error(err);
          showSuccessModal('Error resetting password.', true);
        }
      };

      window.handleLogout = async function () {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.reload();
      };

      window.navigateTo = function (viewId) {
        if (viewId === 'accounts-view' && currentUser.role !== 'Admin') {
          showSuccessModal('Access Denied.', true);
          return;
        }
        if (viewId === 'patients-view' && currentUser.role !== 'Admin') {
          showSuccessModal('Access Denied.', true);
          return;
        }
        if (viewId === 'canteen-view' && !['Admin', 'Canteen'].includes(currentUser.role)) {
          showSuccessModal('Access Denied: Canteen view requires Admin or Canteen role.', true);
          return;
        }

        document.querySelectorAll('.view-section').forEach((el) => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');

        document.querySelectorAll('.nav-item').forEach((el) => {
          el.classList.remove(
            'bg-[#c9a749]',
            'text-white',
            'shadow-sm',
            'border',
            'border-[#b8941f]'
          );
          el.classList.add('text-[#5c4d1f]', 'border', 'border-transparent');
        });

        const navIdMap = {
          'dashboard-view': 'nav-dash',
          'patients-view': 'nav-patients',
          'expenses-view': 'nav-expenses',
          'canteen-view': 'nav-canteen',
          'user-management-view': 'nav-users',
          'accounts-view': 'nav-accounts',
          'overheads-view': 'nav-overheads-finance',
          'monthly-overheads-view': 'nav-monthly-overheads',
          'attendance-view': 'nav-attendance',
          'daily-report-view': 'nav-reports',
          'psych-sessions-view': 'nav-psych-sessions',
        };
        const navId = navIdMap[viewId];
        const navEl = document.getElementById(navId);
        if (navEl) {
          navEl.classList.remove('text-[#5c4d1f]', 'border-transparent');
          navEl.classList.add('bg-[#c9a749]', 'text-white', 'shadow-sm', 'border-[#b8941f]');
        }

        // Close sidebar on mobile when navigating
        const sidebar = document.getElementById('main-sidebar');
        if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
          sidebar.classList.add('-translate-x-full');
        }

        if (viewId === 'dashboard-view') {
          updateDashboard();
          loadCallMeetingData();
          updateDateTime();
          if (window.dateTimeInterval) clearInterval(window.dateTimeInterval);
          window.dateTimeInterval = setInterval(updateDateTime, 1000);
        }
        if (viewId === 'expenses-view') loadExpenses();
        if (viewId === 'canteen-view') renderCanteenBreakdown();
        if (viewId === 'user-management-view') renderUserManagement();
        if (viewId === 'accounts-view') renderAccounts();
        if (viewId === 'utility-bills-view') renderUtilityBills();
        if (viewId === 'team-view') renderTeam();
        if (viewId === 'overheads-view') renderOverheads();
        if (viewId === 'monthly-overheads-view') renderMonthlyOverheads();
        if (viewId === 'attendance-view') renderAttendanceView();
        if (viewId === 'daily-report-view') {
          const datePicker = document.getElementById('report-date-picker');
          if (datePicker && !datePicker.value) {
            // Only set date on first load, don't auto-update after that
            const today = new Date();
            const localIso = new Date(today.getTime() - today.getTimezoneOffset() * 60000)
              .toISOString()
              .split('T')[0];
            datePicker.value = localIso;
          }
          loadDailyReport();
        }
        if (viewId === 'psych-sessions-view') {
          initPsychSessionsView();
        }

        // Initialize dual scrollbars after view renders
        setTimeout(initDualScrollbars, 100);
      };

      // --- CALL & MEETING TRACKER ---
      let currentCallMeetingRecords = [];
      let callMeetingMeta = {};

      window.printCallMeetingReport = function () {
        const monthInput = document.getElementById('call-meeting-month');
        const today = new Date();
        const [yearStr, monthStr] = (
          monthInput && monthInput.value
            ? monthInput.value
            : `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`
        ).split('-');
        const month = parseInt(monthStr, 10);
        const year = parseInt(yearStr, 10);

        const filtered = (currentCallMeetingRecords || []).filter((r) => {
          return parseInt(r.month, 10) === month && parseInt(r.year, 10) === year;
        });

        if (!filtered || filtered.length === 0) {
          showSuccessModal('No data to print for the selected month.', true);
          return;
        }

        const printWindow = window.open('', '', 'width=900,height=600');
        const now = new Date();
        const formattedDate = now.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
        const selectedDateLabel = new Date(year, month - 1, 1).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
        });

        let tableHTML = `
          <html>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
            <head>
              <title>Call & Meeting Report</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; color: #333; background: #fff; }
                .header { text-align: center; margin-bottom: 30px; }
                .header h1 { margin: 0 0 5px 0; font-size: 24px; color: #0f3c2d; }
                .header p { margin: 2px 0; color: #666; font-size: 14px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                table th { background: #065f46; color: white; padding: 10px; text-align: left; font-weight: 600; border: 1px solid #0f3c2d; }
                table td { padding: 10px 12px; border: 1px solid #e5e7eb; }
                table tbody tr:nth-child(odd) { background-color: #f7fdf9; }
                .status { display: inline-flex; align-items: center; gap: 6px; font-weight: 700; }
                .tick { color: #047857; }
                .cross { color: #b91c1c; }
                .footer { margin-top: 20px; text-align: center; font-size: 12px; color: #999; }
                @media print { body { margin: 0; padding: 10mm; } }
              </style>
            </head>
            <body>
              <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 15px; border-bottom: 2px solid #10b981; padding-bottom: 15px;">
                <i class="fas fa-clipboard-check" style="font-size: 40px; color: #10b981"></i>
                <div style="text-align: center">
                  <div style="font-size: 22px; font-weight: bold; color: #10b981">Rooh</div>
                  <div style="font-size: 13px; font-weight: bold; color: #059669">ROOH</div>
                  <div style="font-size: 12px; color: #666">Call & Meeting Tracker</div>
                </div>
              </div>
              <div class="header">
                <h1>Day Tracker</h1>
                <p>Showing ${selectedDateLabel}</p>
                <p>Printed on ${formattedDate}</p>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Admission Date</th>
                    <th>Scheduled Date</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody>
        `;

        filtered.forEach((r) => {
          const formattedScheduled = getFormattedDateFromDay(r.day, r.month, r.year);
          const status = (r.status || r.type || 'Meeting').toString();
          const isMeeting = status.toLowerCase() === 'meeting';
          const statusHtml = isMeeting
            ? '<span class="status tick"><i class="fas fa-check"></i>Meeting</span>'
            : '<span class="status cross"><i class="fas fa-times"></i>Call</span>';

          tableHTML += `
            <tr>
              <td><strong>${escapeHtml(r.name || '')}</strong></td>
              <td>${r.date_of_admission || '-'}</td>
              <td>${formattedScheduled}</td>
              <td>${statusHtml}</td>
            </tr>
          `;
        });

        tableHTML += `
                </tbody>
              </table>
              <div class="footer">
                <p>Total Records: ${filtered.length}</p>
              </div>
            </body>
          </html>
        `;

        printWindow.document.write(tableHTML);
        printWindow.document.close();
        printWindow.print();
      };

      async function loadCallMeetingData() {
        try {
          const today = new Date();
          const monthInput = document.getElementById('call-meeting-month');
          if (monthInput && !monthInput.value) {
            monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(
              2,
              '0'
            )}`;
          }

          const [yearStr, monthStr] = (
            monthInput && monthInput.value
              ? monthInput.value
              : `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`
          ).split('-');
          const month = parseInt(monthStr, 10);
          const year = parseInt(yearStr, 10);

          const monthNames = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December',
          ];
          const monthLabel = document.getElementById('call-meeting-month-label');
          if (monthLabel) {
            monthLabel.innerText = `Month view for ${monthNames[month - 1]} ${year}`;
          }

          const todayLabel = document.getElementById('call-meeting-current-date');
          if (todayLabel) {
            const now = new Date();
            todayLabel.innerText = `Today: ${now.toLocaleDateString('en-US', {
              weekday: 'short',
              month: 'short',
              day: 'numeric',
            })}`;
          }

          const res = await fetch(`/api/call_meeting_tracker?month=${month}&year=${year}`);
          if (!res.ok) return;
          const records = await res.json();
          currentCallMeetingRecords = records || [];

          renderCallMeetingTable(records, month, year);
        } catch (e) {
          console.error('Call/Meeting Load Error', e);
        }
      }

      function getFormattedDateFromDay(day, month, year) {
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
        });
      }

      function renderCallMeetingTable(records, month, year) {
        const headerRow = document.getElementById('call_meeting_header_row');
        const tbody = document.getElementById('call_meeting_table_body');
        if (!headerRow || !tbody) return;

        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();
        const todayDay = today.getDate();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() + 1 === month;

        // Build headers
        let headersHtml = `<th class="px-3 py-2 text-left whitespace-nowrap sticky left-0 z-20 shadow-md bg-[#c9a749] text-white call-meeting-name-col">
                            <span class="font-semibold tracking-wide text-sm">Name</span>
                          </th>`;
        for (let day = 1; day <= daysInMonth; day++) {
          const isTodayCol = isCurrentMonth && day === todayDay;
          headersHtml += `<th class="px-1 py-2 text-center whitespace-nowrap text-[11px] font-semibold border-l border-white/20 call-meeting-day-header ${
            isTodayCol ? 'call-meeting-today' : ''
          }">${day}</th>`;
        }
        headerRow.innerHTML = headersHtml;

        // Group records by name
        callMeetingMeta = {};
        const groupedByName = {};
        (records || []).forEach((r) => {
          if (!groupedByName[r.name]) {
            groupedByName[r.name] = {
              name: r.name,
              date_of_admission: r.date_of_admission,
              days: {},
            };
          }
          groupedByName[r.name].days[r.day] = {
            id: r._id,
            status: r.status || r.type || 'Meeting',
          };
        });

        const names = Object.keys(groupedByName);
        if (!names.length) {
          tbody.innerHTML = `<tr><td colspan="${
            daysInMonth + 1
          }" class="p-6 text-center text-gray-400">No entries for this month.</td></tr>`;
          return;
        }

        const rows = names
          .map((name) => {
            const person = groupedByName[name];
            callMeetingMeta[name] = {
              date_of_admission: person.date_of_admission,
              days: person.days,
            };
            let rowHtml = `<td class="px-3 py-2 font-bold text-[#5c4d1f] bg-[#fffbf0] sticky left-0 border-r z-20 whitespace-nowrap text-xs md:text-sm call-meeting-name-col">
                            <span class="block truncate">${escapeHtml(person.name)}</span>
                           </td>`;

            for (let day = 1; day <= daysInMonth; day++) {
              const dayData = person.days[day];
              const hasEntry = !!dayData;
              const isTodayCol = isCurrentMonth && day === todayDay;
              const cellBadge = hasEntry
                ? '<i class="fas fa-check text-[#cca94b] text-xs"></i>'
                : '';
              const cellClass = hasEntry ? 'bg-[#fffbf0] border border-[#d4af37]' : 'bg-gray-50';

              rowHtml += `<td class="p-1 border text-center align-middle call-meeting-day-cell ${
                isTodayCol ? 'call-meeting-today' : ''
              }">
                            <button class="w-full h-7 rounded flex items-center justify-center text-[11px] ${cellClass} ${
                              isTodayCol ? 'call-meeting-today-button' : ''
                            }"
                                    onclick="toggleCallMeeting('${encodeURIComponent(
                                      person.name
                                    )}', ${day})"
                                    title="${hasEntry ? 'Remove entry' : 'Add entry'}">
                              ${cellBadge}
                            </button>
                          </td>`;
            }

            return `<tr class="hover:bg-gray-50 transition">${rowHtml}</tr>`;
          })
          .join('');

        tbody.innerHTML = rows;
      }

      window.openCallMeetingModal = function () {
        const modal = document.getElementById('call_meeting_modal');
        modal.classList.remove('hidden');

        // Reset form
        document.getElementById('call_meeting_form').reset();
        document.getElementById('cm-admission-date').value = '';

        // Set default scheduled date to current month's first day
        const dayInput = document.getElementById('cm-date');
        const monthInput = document.getElementById('call-meeting-month');
        if (dayInput && monthInput && monthInput.value) {
          const [yr, m] = monthInput.value.split('-');
          dayInput.value = `${yr}-${m}-01`;
        }

        // Ensure patients are loaded
        if (patientsData.length === 0) {
          fetchPatients().then(() => {
            setupCallMeetingPatientDropdown();
          });
        } else {
          setupCallMeetingPatientDropdown();
        }
      };

      function setupCallMeetingPatientDropdown() {
        const input = document.getElementById('cm-name');
        const dropdown = document.getElementById('cm-name-dropdown');
        const admissionDateInput = document.getElementById('cm-admission-date');

        // Only active (non-discharged) patients
        const activePatients = patientsData
          .filter((p) => !p.isDischarged)
          .map((p) => ({
            id: p._id || p.id,
            name: p.name,
            admissionDate: p.admissionDate,
          }));

        let selectedPatientId = null;
        let selectedAdmissionDate = '';

        function renderDropdown(filter = '') {
          const filteredPatients = activePatients.filter((p) =>
            p.name.toLowerCase().includes(filter.toLowerCase())
          );

          dropdown.innerHTML = '';

          if (filteredPatients.length === 0) {
            dropdown.innerHTML =
              '<div class="searchable-dropdown-item" style="color: #9ca3af;">No patients found</div>';
          } else {
            filteredPatients.forEach((p) => {
              const item = document.createElement('div');
              item.className = 'searchable-dropdown-item';
              item.textContent = p.name;
              item.dataset.id = p.id;
              item.dataset.name = p.name;
              item.dataset.admissionDate = p.admissionDate || '';

              item.addEventListener('click', () => {
                input.value = p.name;
                selectedPatientId = p.id;
                selectedAdmissionDate = p.admissionDate || '';
                admissionDateInput.value = selectedAdmissionDate;
                dropdown.style.display = 'none';
              });

              dropdown.appendChild(item);
            });
          }
        }

        input.addEventListener('focus', () => {
          renderDropdown(input.value);
          dropdown.style.display = 'block';
        });

        input.addEventListener('input', (e) => {
          renderDropdown(e.target.value);
          dropdown.style.display = 'block';
          selectedPatientId = null;
          selectedAdmissionDate = '';
          admissionDateInput.value = '';
        });

        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        input.dataset.getSelectedId = () => selectedPatientId;
        input.dataset.getSelectedAdmissionDate = () => selectedAdmissionDate;
      }

      window.saveCallMeetingEntry = async function (e) {
        e.preventDefault();

        const nameInput = document.getElementById('cm-name');
        const name = nameInput.value;
        const admissionDate = document.getElementById('cm-admission-date').value;
        const scheduledDate = document.getElementById('cm-date').value;
        const status = document.getElementById('cm-status').value;

        // Validate that a patient was selected from the dropdown
        if (!admissionDate) {
          showSuccessModal('Please select a patient from the list.', true);
          return;
        }

        if (!scheduledDate) {
          showSuccessModal('Please select a date for this entry.', true);
          return;
        }

        const parsedDate = new Date(`${scheduledDate}T00:00:00`);
        const day = parsedDate.getDate();
        const month = parsedDate.getMonth() + 1;
        const year = parsedDate.getFullYear();

        const res = await fetch('/api/call_meeting_tracker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            date_of_admission: admissionDate,
            day: parseInt(day),
            month,
            year,
            type: status,
            status,
          }),
        });

        if (res.ok) {
          document.getElementById('call_meeting_modal').classList.add('hidden');
          showSuccessModal('Entry saved successfully!');
          await loadCallMeetingData();
        } else {
          showSuccessModal('Error saving entry. Please try again.', true);
        }
      };

      window.toggleCallMeeting = async function (encodedName, day) {
        const name = decodeURIComponent(encodedName);
        const monthInput = document.getElementById('call-meeting-month');
        const today = new Date();
        const [yearStr, monthStr] = (
          monthInput && monthInput.value
            ? monthInput.value
            : `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`
        ).split('-');
        const month = parseInt(monthStr, 10);
        const year = parseInt(yearStr, 10);

        const meta = callMeetingMeta[name] || { days: {} };
        const existing = meta.days[day];
        const admissionDate = meta.date_of_admission || '';

        try {
          if (existing && existing.id) {
            const delRes = await fetch(`/api/call_meeting_tracker/${existing.id}`, {
              method: 'DELETE',
            });
            if (!delRes.ok) throw new Error('Delete failed');
          } else {
            const addRes = await fetch('/api/call_meeting_tracker', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name,
                date_of_admission: admissionDate,
                day,
                month,
                year,
                type: 'Meeting',
                status: 'Meeting',
              }),
            });
            if (!addRes.ok) throw new Error('Save failed');
          }
          await loadCallMeetingData();
        } catch (err) {
          console.error('Toggle call/meeting failed', err);
          showSuccessModal('Could not update entry. Please try again.', true);
        }
      };

      // --- DASHBOARD ---
      function updateDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
        const timeStr = now.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true,
        });
        const dateEl = document.getElementById('current-date');
        const timeEl = document.getElementById('current-time');
        if (dateEl) dateEl.innerText = dateStr;
        if (timeEl) timeEl.innerText = timeStr;
      }

      async function updateDashboard() {
        try {
          // Show admin-only cards only for admin users
          const isAdmin = currentUser.role === 'Admin';
          const incomeCard = document.getElementById('dash-income-card');
          const canteenCard = document.getElementById('dash-canteen-card');
          const callMeetingSection = document.getElementById('dash-call-meeting-section');

          if (incomeCard) incomeCard.style.display = isAdmin ? '' : 'none';
          if (canteenCard) canteenCard.style.display = isAdmin ? '' : 'none';
          if (callMeetingSection) callMeetingSection.style.display = isAdmin ? '' : 'none';

          const res = await fetch('/api/dashboard');
          if (!res.ok) return;
          const metrics = await res.json();

          // Get current month name
          const today = new Date();
          const monthName = today.toLocaleDateString('en-US', { month: 'long' });

          document.getElementById('dash-total').innerText = formatNumber(metrics.totalPatients);
          document.getElementById('dash-admitted').innerText = formatNumber(
            metrics.admissionsThisMonth || 0
          );
          document.getElementById('dash-discharged').innerText = formatNumber(
            metrics.dischargesThisMonth || 0
          );

          // Update month labels
          document.getElementById('dash-month-label').innerText = monthName;
        } catch (e) {
          console.error('Dashboard Error', e);
        }

        // --- NEW: Load Daily Report ---
        const datePicker = document.getElementById('report-date-picker');
        if (datePicker && !datePicker.value) {
          // Set default to today only on very first load
          const today = new Date();
          const localIso = new Date(today.getTime() - today.getTimezoneOffset() * 60000)
            .toISOString()
            .split('T')[0];
          datePicker.value = localIso;
        }
        // Load report with current date picker value (doesn't auto-update to today)
        await loadDailyReport();
      }

      function formatDisplayDate(value) {
        if (!value) return '-';
        const d = new Date(value);
        if (isNaN(d.getTime())) return value;
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      window.openAdmissionsModal = async function () {
        try {
          const res = await fetch('/api/dashboard/admissions');
          if (!res.ok) throw new Error('Failed to load admissions');
          const admissions = await res.json();

          const container = document.getElementById('admissions-month-body');
          container.innerHTML = '';

          if (!admissions || admissions.length === 0) {
            container.innerHTML =
              '<div class="text-gray-500 text-center py-4">No admissions this month.</div>';
          } else {
            admissions.forEach((item) => {
              const row = document.createElement('div');
              row.className =
                'flex justify-between items-center py-2 border-b border-emerald-50 last:border-none';
              const date = formatDisplayDate(item.admissionDate || item.created_at);
              row.innerHTML = `
                <div class="font-semibold text-gray-800">${item.name || '-'}</div>
                <div class="text-sm text-gray-600">${date}</div>
              `;
              container.appendChild(row);
            });
          }

          document.getElementById('admissions-modal').classList.remove('hidden');
        } catch (err) {
          console.error(err);
          showSuccessModal('Unable to load admissions list.', true);
        }
      };

      window.closeAdmissionsModal = function () {
        document.getElementById('admissions-modal').classList.add('hidden');
      };

      // --- EXPENSES ---
      window.openExpenseModal = function () {
        const form = document.getElementById('expense-form');
        if (form) form.reset();
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('exp-date');
        if (dateInput) dateInput.value = today;
        document.getElementById('expense-modal').classList.remove('hidden');
      };

      window.saveExpense = async function (e) {
        e.preventDefault();
        const payload = {
          type: document.getElementById('exp-type').value,
          amount: document.getElementById('exp-amount').value,
          category: document.getElementById('exp-category').value,
          date: document.getElementById('exp-date').value,
          note: document.getElementById('exp-note').value,
        };

        const res = await fetch('/api/expenses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (res.ok) {
          document.getElementById('expense-modal').classList.add('hidden');
          showSuccessModal('Expense saved successfully');
          await loadExpenses();
        } else {
          showSuccessModal('Error saving expense. Please try again.', true);
        }
      };

      window.deleteExpense = async function (id) {
        if (id.startsWith('auto-')) {
          showSuccessModal('Automated entries cannot be deleted.');
          return;
        }
        const confirmed = await showConfirmModal('Delete this expense?');
        if (!confirmed) return;
        const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showSuccessModal('Expense deleted');
          await loadExpenses();
        } else {
          showSuccessModal('Error deleting expense.', true);
        }
      };

      async function loadExpenses() {
        try {
          const [listRes, summaryRes] = await Promise.all([
            fetch('/api/expenses'),
            fetch('/api/expenses/summary'),
          ]);

          if (summaryRes.ok) {
            const summary = await summaryRes.json();
            document.getElementById('expense-incoming').innerText = formatCurrency(
              summary.incoming || 0
            );
            document.getElementById('expense-outgoing').innerText = formatCurrency(
              summary.outgoing || 0
            );
            document.getElementById('expense-net').innerText = formatCurrency(summary.net || 0);
          }

          if (listRes.ok) {
            const expenses = await listRes.json();
            renderExpensesTable(expenses);
          }
        } catch (err) {
          console.error('Expenses load error', err);
        }
      }

      function renderExpensesTable(list) {
        const tbody = document.getElementById('expenses-table-body');
        tbody.innerHTML = '';

        if (!list || list.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="p-6 text-center text-gray-400">No expenses recorded.</td></tr>';
          return;
        }

        list.forEach((item) => {
          const tr = document.createElement('tr');
          const typeBadge =
            item.type === 'incoming'
              ? '<span class="px-3 py-1 text-xs rounded-full font-semibold bg-emerald-100 text-[#5c4d1f]">Incoming</span>'
              : '<span class="px-3 py-1 text-xs rounded-full font-semibold bg-red-100 text-red-700">Outgoing</span>';
          const autoBadge = item.auto
            ? '<span class="ml-2 px-2 py-0.5 text-[11px] rounded-full bg-gray-100 text-gray-600 border border-gray-200">Auto</span>'
            : '';
          const deleteCell = item.auto
            ? '<span class="text-xs text-gray-400"></span>'
            : `<button onclick="deleteExpense('${item.id}')" class="text-[#c9a749] hover:text-[#5c4d1f] text-sm px-3 py-1 rounded hover:bg-emerald-100 transition">
                <i class="fas fa-trash"></i>
              </button>`;
          tr.className = 'hover:bg-[#fffbf0] transition';
          tr.innerHTML = `
            <td class="px-6 py-4 text-gray-800 whitespace-nowrap">${formatDisplayDate(
              item.date
            )}</td>
            <td class="px-6 py-4 text-gray-700 whitespace-nowrap">${
              item.category || '-'
            }${autoBadge}</td>
            <td class="px-6 py-4">${typeBadge}</td>
            <td class="px-6 py-4 text-right font-semibold text-gray-800">${formatCurrency(
              item.amount || 0
            )}</td>
            <td class="px-6 py-4 text-gray-600">${item.note || '-'}</td>
            <td class="px-6 py-4 text-center">${deleteCell}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // --- PATIENTS ---
      async function fetchPatients() {
        try {
          const res = await fetch('/api/patients');
          if (res.ok) {
            patientsData = await res.json();

            // Sync discharged set from server state
            dischargedPatientIds.clear();
            patientsData.forEach((p) => {
              const pid = p._id || p.id;
              if (p.isDischarged && pid) dischargedPatientIds.add(pid);
            });

            renderPatientsTable(patientsData);

            // Update table headers based on user role (done in renderPatientsTable)
          }
        } catch (e) {
          console.error(e);
        }
      }

      window.handlePatientsSearch = function (value = '') {
        patientsSearchTerm = value;
        renderPatientsTable(patientsData);
      };

      function renderPatientsTable(list) {
        const tbody = document.getElementById('patients-table-body');
        tbody.innerHTML = '';
        const normalizedSearch = patientsSearchTerm.trim().toLowerCase();
        const filteredList = normalizedSearch
          ? list.filter((patient) => (patient.name || '').toLowerCase().includes(normalizedSearch))
          : list;

        // Update table headers visibility based on user role
        const isAdmin = currentUser.role === 'Admin';
        const adminColumns = document.querySelectorAll('.admin-only-column');
        adminColumns.forEach((col) => {
          col.style.display = isAdmin ? '' : 'none';
        });

        if (filteredList.length === 0) {
          const emptyMessage = normalizedSearch
            ? 'No patients match your search.'
            : 'No records found.';
          const colspanCount = isAdmin ? 13 : 10;
          tbody.innerHTML = `
            <tr>
              <td colspan="${colspanCount}" class="p-6 text-center text-gray-400">${emptyMessage}</td>
            </tr>`;
          return;
        }

        const activePatients = [];
        const dischargedPatients = [];

        filteredList.forEach((p) => {
          const pid = p._id || p.id;
          const isDischarged = dischargedPatientIds.has(pid) || p.isDischarged;
          if (isDischarged) {
            if (pid) dischargedPatientIds.add(pid);
            dischargedPatients.push({ p: { ...p, isDischarged: true }, pid });
          } else {
            activePatients.push({ p, pid });
          }
        });

        const orderedPatients = [...activePatients, ...dischargedPatients];

        orderedPatients.forEach(({ p, pid }, index) => {
          const id = pid;
          const isDischarged = dischargedPatientIds.has(id) || p.isDischarged;
          const tr = document.createElement('tr');

          // --- NEW CLASS LOGIC ---
          // If discharged, add 'discharged-row'. If active, add standard hover classes.
          tr.className = isDischarged
            ? 'discharged-row border-b cursor-pointer transition'
            : 'hover:bg-gray-50 border-b cursor-pointer transition';

          tr.onclick = (e) => {
            if (e.target.closest('.action-btn')) return;
            showPatientDetail(id);
          };

          const isAdmin = currentUser.role === 'Admin';

          // Calculate days elapsed
          const admissionDate = p.admissionDate ? new Date(p.admissionDate) : new Date();
          const today = new Date();
          const daysDiff = Math.floor((today - admissionDate) / (1000 * 60 * 60 * 24));
          const daysElapsed = daysDiff >= 0 ? daysDiff : 0;

          // Calculate prorated fee based on days elapsed (always per-day from day 1)
          const monthlyFeeRaw = parseInt(String(p.monthlyFee || '0').replace(/,/g, ''), 10) || 0;
          const perDayRate = monthlyFeeRaw / 30.0;
          const feeValue = Math.floor(perDayRate * daysElapsed);

          const fee = formatCurrency(feeValue);
          const receivedValue =
            parseInt(String(p.receivedAmount || '0').replace(/,/g, ''), 10) || 0;
          const receivedAmount = formatCurrency(receivedValue);

          // Get canteen total (all-time spending including 'other' adjustments)
          const canteenSpentValue = p.canteenSpent || 0;

          // Get laundry charges if applicable
          const laundryValue = p.laundryStatus
            ? parseInt(String(p.laundryAmount || '0').replace(/,/g, ''), 10) || 0
            : 0;

          // Calculate Total Bill = Fee + Canteen + Laundry
          const totalBill = feeValue + canteenSpentValue + laundryValue;

          // Calculate Balance Due = Total Bill - Received
          const pendingValue = totalBill - receivedValue;

          // Debug logging for patient "ali"
          if (p.name && p.name.toLowerCase().includes('ali')) {
            console.log('=== Patient ali Debug ===');
            console.log('Patient ID:', id);
            console.log('Name:', p.name);
            console.log('Monthly Fee Raw:', monthlyFeeRaw);
            console.log('Days Elapsed:', daysElapsed);
            console.log('Fee Value (calculated):', feeValue);
            console.log('Canteen Spent Value:', canteenSpentValue);
            console.log('Laundry Status:', p.laundryStatus);
            console.log('Laundry Amount (raw):', p.laundryAmount);
            console.log('Laundry Value (calculated):', laundryValue);
            console.log('Received Value:', receivedValue);
            console.log('Total Bill:', totalBill);
            console.log('Pending Value:', pendingValue);
            console.log('Debug URL: /api/debug/canteen/' + id);
            console.log('========================');
          }
          const pendingAmount = formatCurrency(pendingValue);
          const areaDisplay = p.area || p.address || '-';
          const drugDisplay = p.drug || '-';

          let actionControls = '';
          if (currentUser.role === 'Admin') {
            if (isDischarged) {
              actionControls = `<div class="flex flex-col items-end gap-1">
                  <span class="text-xs font-bold uppercase border border-gray-300 px-2 py-1 rounded bg-white/50">Discharged</span>
                  <button class="action-btn bg-white text-emerald-700 border border-[#c9a749] px-3 py-1 rounded text-xs shadow-sm hover:bg-[#fffbf0] transition font-semibold" onclick="event.stopPropagation(); revertDischargeFromTable('${id}');">
                    <i class="fas fa-undo mr-1"></i>Restore
                  </button>
                </div>`;
            } else {
              actionControls = `<button class="action-btn bg-gray-800 hover:bg-gray-900 text-white px-3 py-1 rounded text-xs shadow transition font-semibold" onclick="event.stopPropagation(); handleDischargeFromTable('${id}');"><i class="fas fa-print mr-1"></i>Discharge</button>`;
            }
          } else if (isDischarged) {
            actionControls =
              '<span class="text-xs font-bold uppercase border border-gray-300 px-2 py-1 rounded">Discharged</span>';
          }

          // Generate serial number (use admissionDate already calculated above)
          const monthNames = [
            'Jan',
            'Feb',
            'Mar',
            'Apr',
            'May',
            'Jun',
            'Jul',
            'Aug',
            'Sep',
            'Oct',
            'Nov',
            'Dec',
          ];
          const serialNo = `${
            monthNames[admissionDate.getMonth()]
          }${admissionDate.getFullYear()}-${String(index + 1).padStart(3, '0')}`;

          // Format admission date
          const formattedAdmissionDate = `${
            monthNames[admissionDate.getMonth()]
          } ${admissionDate.getDate()} ${admissionDate.getFullYear()}`;

          // Format days progress as "X/90" and months as "X months"
          const targetDays = 90;
          const daysProgress = `${daysElapsed}/${targetDays}`;

          const totalMonths = Math.floor(daysElapsed / 30);
          const monthsProgress = totalMonths === 1 ? '1 month' : `${totalMonths} months`;

          if (isAdmin) {
            tr.innerHTML = `<td class="px-2 py-2 font-medium text-gray-700 whitespace-nowrap text-xs">${serialNo}</td>
                            <td class="px-2 py-2 font-medium whitespace-nowrap">${
                              p.name || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${
                              p.fatherName || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap text-xs">${formattedAdmissionDate}</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${
                              p.contactNo || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${areaDisplay}</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${drugDisplay}</td>
                            <td class="px-2 py-2 font-semibold text-[#5c4d1f] whitespace-nowrap">${fee}</td>
                            <td class="px-2 py-2 text-center text-gray-700 font-medium whitespace-nowrap text-xs">${daysProgress}</td>
                            <td class="px-2 py-2 text-center text-gray-700 font-medium whitespace-nowrap text-xs">${monthsProgress}</td>
                            <td class="px-2 py-2 font-semibold text-blue-700 whitespace-nowrap">${receivedAmount}</td>
                            <td class="px-2 py-2 font-semibold ${
                              pendingValue > 0 ? 'text-red-600' : 'text-[#5c4d1f]'
                            } whitespace-nowrap">${pendingAmount}</td>
                            <td class="px-2 py-2 text-right">${actionControls}</td>`;
          } else {
            tr.innerHTML = `<td class="px-2 py-2 font-medium text-gray-700 whitespace-nowrap text-xs">${serialNo}</td>
                            <td class="px-2 py-2 font-medium whitespace-nowrap">${
                              p.name || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${
                              p.fatherName || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap text-xs">${formattedAdmissionDate}</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${
                              p.contactNo || '-'
                            }</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${areaDisplay}</td>
                            <td class="px-2 py-2 text-gray-600 whitespace-nowrap">${drugDisplay}</td>
                            <td class="px-2 py-2 text-center text-gray-700 font-medium whitespace-nowrap text-xs">${daysProgress}</td>
                            <td class="px-2 py-2 text-center text-gray-700 font-medium whitespace-nowrap text-xs">${monthsProgress}</td>
                            <td class="px-2 py-2 text-right">${actionControls}</td>`;
          }
          tbody.appendChild(tr);
        });
      }

      window.handleDischargeFromTable = async function (id) {
        try {
          // Persist discharge status
          const payload = {
            isDischarged: true,
            dischargeDate: new Date().toISOString(),
          };

          const res = await fetch(`/api/patients/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            showSuccessModal(
              errData.error || 'Failed to discharge patient. Please try again.',
              true
            );
            return;
          }

          dischargedPatientIds.add(id);

          // Update local cache for immediate UI feedback
          patientsData = patientsData.map((p) => {
            if ((p._id || p.id) === id) {
              return { ...p, isDischarged: true, dischargeDate: payload.dischargeDate };
            }
            return p;
          });

          printDischargeSlip(id);
          renderPatientsTable(patientsData);
          showSuccessModal('Patient discharged and saved.');
        } catch (err) {
          console.error('Discharge error:', err);
          showSuccessModal('Network error while discharging.', true);
        }
      };

      window.revertDischargeFromTable = async function (id) {
        try {
          const payload = {
            isDischarged: false,
            dischargeDate: null,
          };

          const res = await fetch(`/api/patients/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            showSuccessModal(errData.error || 'Failed to restore patient. Please try again.', true);
            return;
          }

          dischargedPatientIds.delete(id);

          patientsData = patientsData.map((p) => {
            if ((p._id || p.id) === id) {
              return { ...p, isDischarged: false, dischargeDate: null };
            }
            return p;
          });

          renderPatientsTable(patientsData);
          showSuccessModal('Patient restored to active list.');
        } catch (err) {
          console.error('Revert discharge error:', err);
          showSuccessModal('Network error while restoring patient.', true);
        }
      };

      window.addNewPatient = async function (e) {
        e.preventDefault();
        const formData = {
          name: document.getElementById('new-patient-name').value,
          fatherName: document.getElementById('new-patient-father').value,
          admissionDate: document.getElementById('new-patient-admission').value,
          age: document.getElementById('new-patient-age').value,
          cnic: document.getElementById('new-patient-cnic').value,
          contactNo: document.getElementById('new-patient-contact').value,
          guardianName: document.getElementById('new-patient-guardian').value,
          address: document.getElementById('new-patient-address').value,
          area: document.getElementById('new-patient-area').value || '',
          monthlyFee: document.getElementById('new-patient-fee').value || '0',
          receivedAmount: document.getElementById('new-patient-received').value || '0',
          drug: document.getElementById('new-patient-drug').value || '',
          photo1: document.getElementById('new-patient-photo1-hidden').value || '',
          photo2: document.getElementById('new-patient-photo2-hidden').value || '',
          photo3: document.getElementById('new-patient-photo3-hidden').value || '',
          laundryStatus: document.getElementById('new-patient-laundry-status').checked,
          laundryAmount: document.getElementById('new-patient-laundry-amount').value || '3500',
        };

        const res = await fetch('/api/patients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        if (res.ok) {
          document.getElementById('new-admission-modal').classList.add('hidden');
          document.getElementById('new-admission-form').reset();
          document.getElementById('laundry-amount-container').classList.add('hidden');
          await fetchPatients();
          showSuccessModal('Patient admitted successfully!');
        } else {
          showSuccessModal('Error adding patient. Please try again.', true);
        }
      };

      window.openNewAdmissionModal = function () {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('new-patient-admission').value = today;
        document.getElementById('new-admission-modal').classList.remove('hidden');

        // Add event listener for laundry checkbox
        const laundryCheckbox = document.getElementById('new-patient-laundry-status');
        laundryCheckbox.addEventListener('change', function () {
          const container = document.getElementById('laundry-amount-container');
          if (this.checked) {
            container.classList.remove('hidden');
          } else {
            container.classList.add('hidden');
          }
        });
      };

      window.showSuccessModal = function (message, isError = false) {
        const modal = document.getElementById('success-modal');
        const messageEl = document.getElementById('success-message');
        const iconEl = document.getElementById('success-icon');

        messageEl.textContent = message;

        if (isError) {
          iconEl.innerHTML = '<i class="fas fa-exclamation-circle text-6xl text-red-500"></i>';
        } else {
          iconEl.innerHTML = '<i class="fas fa-check-circle text-6xl text-green-500"></i>';
        }

        modal.classList.remove('hidden');

        // Auto-close after 3 seconds
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 3000);
      };

      window.showConfirmModal = function (message) {
        return new Promise((resolve) => {
          const modal = document.getElementById('confirm-modal');
          const messageEl = document.getElementById('confirm-message');

          messageEl.textContent = message;
          modal.classList.remove('hidden');

          window.confirmCallback = function (result) {
            modal.classList.add('hidden');
            resolve(result);
          };
        });
      };

      window.deletePatient = async function (id) {
        if (currentUser.role !== 'Admin') {
          showSuccessModal('Only administrators can delete patient records.', true);
          return;
        }

        // Use the generic showConfirmModal instead of the custom one
        const confirmed = await showConfirmModal('Permanently delete this patient record?');

        if (confirmed) {
          try {
            const res = await fetch(`/api/patients/${id}`, { method: 'DELETE' });
            if (res.ok) {
              await fetchPatients();
              showSuccessModal('Patient record deleted successfully.');
            } else {
              const errorData = await res.json().catch(() => ({}));
              showSuccessModal(errorData.error || 'Failed to delete patient.', true);
            }
          } catch (error) {
            console.error('Delete error:', error);
            showSuccessModal('Network error.', true);
          }
        }
      };
      window.confirmDeletePatient = async function () {
        const id = window.pendingDeletePatientId;
        document.getElementById('confirm-modal').classList.add('hidden');

        if (!id) return;

        try {
          const res = await fetch(`/api/patients/${id}`, { method: 'DELETE' });
          if (res.ok) {
            await fetchPatients();
            showSuccessModal('Patient record deleted successfully.');
          } else {
            const errorData = await res.json().catch(() => ({}));
            showSuccessModal(
              errorData.error || 'Failed to delete patient. Please try again.',
              true
            );
          }
        } catch (error) {
          console.error('Delete error:', error);
          showSuccessModal('Network error. Please check your connection and try again.', true);
        }

        window.pendingDeletePatientId = null;
      };

      // --- PATIENT DETAILS & CALENDAR ---
      window.showPatientDetail = function (id) {
        // Restrict access for General Staff and Canteen
        if (currentUser.role === 'General Staff' || currentUser.role === 'Canteen') {
          showSuccessModal('You do not have permission to view patient details.', true);
          return;
        }

        currentPatientId = id;
        const p = patientsData.find((x) => (x._id || x.id) === id);
        if (!p) return;

        const isAdmin = currentUser.role === 'Admin';
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = val || '';
        };
        setVal('det-name', p.name);
        setVal('det-father', p.fatherName);
        setVal('det-admission', p.admissionDate);
        setVal('det-id', p.idNo);
        setVal('det-age', p.age);
        setVal('det-cnic', p.cnic);
        setVal('det-contact', p.contactNo);
        setVal('det-guardian', p.guardianName);
        setVal('det-relation', p.relation);
        setVal('det-address', p.address);
        setVal('det-area', p.area);
        setVal('det-complaint', p.complaint);
        setVal('det-drug', p.drug);
        setVal('det-prev', p.prevAdmissions);
        setVal('det-fee', p.monthlyFee);
        setVal('det-received', p.receivedAmount);
        setVal('det-photo1', p.photo1);
        setVal('det-photo2', p.photo2);
        setVal('det-photo3', p.photo3);
        setVal('det-photo1-hidden', p.photo1);
        setVal('det-photo2-hidden', p.photo2);
        setVal('det-photo3-hidden', p.photo3);

        // Update photo previews
        const setImg = (imgId, url) => {
          const img = document.getElementById(imgId);
          if (!img) return;
          if (url) {
            img.src = url;
            img.classList.remove('opacity-40');
            img.alt = 'Patient photo';
          } else {
            img.src = 'https://via.placeholder.com/300x200?text=No+Photo';
            img.classList.add('opacity-40');
            img.alt = 'No photo available';
          }
        };
        setImg('det-photo1-img', p.photo1);
        setImg('det-photo2-img', p.photo2);
        setImg('det-photo3-img', p.photo3);
        photoBuffers.detail.photo1 = p.photo1 || '';
        photoBuffers.detail.photo2 = p.photo2 || '';
        photoBuffers.detail.photo3 = p.photo3 || '';

        // Set laundry fields
        const laundryCheckbox = document.getElementById('det-laundry-status');
        const laundryLabel = document.getElementById('det-laundry-label');
        if (laundryCheckbox) {
          laundryCheckbox.checked = p.laundryStatus || false;
          if (laundryLabel) {
            laundryLabel.textContent = laundryCheckbox.checked
              ? 'Laundry Service Enabled'
              : 'Enable Laundry Service';
          }
          // Add event listener to update label on toggle
          laundryCheckbox.addEventListener('change', function () {
            if (laundryLabel) {
              laundryLabel.textContent = this.checked
                ? 'Laundry Service Enabled'
                : 'Enable Laundry Service';
            }
          });
        }
        setVal('det-laundry-amount', p.laundryAmount || '0');

        // Apply role-based field restrictions
        const sensitiveFields = [
          'det-cnic',
          'det-contact',
          'det-guardian',
          'det-relation',
          'det-address',
        ];
        const financialFields = document.querySelectorAll('.financial-input');
        const financialSection = document.querySelector('.bg-gray-50.p-4');

        sensitiveFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) {
            if (isAdmin) {
              field.disabled = false;
              field.style.display = '';
            } else {
              field.disabled = true;
              field.style.opacity = '0.6';
            }
          }
        });

        financialFields.forEach((field) => {
          if (isAdmin) {
            field.disabled = false;
            field.style.display = '';
          } else {
            field.disabled = true;
            field.style.opacity = '0.6';
          }
        });

        if (financialSection) {
          financialSection.style.display = isAdmin ? '' : 'none';
        }

        updateCallCalendar(p.admissionDate);
        fetchPatientRecords(id);
        populatePrintTemplate(p);
        navigateTo('patient-detail-view');
        showTab('notes');
      };

      function updateCallCalendar(admissionDateStr) {
        const panel = document.getElementById('call-info-panel');
        if (!admissionDateStr) {
          panel.classList.add('hidden');
          return;
        }
        panel.classList.remove('hidden');

        const admissionDate = new Date(admissionDateStr);
        const dayOfWeekIndex = admissionDate.getDay();
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const callDayName = days[dayOfWeekIndex];

        document.getElementById('next-call-display').innerHTML = `
            <div>
                <div class="text-xs text-gray-500 uppercase tracking-wide">Weekly Call Day</div>
                <div class="text-2xl font-bold text-[#5c4d1f]">${callDayName}</div>
            </div>`;

        const calendarEl = document.getElementById('mini-calendar');
        calendarEl.innerHTML = '';
        ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(
          (d) => (calendarEl.innerHTML += `<div class="calendar-day-header">${d}</div>`)
        );

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        for (let i = 0; i < firstDay.getDay(); i++) calendarEl.innerHTML += `<div></div>`;

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const curr = new Date(year, month, d);
          const isToday = d === today.getDate();
          const isCallDay = curr.getDay() === dayOfWeekIndex;
          let cls = 'calendar-day';
          if (isToday) cls += ' today';
          if (isCallDay) cls += ' call-day';
          calendarEl.innerHTML += `<div class="${cls}">${d}</div>`;
        }
      }

      window.savePatientDetails = async function (e) {
        e.preventDefault();
        const data = {
          name: document.getElementById('det-name').value,
          fatherName: document.getElementById('det-father').value,
          admissionDate: document.getElementById('det-admission').value,
          idNo: document.getElementById('det-id').value,
          age: document.getElementById('det-age').value,
          cnic: document.getElementById('det-cnic').value,
          contactNo: document.getElementById('det-contact').value,
          guardianName: document.getElementById('det-guardian').value,
          address: document.getElementById('det-address').value,
          area: document.getElementById('det-area').value,
          complaint: document.getElementById('det-complaint').value,
          photo1: document.getElementById('det-photo1-hidden').value,
          photo2: document.getElementById('det-photo2-hidden').value,
          photo3: document.getElementById('det-photo3-hidden').value,
        };
        if (currentUser.role === 'Admin') {
          data.monthlyFee = document.getElementById('det-fee').value;
          data.receivedAmount = document.getElementById('det-received').value || '0';
          data.drug = document.getElementById('det-drug').value || '';

          // Include laundry data
          const laundryCheckbox = document.getElementById('det-laundry-status');
          data.laundryStatus = laundryCheckbox ? laundryCheckbox.checked : false;
          data.laundryAmount = document.getElementById('det-laundry-amount').value || '0';
        }
        await fetch(`/api/patients/${currentPatientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        showSuccessModal('Details Saved');
        fetchPatients();
      };

      function initPhotoUploadHandlers() {
        setupPhotoInput(
          'new-patient-photo1-file',
          'new-patient-photo1-hidden',
          'new-patient-photo1-preview',
          'new',
          'photo1'
        );
        setupPhotoInput(
          'new-patient-photo2-file',
          'new-patient-photo2-hidden',
          'new-patient-photo2-preview',
          'new',
          'photo2'
        );
        setupPhotoInput(
          'new-patient-photo3-file',
          'new-patient-photo3-hidden',
          'new-patient-photo3-preview',
          'new',
          'photo3'
        );

        setupPhotoInput(
          'det-photo1-file',
          'det-photo1-hidden',
          'det-photo1-img',
          'detail',
          'photo1'
        );
        setupPhotoInput(
          'det-photo2-file',
          'det-photo2-hidden',
          'det-photo2-img',
          'detail',
          'photo2'
        );
        setupPhotoInput(
          'det-photo3-file',
          'det-photo3-hidden',
          'det-photo3-img',
          'detail',
          'photo3'
        );
      }

      window.addEventListener('load', initPhotoUploadHandlers);

      // --- ACCOUNTS (ADMIN) ---
      async function renderAccounts() {
        if (currentUser.role !== 'Admin') return;
        try {
          const res = await fetch('/api/accounts/summary');
          if (!res.ok) throw new Error('API Error');
          let rawData = await res.json();

          // 1. SORTING: Active first, Discharged last
          const active = rawData.filter((p) => !p.isDischarged);
          const discharged = rawData.filter((p) => p.isDischarged);
          accountsData = [...active, ...discharged];

          const tbody = document.getElementById('accounts-table-body');
          tbody.innerHTML = '';

          accountsData.forEach((p) => {
            // 2. PARSE VALUES (The Fix: Force everything to Number)
            // Use calculatedFee if available (prorated), otherwise use monthlyFee
            const fee = Number(String(p.calculatedFee || p.monthlyFee).replace(/,/g, '')) || 0;
            const received = Number(String(p.receivedAmount).replace(/,/g, '')) || 0;
            const canteen = Number(String(p.canteenTotal).replace(/,/g, '')) || 0;
            // Only add laundry if laundryStatus is true
            const laundry = p.laundryStatus
              ? Number(String(p.laundryAmount).replace(/,/g, '')) || 0
              : 0;

            // 3. CALCULATE TOTALS: Total Bill = Fee + Canteen + Laundry
            const totalBill = fee + canteen + laundry;
            // Balance Due = Total Bill - Received
            const balanceDue = totalBill - received;

            // 4. STYLING
            const rowClass = p.isDischarged
              ? 'discharged-row border-gray-100'
              : 'hover:bg-gray-50 transition';

            // Balance Text Color logic
            const balanceClass =
              balanceDue > 0
                ? p.isDischarged
                  ? 'text-red-300 font-bold'
                  : 'text-red-600 font-bold'
                : p.isDischarged
                  ? 'text-green-300 font-bold'
                  : 'text-[#c9a749] font-bold';

            const statusBadge = p.isDischarged
              ? '<span class="ml-2 text-[10px] uppercase font-bold bg-gray-200 text-gray-500 px-2 py-0.5 rounded">Discharged</span>'
              : '';

            tbody.innerHTML += `
        <tr class="border-b transition ${rowClass}">
            <td class="px-6 py-4 font-medium whitespace-nowrap">
                ${p.name} ${statusBadge}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${p.fatherName}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">${p.admissionDate}</td>
            
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-bold">${formatCurrency(totalBill)}</div>
                <div class="text-xs opacity-70">
                    (Fee: ${formatNumber(fee)} + Cant: ${formatNumber(
                      canteen
                    )} + Lnd: ${formatNumber(laundry)})
                </div>
            </td>

            <td class="px-6 py-4 font-medium whitespace-nowrap">
                ${formatCurrency(received)}
            </td>

            <td class="px-6 py-4 whitespace-nowrap ${balanceClass}">
                ${formatCurrency(balanceDue)}
            </td>

            <td class="px-6 py-4">  
                <button onclick="printDischargeSlip('${
                  p.id
                }')" class="bg-gray-800 hover:bg-gray-900 text-white px-3 py-1 rounded text-sm shadow-md transition font-semibold">
                    <i class="fas fa-print mr-1"></i> Discharge
                </button>
            </td>
        </tr>`;
          });
        } catch (e) {
          console.error(e);
        }
      }

      window.printDischargeSlip = async function (id) {
        // 1. Locate Patient Data
        let p = accountsData?.find((x) => (x._id || x.id) === id);
        // Fallback search if not in accountsData
        if (!p && Array.isArray(patientsData)) {
          const candidate = patientsData.find((x) => (x._id || x.id) === id);
          if (candidate) {
            p = {
              id: candidate._id || candidate.id,
              name: candidate.name,
              fatherName: candidate.fatherName,
              admissionDate: candidate.admissionDate,
              monthlyFee: candidate.monthlyFee,
              laundryAmount: candidate.laundryAmount,
              canteenTotal: 0,
              cnic: candidate.cnic,
            };
          }
        }
        if (!p) {
          showSuccessModal('Patient data not found.', true);
          return;
        }

        // 2. Fetch Payment History from Backend
        let paymentHistory = [];
        try {
          const res = await fetch(`/api/patients/${id}/payment_history`);
          if (res.ok) paymentHistory = await res.json();
        } catch (e) {
          console.error('History fetch error', e);
        }

        // 3. Formatters
        const fmt = (n) =>
          new Intl.NumberFormat('en-PK').format(Number(String(n).replace(/,/g, '')) || 0);
        const parse = (n) => Number(String(n).replace(/,/g, '')) || 0;

        // 4. Fill Header Info
        document.getElementById('ds-date-print').innerText = new Date().toLocaleDateString();
        document.getElementById('ds-name').innerText = p.name || '-';
        document.getElementById('ds-father').innerText = p.fatherName || '-';
        document.getElementById('ds-admission').innerText = p.admissionDate || '-';
        document.getElementById('ds-cnic').innerText = p.cnic || '-';

        // 5. Calculate Charges
        // Use calculatedFee if available (prorated), otherwise use monthlyFee
        const fee = parse(p.calculatedFee || p.monthlyFee);
        const laundry = parse(p.laundryAmount);
        const canteen = parse(p.canteenTotal);
        const gross = fee + laundry + canteen;

        document.getElementById('ds-total-fee').innerText = fmt(fee);
        document.getElementById('ds-total-canteen').innerText = fmt(canteen);
        document.getElementById('ds-total-laundry').innerText = fmt(laundry);
        document.getElementById('ds-gross-total').innerText = fmt(gross);

        // 6. Populate Table & Calculate Total Received
        const historyBody = document.getElementById('ds-payment-history-body');
        historyBody.innerHTML = '';

        let calculatedReceived = 0;

        if (paymentHistory.length === 0) {
          // If NO history found, we default to 0 to prevent the "5 million" error.
          historyBody.innerHTML =
            '<tr><td colspan="4" class="p-3 text-center text-gray-500 italic text-xs">No payment records found.</td></tr>';
          calculatedReceived = 0;
        } else {
          paymentHistory.forEach((rec) => {
            const amount = parse(rec.amount);
            calculatedReceived += amount;

            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50 text-xs';
            row.innerHTML = `
                <td class="p-2">${rec.date}</td>
                <td class="p-2 uppercase font-semibold text-gray-600">${rec.method}</td>
                <td class="p-2 text-gray-500 truncate max-w-[150px]">${rec.note}</td>
                <td class="p-2 text-right font-mono">${fmt(amount)}</td>
            `;
            historyBody.appendChild(row);
          });
        }

        // 7. Final Balance Calculation
        const balance = gross - calculatedReceived;

        document.getElementById('ds-total-received').innerText = fmt(calculatedReceived);
        document.getElementById('ds-net-balance').innerText = `PKR ${fmt(balance)}`;

        // Balance Styling
        const balEl = document.getElementById('ds-net-balance');
        const labelEl = balEl.previousElementSibling;

        if (balance > 0) {
          balEl.className = 'text-3xl font-mono font-bold text-red-600'; // Debit/Due
          labelEl.innerText = 'NET PAYABLE BALANCE';
        } else if (balance < 0) {
          balEl.className = 'text-3xl font-mono font-bold text-[#c9a749]'; // Credit/Surplus
          labelEl.innerText = 'REFUNDABLE BALANCE';
        } else {
          balEl.className = 'text-3xl font-mono font-bold text-gray-800'; // Cleared
          labelEl.innerText = 'NET BALANCE';
        }

        // 8. Trigger Print
        const slip = document.getElementById('printable-discharge-slip');
        const normal = document.getElementById('printable-area');

        if (normal) normal.classList.remove('print-active');
        slip.classList.remove('hidden');
        slip.classList.add('print-active');

        window.print();

        setTimeout(() => {
          slip.classList.remove('print-active');
          slip.classList.add('hidden');
        }, 500);
      };

      // --- CANTEEN LOGIC ---
      function setupSearchableDropdown(input, dropdown, patients) {
        let selectedPatientId = null;

        // Render dropdown items
        function renderDropdown(filter = '') {
          const filteredPatients = patients.filter((p) =>
            p.name.toLowerCase().includes(filter.toLowerCase())
          );

          dropdown.innerHTML = '';

          if (filteredPatients.length === 0) {
            dropdown.innerHTML =
              '<div class="searchable-dropdown-item" style="color: #9ca3af;">No patients found</div>';
          } else {
            filteredPatients.forEach((p) => {
              const item = document.createElement('div');
              item.className = 'searchable-dropdown-item';
              item.textContent = p.name;
              item.dataset.id = p.id;
              item.dataset.name = p.name;

              item.addEventListener('click', () => {
                input.value = p.name;
                selectedPatientId = p.id;
                dropdown.style.display = 'none';
              });

              dropdown.appendChild(item);
            });
          }
        }

        // Show dropdown on focus
        input.addEventListener('focus', () => {
          renderDropdown(input.value);
          dropdown.style.display = 'block';
        });

        // Filter on input
        input.addEventListener('input', (e) => {
          renderDropdown(e.target.value);
          dropdown.style.display = 'block';
          selectedPatientId = null; // Clear selection when typing
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        // Store selected ID for form submission
        input.dataset.getSelectedId = () => selectedPatientId;
      }

      async function renderCanteenBreakdown() {
        // Check if user has permission to view canteen
        if (!['Admin', 'Canteen'].includes(currentUser.role)) {
          console.warn('[CANTEEN] Access denied for role:', currentUser.role);
          alert(
            `Access Denied: You need Admin or Canteen role to view this section.\n\nYour current role: ${currentUser.role}`
          );
          window.navigateTo('dashboard-view');
          return;
        }

        // Initialize month/year selectors
        const monthSelect = document.getElementById('canteen-month-select');
        const yearSelect = document.getElementById('canteen-year-select');

        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();

        // Set current month
        monthSelect.value = currentMonth;

        // Populate years (current year and 2 years back)
        yearSelect.innerHTML = '';
        for (let y = currentYear; y >= currentYear - 2; y--) {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = y;
          yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;

        // Load current month's data
        await loadCanteenMonthlyTable();
      }

      window.loadCanteenMonthlyTable = async function loadCanteenMonthlyTable() {
        try {
          const month = document.getElementById('canteen-month-select').value;
          const year = document.getElementById('canteen-year-select').value;

          console.log(`[CANTEEN] Loading table for ${month}/${year}`);

          const res = await fetch(`/api/canteen/monthly-table?month=${month}&year=${year}`);

          if (!res.ok) {
            if (res.status === 403) {
              const errorData = await res.json().catch(() => ({ error: 'Access Denied' }));
              console.error('[CANTEEN] Access denied:', errorData);
              alert(
                `Access Denied: ${errorData.error}\n\nYou need Admin or Canteen role to view this section.\n\nYour current role: ${currentUser.role}`
              );
              // Navigate back to dashboard
              window.navigateTo('dashboard-view');
              return;
            }
            const errorText = await res.text();
            console.error('[CANTEEN] API error response:', errorText);
            throw new Error(`API returned ${res.status}: ${errorText}`);
          }

          const data = await res.json();
          console.log('[CANTEEN] Data loaded:', data);

          const monthDisplay = document.getElementById('canteen-month-display');
          const tableHeader = document.getElementById('canteen-table-header');
          const tableBody = document.getElementById('canteen-monthly-body');

          // Update month display
          const monthNames = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December',
          ];
          monthDisplay.textContent = `${monthNames[month - 1]} ${year} - ${data.daysInMonth} days`;

          // Build table header
          let headerHTML = `
            <th class="px-4 py-3 text-left text-xs font-bold text-[#5c4d1f] uppercase tracking-wider sticky left-0 bg-[#fffbf0] z-10" style="min-width: 150px;">Name</th>
            <th class="px-4 py-3 text-center text-xs font-bold text-[#5c4d1f] uppercase tracking-wider" style="min-width: 120px;">Old Balance</th>
          `;

          // Add day columns (1 to 28/29/30/31)
          for (let day = 1; day <= data.daysInMonth; day++) {
            headerHTML += `<th class="px-3 py-3 text-center text-xs font-bold text-[#5c4d1f] uppercase" style="min-width: 60px;">${day}</th>`;
          }

          headerHTML += `
            <th class="px-4 py-3 text-center text-xs font-bold text-[#5c4d1f] uppercase tracking-wider" style="min-width: 100px;">Other</th>
            <th class="px-4 py-3 text-center text-xs font-bold text-[#5c4d1f] uppercase tracking-wider bg-emerald-100" style="min-width: 120px;">Month Total</th>
            <th class="px-4 py-3 text-center text-xs font-bold text-[#5c4d1f] uppercase tracking-wider bg-emerald-100" style="min-width: 120px;">Total</th>
          `;

          tableHeader.innerHTML = headerHTML;

          // Build table rows
          const isAdmin = currentUser.role === 'Admin';
          const isCanteen = currentUser.role === 'Canteen';

          tableBody.innerHTML = '';

          data.patients.forEach((patient) => {
            const row = document.createElement('tr');
            row.className = patient.isDischarged ? 'bg-gray-50 opacity-60' : 'hover:bg-gray-50';

            // Name cell - always white background
            const nameCell = document.createElement('td');
            nameCell.className = 'px-4 py-3 whitespace-nowrap sticky left-0 bg-white z-10 border-r';
            nameCell.textContent = patient.name + ' ';

            if (patient.isDischarged) {
              const badge = document.createElement('span');
              badge.className =
                'ml-2 text-[9px] uppercase font-bold bg-gray-300 text-gray-600 px-1.5 py-0.5 rounded';
              badge.textContent = 'Discharged';
              nameCell.appendChild(badge);
            }
            row.appendChild(nameCell);

            // Old Balance cell - editable for admin, show indicator if manually overridden
            const oldBalanceCell = document.createElement('td');
            oldBalanceCell.className = 'px-4 py-3 text-center font-semibold text-gray-700';
            if (isAdmin) {
              oldBalanceCell.className += ' editable-cell cursor-text hover:bg-blue-50';
              oldBalanceCell.contentEditable = 'true';
              oldBalanceCell.addEventListener('blur', () =>
                saveCanteenOldBalance(oldBalanceCell, month, year)
              );
              oldBalanceCell.addEventListener('keydown', handleCellKeydown);
            }
            oldBalanceCell.dataset.patientId = patient.id;
            oldBalanceCell.dataset.entryType = 'old-balance';
            oldBalanceCell.dataset.original = patient.oldBalance;
            oldBalanceCell.dataset.month = month;
            oldBalanceCell.dataset.year = year;
            oldBalanceCell.title = patient.hasManualOverride
              ? 'Manual override (calculated: ' + formatCurrency(patient.calculatedBalance) + ')'
              : 'Auto-calculated';
            oldBalanceCell.textContent = formatCurrency(patient.oldBalance);

            if (patient.hasManualOverride) {
              const icon = document.createElement('i');
              icon.className = 'fas fa-edit text-blue-500 text-xs ml-1';
              icon.title = 'Manually edited';
              oldBalanceCell.appendChild(icon);
            }
            row.appendChild(oldBalanceCell);

            // Add day cells (editable) - using DOM creation instead of innerHTML
            for (let day = 1; day <= data.daysInMonth; day++) {
              const amount = patient.dailyEntries[day] || '';
              const displayValue = amount ? formatCurrency(amount) : '';

              // Determine if cell is editable
              const isEditable = isAdmin || (isCanteen && !amount);

              const dayCell = document.createElement('td');
              dayCell.className = 'px-2 py-2 text-center text-sm';
              dayCell.className += isEditable
                ? ' editable-cell cursor-text hover:bg-blue-50'
                : ' bg-gray-100';

              if (isEditable) {
                dayCell.contentEditable = 'true';
                dayCell.addEventListener('blur', () => saveCanteenEntry(dayCell, month, year));
                dayCell.addEventListener('keydown', handleCellKeydown);
              }

              dayCell.dataset.patientId = patient.id;
              dayCell.dataset.day = day;
              dayCell.dataset.entryType = 'daily';
              dayCell.dataset.original = amount;
              dayCell.dataset.month = month;
              dayCell.dataset.year = year;
              dayCell.textContent = displayValue;

              row.appendChild(dayCell);
            }

            // Other column (editable)
            const otherAmount = patient.other || '';
            const otherDisplay = otherAmount ? formatCurrency(otherAmount) : '';
            const otherEditable = isAdmin || (isCanteen && !otherAmount);

            const otherCell = document.createElement('td');
            otherCell.className = 'px-3 py-2 text-center text-sm font-medium';
            otherCell.className += otherEditable
              ? ' editable-cell cursor-text hover:bg-blue-50'
              : ' bg-gray-100';

            if (otherEditable) {
              otherCell.contentEditable = 'true';
              otherCell.addEventListener('blur', () => saveCanteenEntry(otherCell, month, year));
              otherCell.addEventListener('keydown', handleCellKeydown);
            }

            otherCell.dataset.patientId = patient.id;
            otherCell.dataset.entryType = 'other';
            otherCell.dataset.original = otherAmount;
            otherCell.dataset.month = month;
            otherCell.dataset.year = year;
            otherCell.textContent = otherDisplay;

            row.appendChild(otherCell);

            // Month Total (calculated, not editable)
            const monthTotalCell = document.createElement('td');
            monthTotalCell.className = 'px-4 py-3 text-center font-bold text-gray-900 bg-[#fffbf0]';
            monthTotalCell.textContent = formatCurrency(patient.monthTotal);
            row.appendChild(monthTotalCell);

            // Total (all-time, not editable)
            const totalCell = document.createElement('td');
            totalCell.className = 'px-4 py-3 text-center font-bold text-gray-900 bg-[#fffbf0]';
            totalCell.textContent = formatCurrency(patient.total);
            row.appendChild(totalCell);

            tableBody.appendChild(row);
          });

          // Initialize dual scrollbars for canteen table after rendering
          setTimeout(initDualScrollbars, 50);
        } catch (e) {
          console.error('Error loading canteen table:', e);
          alert('Failed to load canteen data');
        }
      };

      window.handleCellKeydown = function handleCellKeydown(event) {
        // Allow Enter to save and move to next cell
        if (event.key === 'Enter') {
          event.preventDefault();
          event.target.blur();
        }

        // Only allow numbers, backspace, delete, arrows
        const allowedKeys = [
          'Backspace',
          'Delete',
          'ArrowLeft',
          'ArrowRight',
          'ArrowUp',
          'ArrowDown',
          'Tab',
        ];
        if (!allowedKeys.includes(event.key) && (event.key < '0' || event.key > '9')) {
          event.preventDefault();
        }
      };

      window.saveCanteenOldBalance = async function saveCanteenOldBalance(cell, month, year) {
        // Guard flag to prevent duplicate saves from blur events
        if (cell.dataset.saving === 'true') {
          console.log('Already saving old balance, skipping...');
          return;
        }
        cell.dataset.saving = 'true';

        const patientId = cell.dataset.patientId;
        const originalValue = cell.dataset.original || '';

        // Get month/year from cell's data attributes (more reliable than parameters)
        const cellMonth = parseInt(cell.dataset.month);
        const cellYear = parseInt(cell.dataset.year);

        // Get the new value (remove currency formatting)
        let newValue = cell.textContent.trim().replace(/[^\d]/g, '');

        // If empty, treat as 0
        if (!newValue) {
          newValue = '0';
        }

        // If unchanged, skip save
        if (newValue === originalValue) {
          cell.textContent = formatCurrency(parseInt(newValue));
          cell.dataset.saving = 'false';
          return;
        }

        try {
          const res = await fetch('/api/canteen/old-balance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              patient_id: patientId,
              month: cellMonth,
              year: cellYear,
              old_balance: parseInt(newValue),
            }),
          });

          if (res.ok) {
            // Update the cell with formatted value
            cell.textContent = formatCurrency(parseInt(newValue));
            cell.dataset.original = newValue;

            // Add indicator icon if not already present
            if (!cell.querySelector('.fa-edit')) {
              const icon = document.createElement('i');
              icon.className = 'fas fa-edit text-blue-500 text-xs ml-1';
              icon.title = 'Manually edited';
              cell.appendChild(icon);
            }

            // Reload the table to recalculate exceeds balance logic
            await loadCanteenMonthlyTable();
          } else {
            const error = await res.text();
            alert('Failed to save old balance: ' + error);
            cell.textContent = formatCurrency(parseInt(originalValue));
          }
        } catch (e) {
          console.error('Save old balance error:', e);
          alert('Error saving old balance');
          cell.textContent = formatCurrency(parseInt(originalValue));
        } finally {
          // Reset guard flag to allow future saves
          cell.dataset.saving = 'false';
        }
      };

      window.saveCanteenEntry = async function saveCanteenEntry(cell, month, year) {
        // Guard flag to prevent duplicate saves from blur events
        if (cell.dataset.saving === 'true') {
          console.log('Already saving, skipping...');
          return;
        }
        cell.dataset.saving = 'true';

        const patientId = cell.dataset.patientId;
        const entryType = cell.dataset.entryType;
        const originalValue = cell.dataset.original || '';

        // Get month/year from cell's data attributes (more reliable than parameters)
        const cellMonth = parseInt(cell.dataset.month);
        const cellYear = parseInt(cell.dataset.year);

        // Get the new value (remove currency formatting)
        let newValue = cell.textContent.trim().replace(/[^\d]/g, '');

        // If empty, treat as 0
        if (!newValue) {
          newValue = '0';
        }

        const newAmount = parseInt(newValue);
        const originalAmount = originalValue ? parseInt(originalValue) : 0;

        // If value hasn't changed, do nothing
        if (newAmount === originalAmount) {
          cell.textContent = originalAmount ? formatCurrency(originalAmount) : '';
          cell.dataset.saving = 'false';
          return;
        }

        // Build the date - FIXED: Use noon (12:00) to prevent timezone conversion issues
        let entryDate;
        if (entryType === 'daily') {
          const day = parseInt(cell.dataset.day);
          // Use noon instead of midnight to prevent timezone shift to previous day
          entryDate = new Date(cellYear, cellMonth - 1, day, 12, 0, 0);
        } else {
          // For "other" column, use first day of month at noon
          entryDate = new Date(cellYear, cellMonth - 1, 1, 12, 0, 0);
        }

        try {
          const res = await fetch('/api/canteen/daily-entry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              patient_id: patientId,
              date: entryDate.toISOString(),
              amount: newAmount,
              entry_type: entryType,
              item: entryType === 'other' ? 'Other adjustment' : 'Daily canteen',
            }),
          });

          if (res.ok) {
            // Update the cell with formatted value
            cell.textContent = newAmount ? formatCurrency(newAmount) : '';
            cell.dataset.original = newAmount;

            // Reload the table to update totals
            await loadCanteenMonthlyTable();

            // Sync overheads canteen column if overheads view is visible
            if (typeof refreshOverheadsCanteenColumn === 'function') {
              await refreshOverheadsCanteenColumn();
            }
          } else {
            const error = await res.json();
            alert(error.error || 'Failed to save entry');
            // Revert to original value
            cell.textContent = originalAmount ? formatCurrency(originalAmount) : '';
          }
        } catch (e) {
          console.error('Error saving entry:', e);
          alert('Failed to save entry');
          // Revert to original value
          cell.textContent = originalAmount ? formatCurrency(originalAmount) : '';
        } finally {
          // Reset guard flag to allow future saves
          cell.dataset.saving = 'false';
        }
      };

      window.recordCanteenSale = async function (e) {
        // Legacy function - kept for compatibility but not used in new system
        e.preventDefault();
        alert('Please use the monthly table to record canteen entries.');
      };

      // ============================================================
      // --- MONTHLY OVERHEADS MANAGEMENT (ADMIN ONLY) ---
      // ============================================================

      let monthlyOverheadsData = {};
      let monthlyCanteenDailyData = {};
      let monthlyEmployeesCache = [];

      async function initializeMonthlyOverheads() {
        // Initialize month/year selectors
        const monthSelect = document.getElementById('monthly-overheads-month-select');
        const yearSelect = document.getElementById('monthly-overheads-year-select');

        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();

        // Set current month
        monthSelect.value = currentMonth;

        // Populate years (current year and 2 years back)
        yearSelect.innerHTML = '';
        for (let y = currentYear; y >= currentYear - 2; y--) {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = y;
          yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;

        // Fetch employees for dropdown
        try {
          const res = await fetch('/api/employees');
          if (res.ok) {
            monthlyEmployeesCache = await res.json();
          }
        } catch (e) {
          console.error('Failed to fetch employees:', e);
        }

        // Load current month data
        await loadMonthlyOverheadsTable();
      }

      window.loadMonthlyOverheadsTable = async function () {
        try {
          const month = parseInt(document.getElementById('monthly-overheads-month-select').value);
          const year = parseInt(document.getElementById('monthly-overheads-year-select').value);

          console.log(`[MONTHLY OVERHEADS] Loading table for ${month}/${year}`);

          const res = await fetch(`/api/overheads/${month}/${year}`);
          if (!res.ok) {
            throw new Error(`API returned ${res.status}`);
          }

          const data = await res.json();
          console.log('[MONTHLY OVERHEADS] Data loaded:', data);

          monthlyOverheadsData = data.overheads || {};
          monthlyCanteenDailyData = data.canteen_daily || {};
          const daysInMonth = data.days_in_month;

          renderMonthlyOverheadsTable(month, year, daysInMonth);

          // Also refresh annual profit card for the selected year
          await loadAnnualOverheadsProfit(year);
        } catch (e) {
          console.error('[MONTHLY OVERHEADS] Error loading data:', e);
          alert('Failed to load monthly overheads data. Please try again.');
        }
      };

      function renderMonthlyOverheadsTable(month, year, daysInMonth) {
        const container = document.getElementById('monthly-overheads-table-container');

        const monthNames = [
          'January',
          'February',
          'March',
          'April',
          'May',
          'June',
          'July',
          'August',
          'September',
          'October',
          'November',
          'December',
        ];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        let tableHTML = `
          <table class="w-full table-auto border-collapse text-sm">
            <thead class="bg-[#c9a749] text-white sticky top-0">
              <tr>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Date</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Day</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Kitchen</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Canteen</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Others</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Pay/Advance</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700 bg-[#b8941f]">Total Expense</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Income</th>
                <th class="px-3 py-3 text-center text-xs font-bold uppercase border border-emerald-700">Profit Per Day</th>
                <th class="px-1 py-3 text-center text-xs font-bold uppercase border border-emerald-700 w-20">Employee <span class="text-emerald-200 font-normal text-[10px]">(Optional)</span></th>
              </tr>
            </thead>
            <tbody class="bg-white">
        `;

        // Totals tracking
        let totalKitchen = 0;
        let totalCanteen = 0;
        let totalOthers = 0;
        let totalPayAdvance = 0;
        let totalExpense = 0;
        let totalIncome = 0;
        let totalProfit = 0;

        // Generate rows for each day
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month - 1, day);
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayName = dayNames[dateObj.getDay()];

          const entry = monthlyOverheadsData[dateStr] || {};
          const kitchen = entry.kitchen || 0;
          const canteenAuto = monthlyCanteenDailyData[dateStr] || 0;
          const others = entry.others || 0;
          const payAdvance = entry.pay_advance || 0;
          const income = entry.income || 0;
          const employeeNames = entry.employee_names || '';

          const rowExpense = kitchen + canteenAuto + others + payAdvance;
          const dayProfit = income - rowExpense;

          totalKitchen += kitchen;
          totalCanteen += canteenAuto;
          totalOthers += others;
          totalPayAdvance += payAdvance;
          totalExpense += rowExpense;
          totalIncome += income;
          totalProfit += dayProfit;

          tableHTML += `
            <tr class="hover:bg-[#fffbf0] border-b">
              <td class="px-3 py-2 text-center border border-gray-200 font-semibold">${day}</td>
              <td class="px-3 py-2 text-center border border-gray-200 text-gray-600">${dayName}</td>
              <td class="px-3 py-2 text-right border border-gray-200 cursor-pointer hover:bg-yellow-50" 
                  contenteditable="true"
                  data-field="kitchen"
                  data-date="${dateStr}"
                  onblur="saveMonthlyOverheadCell(this)"
                  onfocus="selectAllText(this)">${kitchen || ''}</td>
              <td class="px-3 py-2 text-right border border-gray-200 bg-gray-100 text-gray-700 font-semibold">${canteenAuto ? formatCurrency(canteenAuto) : ''}</td>
              <td class="px-3 py-2 text-right border border-gray-200 cursor-pointer hover:bg-yellow-50" 
                  contenteditable="true"
                  data-field="others"
                  data-date="${dateStr}"
                  onblur="saveMonthlyOverheadCell(this)"
                  onfocus="selectAllText(this)">${others || ''}</td>
              <td class="px-3 py-2 text-right border border-gray-200 cursor-pointer hover:bg-yellow-50" 
                  contenteditable="true"
                  data-field="pay_advance"
                  data-date="${dateStr}"
                  onblur="saveMonthlyOverheadCell(this)"
                  onfocus="selectAllText(this)">${payAdvance || ''}</td>
              <td class="px-3 py-2 text-right border border-gray-200 bg-emerald-100 font-bold text-[#5c4d1f]">${rowExpense ? formatCurrency(rowExpense) : ''}</td>
              <td class="px-3 py-2 text-right border border-gray-200 cursor-pointer hover:bg-yellow-50" 
                  contenteditable="true"
                  data-field="income"
                  data-date="${dateStr}"
                  onblur="saveMonthlyOverheadCell(this)"
                  onfocus="selectAllText(this)">${income || ''}</td>
                            <td class="px-3 py-2 text-right border border-gray-200 font-bold ${dayProfit >= 0 ? 'text-[#5c4d1f] bg-[#fffbf0]' : 'text-red-700 bg-red-50'}">${dayProfit ? formatCurrency(dayProfit) : ''}</td>
              <td class="px-1 py-2 border border-gray-200 cursor-pointer hover:bg-yellow-50 relative text-gray-600 text-xs w-20" 
                  data-field="employee_names"
                  data-date="${dateStr}"
                  onclick="openMonthlyEmployeeDropdown(this)">${employeeNames || '<span class="text-gray-400 italic text-xs">Optional</span>'}</td>
            </tr>
          `;
        }

        // Totals row
        const profit = totalIncome - totalExpense;
        tableHTML += `
            <tr class="bg-emerald-800 text-white font-bold" style="background-color: #064e3b !important;">
              <td colspan="2" class="px-3 py-3 text-center border border-emerald-900 uppercase text-white" style="background-color: #064e3b !important; color: white !important;">Total</td>
              <td class="px-3 py-3 text-right border border-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalKitchen)}</td>
              <td class="px-3 py-3 text-right border border-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalCanteen)}</td>
              <td class="px-3 py-3 text-right border border-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalOthers)}</td>
              <td class="px-3 py-3 text-right border border-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalPayAdvance)}</td>
              <td class="px-3 py-3 text-right border border-emerald-900 bg-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalExpense)}</td>
              <td class="px-3 py-3 text-right border border-emerald-900 text-white" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalIncome)}</td>
                            <td class="px-3 py-3 text-right border border-emerald-900 text-white font-extrabold" style="background-color: #064e3b !important; color: white !important;">${formatCurrency(totalProfit)}</td>
              <td class="px-1 py-3 border border-emerald-900 w-20 text-white" style="background-color: #064e3b !important; color: white !important;"></td>
            </tr>
          </tbody>
        </table>
        `;

        container.innerHTML = tableHTML;

        // Update profit display
        const profitDisplay = document.getElementById('monthly-overheads-profit-display');
        const profitClass =
          profit >= 0
            ? 'text-[#5c4d1f] bg-[#fffbf0] border-[#c9a749]'
            : 'text-white bg-red-500 border-red-600';
        profitDisplay.innerHTML = `
          <div class="border-2 ${profitClass} px-6 py-3 rounded-xl shadow-lg">
            <div class="text-xs font-bold uppercase tracking-wide mb-1">${monthNames[month - 1]} Profit</div>
            <div class="text-3xl font-extrabold">${formatCurrency(profit)}</div>
          </div>
        `;
      }

      // Load and display annual profit card for the selected year
      async function loadAnnualOverheadsProfit(year) {
        const annualDisplay = document.getElementById('monthly-overheads-annual-profit-display');
        if (!annualDisplay) return;

        // Show loading placeholder
        annualDisplay.innerHTML = `
          <div class="border-2 border-gray-200 px-6 py-3 rounded-xl shadow-sm text-right bg-gray-50">
            <div class="text-xs font-bold uppercase tracking-wide mb-1 text-gray-500">${year} Profit</div>
            <div class="text-lg font-semibold text-gray-500">Loading...</div>
          </div>
        `;

        try {
          const res = await fetch(`/api/overheads/annual/${year}`);
          if (!res.ok) throw new Error(`API returned ${res.status}`);

          const data = await res.json();
          const profit = data.profit || 0;
          const profitClass =
            profit >= 0
              ? 'text-[#5c4d1f] bg-[#fffbf0] border-[#c9a749]'
              : 'text-white bg-red-500 border-red-600';

          annualDisplay.innerHTML = `
            <div class="border-2 ${profitClass} px-6 py-3 rounded-xl shadow-lg">
              <div class="text-xs font-bold uppercase tracking-wide mb-1">${year} Profit</div>
              <div class="text-3xl font-extrabold">${formatCurrency(profit)}</div>
            </div>
          `;
        } catch (e) {
          console.error('[MONTHLY OVERHEADS] Error loading annual profit:', e);
          annualDisplay.innerHTML = `
            <div class="border-2 border-red-200 px-6 py-3 rounded-xl shadow-sm bg-red-50 text-red-700">
              <div class="text-xs font-bold uppercase tracking-wide mb-1">${year} Profit</div>
              <div class="text-sm">Failed to load</div>
            </div>
          `;
        }
      }

      window.selectAllText = function (element) {
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      };

      window.saveMonthlyOverheadCell = async function (cell) {
        const date = cell.dataset.date;
        const field = cell.dataset.field;
        const value = parseFloat(cell.textContent.trim()) || 0;

        const [year, month, day] = date.split('-').map(Number);

        // Get current row values
        const row = cell.parentElement;
        const cells = Array.from(row.querySelectorAll('td'));

        const kitchen = parseFloat(cells[2].textContent.trim()) || 0;
        const others = parseFloat(cells[4].textContent.trim()) || 0;
        const payAdvance = parseFloat(cells[5].textContent.trim()) || 0;
        const employeeNames = cells[9].textContent.trim();
        const income = parseFloat(cells[7].textContent.trim()) || 0;
        const canteenAuto = monthlyCanteenDailyData[date] || 0;

        try {
          const res = await fetch('/api/overheads/entry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              date,
              month,
              year,
              kitchen,
              canteen_auto: canteenAuto,
              others,
              pay_advance: payAdvance,
              employee_names: employeeNames,
              income,
            }),
          });

          if (res.ok) {
            // Reload table to update totals and profit
            await loadMonthlyOverheadsTable();
          } else {
            alert('Failed to save entry');
          }
        } catch (e) {
          console.error('Error saving monthly overhead entry:', e);
          alert('Failed to save entry');
        }
      };

      window.openMonthlyEmployeeDropdown = function (cell) {
        const date = cell.dataset.date;
        const currentValue = cell.textContent.trim();

        // Remove any existing dropdown
        const existing = document.querySelector('.employee-dropdown-overlay');
        if (existing) existing.remove();

        // Create overlay
        const overlay = document.createElement('div');
        overlay.className =
          'employee-dropdown-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';

        const dropdown = document.createElement('div');
        dropdown.className = 'bg-white rounded-lg shadow-xl p-4 w-96 max-h-96 overflow-y-auto';
        dropdown.innerHTML = `
          <h3 class="font-bold text-gray-800 mb-2 text-lg">Select Employee(s)</h3>
          <p class="text-xs text-gray-500 mb-3 italic">This field is optional - leave empty if not applicable</p>
          <input type="text" 
                 id="monthly-employee-search" 
                 placeholder="Search employees..." 
                 class="w-full border rounded px-3 py-2 mb-3 focus:ring-2 focus:ring-[#c9a749]" />
          <div id="monthly-employee-list" class="space-y-1"></div>
          <div class="mt-4 flex gap-2">
            <button onclick="saveMonthlyEmployeeSelection('${date}')" class="flex-1 bg-[#c9a749] text-white px-4 py-2 rounded hover:bg-[#b8941f]">Save</button>
            <button onclick="clearMonthlyEmployeeSelection('${date}')" class="flex-1 bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">Clear</button>
            <button onclick="closeMonthlyEmployeeDropdown()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
          </div>
        `;

        overlay.appendChild(dropdown);
        document.body.appendChild(overlay);

        // Populate employee list
        renderMonthlyEmployeeList(currentValue);

        // Add search functionality
        document.getElementById('monthly-employee-search').addEventListener('input', (e) => {
          renderMonthlyEmployeeList(currentValue, e.target.value);
        });

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeMonthlyEmployeeDropdown();
        });
      };

      function renderMonthlyEmployeeList(currentValue, searchTerm = '') {
        const listContainer = document.getElementById('monthly-employee-list');
        const selectedNames = currentValue
          .split(',')
          .map((n) => n.trim())
          .filter((n) => n);

        const filtered = monthlyEmployeesCache.filter((emp) =>
          emp.name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        listContainer.innerHTML = filtered
          .map((emp) => {
            const isChecked = selectedNames.includes(emp.name);
            return `
            <label class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
              <input type="checkbox" 
                     value="${emp.name}" 
                     ${isChecked ? 'checked' : ''} 
                     class="monthly-employee-checkbox" />
              <span>${emp.name} - ${emp.designation}</span>
            </label>
          `;
          })
          .join('');
      }

      window.saveMonthlyEmployeeSelection = async function (date) {
        const checkboxes = document.querySelectorAll('.monthly-employee-checkbox:checked');
        const selectedNames = Array.from(checkboxes)
          .map((cb) => cb.value)
          .join(', ');

        const [year, month, day] = date.split('-').map(Number);

        // Find the cell for this date
        const cell = document.querySelector(`td[data-field="employee_names"][data-date="${date}"]`);
        if (cell) {
          cell.textContent = selectedNames;

          // Get current row values
          const row = cell.parentElement;
          const cells = Array.from(row.querySelectorAll('td'));

          const kitchen = parseFloat(cells[2].textContent.trim()) || 0;
          const others = parseFloat(cells[4].textContent.trim()) || 0;
          const payAdvance = parseFloat(cells[5].textContent.trim()) || 0;
          const income = parseFloat(cells[7].textContent.trim()) || 0;
          const canteenAuto = monthlyCanteenDailyData[date] || 0;

          try {
            const res = await fetch('/api/overheads/entry', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                date,
                month,
                year,
                kitchen,
                canteen_auto: canteenAuto,
                others,
                pay_advance: payAdvance,
                employee_names: selectedNames,
                income,
              }),
            });

            if (res.ok) {
              closeMonthlyEmployeeDropdown();
            } else {
              alert('Failed to save employee selection');
            }
          } catch (e) {
            console.error('Error saving employee selection:', e);
            alert('Failed to save employee selection');
          }
        }
      };

      window.closeMonthlyEmployeeDropdown = function () {
        const overlay = document.querySelector('.employee-dropdown-overlay');
        if (overlay) overlay.remove();
      };

      window.clearMonthlyEmployeeSelection = async function (date) {
        const [year, month, day] = date.split('-').map(Number);

        // Find the cell for this date
        const cell = document.querySelector(`td[data-field="employee_names"][data-date="${date}"]`);
        if (cell) {
          cell.innerHTML = '<span class="text-gray-400 italic text-xs">Optional</span>';

          // Get current row values
          const row = cell.parentElement;
          const cells = Array.from(row.querySelectorAll('td'));

          const kitchen = parseFloat(cells[2].textContent.trim()) || 0;
          const others = parseFloat(cells[4].textContent.trim()) || 0;
          const payAdvance = parseFloat(cells[5].textContent.trim()) || 0;
          const income = parseFloat(cells[7].textContent.trim()) || 0;
          const canteenAuto = monthlyCanteenDailyData[date] || 0;

          try {
            const res = await fetch('/api/overheads/entry', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                date,
                month,
                year,
                kitchen,
                canteen_auto: canteenAuto,
                others,
                pay_advance: payAdvance,
                employee_names: '',
                income,
              }),
            });

            if (res.ok) {
              closeMonthlyEmployeeDropdown();
            } else {
              alert('Failed to clear employee selection');
            }
          } catch (e) {
            console.error('Error clearing employee selection:', e);
            alert('Failed to clear employee selection');
          }
        }
      };

      window.refreshOverheadsCanteenColumn = async function () {
        // Called when canteen sales are updated to sync the Canteen column
        const month = parseInt(document.getElementById('monthly-overheads-month-select').value);
        const year = parseInt(document.getElementById('monthly-overheads-year-select').value);
        const currentView = document.getElementById('monthly-overheads-view');

        // Only refresh if overheads view is currently visible
        if (currentView && !currentView.classList.contains('hidden')) {
          try {
            const res = await fetch(`/api/overheads/canteen-sync/${month}/${year}`);
            if (res.ok) {
              const data = await res.json();
              monthlyCanteenDailyData = data.canteen_daily || {};

              // Reload the entire table to update canteen column and recalculate totals
              await loadMonthlyOverheadsTable();
            }
          } catch (e) {
            console.error('Error syncing canteen data:', e);
          }
        }
      };

      // --- USER MANAGEMENT ---
      async function renderUserManagement() {
        if (currentUser.role !== 'Admin') return;
        const res = await fetch('/api/users');
        const users = await res.json();
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '';
        users.forEach((u) => {
          const delBtn =
            u.username !== 'ImranSaab'
              ? `<button class="text-red-500 hover:text-red-700 transition" onclick="deleteUser('${u._id}')"><i class="fas fa-trash"></i></button>`
              : '';
          tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="px-6 py-4 whitespace-nowrap">${u.name}</td><td class="px-6 py-4 whitespace-nowrap">${u.username}</td><td class="px-6 py-4 whitespace-nowrap">${u.role}</td><td class="px-6 py-4 text-center">${delBtn}</td></tr>`;
        });
      }
      window.createUser = async function (e) {
        e.preventDefault();
        const f = e.target;
        const res = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: f['new-username'].value,
            email: f['new-email'].value,
            password: f['new-password'].value,
            name: f['new-name'].value,
            role: f['new-role'].value,
          }),
        });
        const data = await res.json();
        if (res.ok) {
          showSuccessModal('User created successfully');
          renderUserManagement();
          f.reset();
        } else {
          showSuccessModal(data.error || 'Failed to create user', true);
        }
      };
      window.deleteUser = async function (id) {
        const confirmed = await showConfirmModal('Delete user?');
        if (!confirmed) return;
        await fetch(`/api/users/${id}`, { method: 'DELETE' });
        renderUserManagement();
      };

      // --- OVERHEADS MANAGEMENT ---
      async function renderOverheads() {
        if (currentUser.role !== 'Admin') return;
        totalSalaries = 0;
        totalBills = 0;
        await Promise.all([renderTeam(true), renderUtilityBills(true), updateExpectedIncoming()]);
        updateOverheadTotal();
        loadOldBalances();
      }

      // --- MONTHLY OVERHEADS MANAGEMENT ---
      async function renderMonthlyOverheads() {
        if (currentUser.role !== 'Admin') return;
        await initializeMonthlyOverheads();
      }

      function updateOverheadTotal() {
        const grandTotal = totalSalaries + totalBills;
        const grandTotalEl = document.getElementById('grand-overhead-total');
        const salaryDisplay = document.getElementById('total-salary-display');
        const billsDisplay = document.getElementById('total-bills-display');

        if (grandTotalEl) grandTotalEl.innerText = formatCurrency(grandTotal);
        if (salaryDisplay) salaryDisplay.innerText = formatNumber(totalSalaries);
        if (billsDisplay) billsDisplay.innerText = formatNumber(totalBills);
      }

      async function updateExpectedIncoming() {
        // Ensure patients data is loaded
        if (!patientsData || patientsData.length === 0) {
          await fetchPatients();
        }

        // Calculate total monthly fees from active patients only
        let totalExpectedIncoming = 0;
        patientsData.forEach((p) => {
          const pid = p._id || p.id;
          const isDischarged = dischargedPatientIds.has(pid) || p.isDischarged;

          // Only include active patients
          if (!isDischarged) {
            const monthlyFeeRaw = parseInt(String(p.monthlyFee || '0').replace(/,/g, ''), 10) || 0;
            totalExpectedIncoming += monthlyFeeRaw;
          }
        });

        // Update the display
        const incomeEl = document.getElementById('overhead-total-income');
        if (incomeEl) {
          incomeEl.innerText = formatCurrency(totalExpectedIncoming);
        }
      }

      // --- UTILITY BILLS ---

      async function renderUtilityBills(isOverheadContext = false) {
        if (currentUser.role !== 'Admin') return;

        try {
          const res = await fetch('/api/utility_bills');
          const bills = await res.json();

          const grid = document.getElementById('bills-grid');
          const emptyState = document.getElementById('bills-empty-state');

          if (!grid || !emptyState) return;

          grid.innerHTML = '';

          // Reset local calculation
          let currentTotalBills = 0;

          if (bills.length === 0) {
            emptyState.classList.remove('hidden');
          } else {
            emptyState.classList.add('hidden');
          }

          bills.forEach((b) => {
            // Sum the amount
            currentTotalBills += b.amount;

            // Icon selection logic
            let iconClass = 'fa-file-invoice';
            let colorClass = 'bg-gray-100 text-gray-600';

            if (b.type === 'Electricity') {
              iconClass = 'fa-bolt';
              colorClass = 'bg-yellow-100 text-yellow-600';
            } else if (b.type === 'Gas') {
              iconClass = 'fa-fire';
              colorClass = 'bg-orange-100 text-orange-600';
            } else if (b.type === 'Water') {
              iconClass = 'fa-tint';
              colorClass = 'bg-blue-100 text-blue-600';
            } else if (b.type === 'Internet') {
              iconClass = 'fa-wifi';
              colorClass = 'bg-indigo-100 text-indigo-600';
            } else if (b.type === 'Rent') {
              iconClass = 'fa-home';
              colorClass = 'bg-purple-100 text-purple-600';
            }

            const card = document.createElement('div');
            card.className =
              'bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition relative group';
            card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center shadow-sm">
              <i class="fas ${iconClass}"></i>
            </div>
            <div>
              <h4 class="font-bold text-gray-800">${b.type}</h4>
              <div class="text-xs text-gray-500">${b.ref_no || 'No Ref'}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-extrabold text-lg text-gray-800">${formatCurrency(b.amount)}</div>
            <div class="text-xs font-semibold text-red-500">Due: ${b.due_date}</div>
          </div>
        </div>
        <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end">
          <button onclick="payUtilityBill('${
            b.id
          }')" class="bg-red-50 text-red-700 hover:bg-[#c9a749] hover:text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
            <i class="fas fa-check"></i> Mark Paid
          </button>
        </div>
      `;
            grid.appendChild(card);
          });

          // Update global variable
          totalBills = currentTotalBills;
        } catch (e) {
          console.error('Bills Render Error:', e);
        }
      }

      async function addUtilityBill(e) {
        e.preventDefault();
        const data = {
          type: document.getElementById('bill-type').value,
          amount: document.getElementById('bill-amount').value,
          due_date: document.getElementById('bill-due-date').value,
          ref_no: document.getElementById('bill-ref').value,
        };

        const res = await fetch('/api/utility_bills', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showSuccessModal('Bill Added Successfully');
          e.target.reset();
          renderOverheads(); // CHANGED: calls the combined render
        } else {
          showSuccessModal('Error adding bill', true);
        }
      }

      async function payUtilityBill(id) {
        if (!(await showConfirmModal('Mark this bill as paid? This will move it to Expenses.')))
          return;

        const res = await fetch(`/api/utility_bills/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showSuccessModal('Bill Paid & Recorded');
          renderOverheads(); // CHANGED: calls the combined render
        } else {
          showSuccessModal('Error paying bill', true);
        }
      }

      // --- TEAM MANAGEMENT ---
      let teamData = [];

      async function renderTeam(isOverheadContext = false) {
        if (currentUser.role !== 'Admin') return;

        try {
          const res = await fetch('/api/employees');
          const employees = await res.json();
          teamData = employees;

          const tbody = document.getElementById('team-table-body');
          if (!tbody) return;
          tbody.innerHTML = '';

          // Reset local calculation
          let currentTotalSalary = 0;

          if (employees.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="p-6 text-center text-gray-400">No team members added yet.</td></tr>';
          } else {
            employees.forEach((emp, index) => {
              // Clean and parse numbers
              const payClean = emp.pay ? parseInt(emp.pay.toString().replace(/,/g, '')) || 0 : 0;
              const advanceClean = emp.advance
                ? parseInt(emp.advance.toString().replace(/,/g, '')) || 0
                : 0;

              // Calculate Remaining
              const remaining = payClean - advanceClean;

              // UPDATED: Add REMAINING salary to the total overheads, not the gross pay
              currentTotalSalary += remaining;

              const tr = document.createElement('tr');
              tr.className = 'hover:bg-[#fffbf0]/50 transition border-b border-gray-100';
              tr.innerHTML = `
          <td class="px-4 py-3 text-center text-gray-500 font-mono text-xs">${index + 1}</td>
          <td class="px-4 py-3 font-semibold text-gray-800">${emp.name}</td>
          <td class="px-4 py-3 text-emerald-700 font-medium text-sm bg-[#fffbf0]/30 rounded">${
            emp.designation
          }</td>
          <td class="px-4 py-3 text-gray-600 text-sm font-mono">${formatNumber(payClean)}</td>
          <td class="px-4 py-3 text-gray-600 text-sm font-mono">${formatNumber(advanceClean)}</td>
          <td class="px-4 py-3 font-bold text-gray-800 text-sm font-mono bg-gray-50">${formatNumber(
            remaining
          )}</td>
          <td class="px-4 py-3 text-xs">
            <div class="text-gray-900 font-bold">${emp.phone || ''}</div>
            <div class="text-gray-500">${emp.cnic || ''}</div>
          </td>
          <td class="px-4 py-3 text-center whitespace-nowrap">
            <button onclick="editEmployee('${
              emp.id
            }')" class="text-blue-600 hover:text-blue-800 p-2" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteEmployee('${
              emp.id
            }')" class="text-red-500 hover:text-red-700 p-2" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
              tbody.appendChild(tr);
            });
          }

          // Update global variable which feeds into the Overhead Total
          totalSalaries = currentTotalSalary;

          // Force update of the overhead display immediately if we are in that view
          updateOverheadTotal();
        } catch (e) {
          console.error('Team Render Error:', e);
        }
      }

      function openEmployeeModal() {
        document.getElementById('employee-form').reset();
        document.getElementById('emp-id').value = ''; // Clear ID for new entry
        document.getElementById('emp-modal-title').innerHTML =
          '<i class="fas fa-user-tie mr-2"></i>Add Employee';
        document.getElementById('employee-modal').classList.remove('hidden');
      }

      function closeEmployeeModal() {
        document.getElementById('employee-modal').classList.add('hidden');
      }

      function editEmployee(id) {
        const emp = teamData.find((e) => e.id === id);
        if (!emp) return;

        document.getElementById('emp-id').value = emp.id;
        document.getElementById('emp-name').value = emp.name;
        document.getElementById('emp-designation').value = emp.designation;
        document.getElementById('emp-pay').value = emp.pay;
        document.getElementById('emp-advance').value = emp.advance;
        document.getElementById('emp-timings').value = emp.duty_timings;
        document.getElementById('emp-joining').value = emp.date_of_joining;
        document.getElementById('emp-cnic').value = emp.cnic;
        document.getElementById('emp-phone').value = emp.phone;

        document.getElementById('emp-modal-title').innerHTML =
          '<i class="fas fa-edit mr-2"></i>Edit Employee';
        document.getElementById('employee-modal').classList.remove('hidden');
      }

      async function saveEmployee(e) {
        e.preventDefault();
        const id = document.getElementById('emp-id').value;
        const data = {
          name: document.getElementById('emp-name').value,
          designation: document.getElementById('emp-designation').value,
          pay: document.getElementById('emp-pay').value,
          advance: document.getElementById('emp-advance').value,
          duty_timings: document.getElementById('emp-timings').value,
          date_of_joining: document.getElementById('emp-joining').value,
          cnic: document.getElementById('emp-cnic').value,
          phone: document.getElementById('emp-phone').value,
        };

        let method = 'POST';
        let url = '/api/employees';

        if (id) {
          method = 'PUT';
          url = `/api/employees/${id}`;
        }

        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showSuccessModal(id ? 'Employee Updated' : 'Employee Added');
          closeEmployeeModal();
          renderTeam();
        } else {
          showSuccessModal('Operation failed', true);
        }
      }

      async function deleteEmployee(id) {
        if (!(await showConfirmModal('Remove this employee from the team?'))) return;

        const res = await fetch(`/api/employees/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showSuccessModal('Employee Removed');
          renderTeam();
        } else {
          showSuccessModal('Error removing employee', true);
        }
      }

      // --- RECORDS ---
      async function fetchPatientRecords(id) {
        const res = await fetch(`/api/patients/${id}/records`);
        const records = await res.json();
        const sList = document.getElementById('session-notes-list');
        const mList = document.getElementById('medical-records-list');
        sList.innerHTML = '';
        mList.innerHTML = '';
        records.forEach((r) => {
          const html = `<div class="p-3 border-b bg-gray-50 mb-1 rounded"><div class="text-xs text-gray-500">${new Date(
            r.date
          ).toLocaleDateString()} by ${r.recorded_by}</div><div class="font-bold text-[#5c4d1f]">${
            r.title || r.type
          }</div><p class="text-sm">${r.text || r.details}</p></div>`;
          if (r.type === 'session_note') sList.innerHTML += html;
          else mList.innerHTML += html;
        });
      }
      window.showTab = (t) => {
        document.getElementById('tab-notes').classList.toggle('hidden', t !== 'notes');
        document.getElementById('tab-med').classList.toggle('hidden', t !== 'records');
        document.getElementById('notes-tab-btn').className =
          t === 'notes'
            ? 'flex-1 py-2 text-[#5c4d1f] border-b-2 border-green-700 font-bold'
            : 'flex-1 py-2 text-gray-500';
        document.getElementById('records-tab-btn').className =
          t === 'records'
            ? 'flex-1 py-2 text-[#5c4d1f] border-b-2 border-green-700 font-bold'
            : 'flex-1 py-2 text-gray-500';
      };
      window.addSessionNote = async (e) => {
        e.preventDefault();
        await fetch(`/api/patients/${currentPatientId}/session_note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: document.getElementById('new-session-note-input').value }),
        });
        fetchPatientRecords(currentPatientId);
        e.target.reset();
      };
      window.addMedicalRecord = async (e) => {
        e.preventDefault();
        await fetch(`/api/patients/${currentPatientId}/medical_record`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: document.getElementById('new-med-title').value,
            details: document.getElementById('new-med-details').value,
          }),
        });
        fetchPatientRecords(currentPatientId);
        e.target.reset();
      };

      // --- PRINT POPULATION (RoohFILE) ---
      function populatePrintTemplate(p) {
        const t = (i, v) => {
          const e = document.getElementById(i);
          if (e) e.textContent = v || '................';
        };
        t('pr-name', p.name);
        t('pr-father', p.fatherName);
        t('pr-admission', p.admissionDate);
        t('pr-id', p.idNo);
        t('pr-age', p.age);
        t('pr-cnic', p.cnic);
        t('pr-guardian', p.guardianName);
        t('pr-relation', p.relation);
        t('pr-drug', p.drugProblem);
        t('pr-contact', p.contactNo);
        t('pr-marital', p.maritalStatus);
        t('pr-prev', p.prevAdmissions);
        t('pr-address', p.address);
        t('pr-complaint', p.complaint);
        t('ur-name', p.name);
        t('ur-father', p.fatherName);
        t('ur-age', p.age);
        t('ur-cnic', p.cnic);
        t('ur-contact', p.contactNo);
        t('ur-address', p.address);
        t('ur-auth-name', p.guardianName);

        // Ensure profile is print active by default unless discharge is called
        document.getElementById('printable-area').classList.add('print-active');
        document.getElementById('printable-discharge-slip').classList.remove('print-active');
      }

      // --- OVERHEADS DASHBOARD ---
      window.onload = initApp;

      function updateOverheadTotal() {
        const grandTotal = totalSalaries + totalBills;
        document.getElementById('grand-overhead-total').innerText = formatCurrency(grandTotal);
        document.getElementById('total-salary-display').innerText = formatNumber(totalSalaries);
        document.getElementById('total-bills-display').innerText = formatNumber(totalBills);
      }

      // --- ATTENDANCE VIEW ---
      async function renderAttendanceView() {
        if (currentUser.role !== 'Admin') return;
        await renderAttendanceTable();
      }

      // --- RECEIPT LOGIC ---

      async function openReceiptModal() {
        if (currentUser.role !== 'Admin') {
          showSuccessModal('Access Denied. Admins only.', true);
          return;
        }

        const modal = document.getElementById('receipt-modal');
        const patientIdField = document.getElementById('receipt-patient-id');
        const patientList = document.getElementById('receipt-patient-list');
        const patientInput = document.getElementById('receipt-patient-input');
        const amountField = document.getElementById('receipt-amount');
        const dateField = document.getElementById('receipt-date');

        if (!patientInput) {
          console.error('Receipt patient input not found in DOM.');
          showSuccessModal('Unable to open receipt form. Please reload and try again.', true);
          return;
        }

        amountField.value = '';
        patientInput.value = '';
        patientIdField.value = '';
        patientList.innerHTML = '<option value="">Loading...</option>';

        const now = new Date();
        if (dateField) {
          const localIso = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString()
            .split('T')[0];
          dateField.value = localIso;
        }

        modal.classList.remove('hidden');

        try {
          if (patientsData.length === 0) await fetchPatients();

          const activePatients = patientsData.filter((p) => !p.isDischarged);
          receiptPatientOptions = activePatients.map((p) => {
            const idInfo = p.idNo ? `ID: ${p.idNo}` : '';
            const fatherInfo = p.fatherName || 'Father N/A';
            return {
              id: p._id || p.id,
              label: `${p.name} - Father: ${fatherInfo}${idInfo ? ' (' + idInfo + ')' : ''}`,
              name: p.name,
              father: p.fatherName || '',
            };
          });

          if (receiptPatientOptions.length === 0) {
            patientList.innerHTML = '';
            patientInput.placeholder = 'No active patients available';
          } else {
            patientInput.placeholder = 'Start typing patient name or ID';
            patientList.innerHTML = receiptPatientOptions
              .map((opt) => `<option value="${escapeHtml(opt.label)}"></option>`)
              .join('');
          }

          handleReceiptPatientInputChange();
        } catch (e) {
          console.error(e);
          patientList.innerHTML = '';
          patientInput.placeholder = 'Unable to load patients';
        }
      }

      window.handleReceiptPatientInputChange = function () {
        const input = document.getElementById('receipt-patient-input');
        const hiddenField = document.getElementById('receipt-patient-id');
        if (!input || !hiddenField) return;

        const value = input.value.trim();
        const match = receiptPatientOptions.find((opt) => opt.label === value);
        if (match) {
          hiddenField.value = match.id;
          input.dataset.patientName = match.name;
          input.dataset.fatherName = match.father;
        } else {
          hiddenField.value = '';
          delete input.dataset.patientName;
          delete input.dataset.fatherName;
        }
      };

      function toggleReceiptScreenshot() {
        const mode = document.getElementById('receipt-mode').value;
        const container = document.getElementById('receipt-screenshot-container');
        if (mode === 'Online') {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
        }
      }

      async function handleReceiptGeneration(e) {
        e.preventDefault();

        const patientIdField = document.getElementById('receipt-patient-id');
        const amountInput = document.getElementById('receipt-amount');
        const modeInput = document.getElementById('receipt-mode');
        const dateInput = document.getElementById('receipt-date');
        const fileInput = document.getElementById('receipt-screenshot-file');

        const patientId = patientIdField.value;
        const selectedDate = dateInput.value;
        const amount = parseInt(amountInput.value, 10);
        const mode = modeInput.value;

        if (!patientId) {
          showSuccessModal('Please choose a patient from the list.', true);
          return;
        }

        if (!amount || amount <= 0) {
          showSuccessModal('Please select a patient and enter a valid amount.', true);
          return;
        }

        if (!selectedDate) {
          showSuccessModal('Please select a receipt date.', true);
          return;
        }

        const patientMeta = receiptPatientOptions.find((opt) => opt.id === patientId);
        if (!patientMeta) {
          showSuccessModal('Selected patient could not be found. Please pick again.', true);
          return;
        }

        // 1. Handle File Upload (if Online)
        let screenshotBase64 = '';
        if (mode === 'Online' && fileInput.files && fileInput.files[0]) {
          try {
            screenshotBase64 = await readFileAsDataURL(fileInput.files[0]);
          } catch (err) {
            console.error('Error reading file', err);
            showSuccessModal('Error processing screenshot image.', true);
            return;
          }
        }

        // 2. Send Update to Backend
        try {
          const res = await fetch(`/api/patients/${patientId}/payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              amount: amount,
              payment_method: mode,
              screenshot: screenshotBase64,
              payment_date: selectedDate,
            }),
          });

          if (res.ok) {
            const data = await res.json();

            // 3. Prepare Receipt Data
            const now = new Date();
            const receiptDate = selectedDate ? new Date(`${selectedDate}T00:00:00`) : now;

            document.getElementById('rcpt-no').innerText = `#${Date.now().toString().slice(-6)}`;
            document.getElementById('rcpt-date').innerText =
              receiptDate.toLocaleDateString('en-PK');
            document.getElementById('rcpt-time').innerText = now.toLocaleTimeString('en-US', {
              hour: '2-digit',
              minute: '2-digit',
            });

            document.getElementById('rcpt-name').innerText = patientMeta.name;
            document.getElementById('rcpt-father').innerText = patientMeta.father || '-';
            document.getElementById('rcpt-amount').innerText = `PKR ${amount.toLocaleString()}`;
            document.getElementById('rcpt-mode-display').innerText = mode;

            // Handle Screenshot Display in Receipt
            const screenshotArea = document.getElementById('rcpt-screenshot-area');
            const screenshotImg = document.getElementById('rcpt-screenshot-img');

            if (mode === 'Online' && screenshotBase64) {
              screenshotImg.src = screenshotBase64;
              screenshotArea.classList.remove('hidden');
            } else {
              screenshotArea.classList.add('hidden');
              screenshotImg.src = '';
            }

            // 4. Close Modal, Reset Form & Refresh Data
            document.getElementById('receipt-modal').classList.add('hidden');
            e.target.reset(); // Reset form inputs including file
            handleReceiptPatientInputChange();
            document.getElementById('receipt-screenshot-container').classList.add('hidden'); // Re-hide upload

            await fetchPatients();

            // 5. Print
            printReceipt();
            showSuccessModal('Payment Recorded & Receipt Generated');
          } else {
            const errorData = await res.json().catch(() => ({}));
            showSuccessModal(errorData.error || 'Error recording payment.', true);
          }
        } catch (e) {
          console.error(e);
          showSuccessModal('Network error.', true);
        }
      }

      function printReceipt() {
        const receiptEl = document.getElementById('printable-receipt');
        const mainContent = document.getElementById('printable-area'); // existing print container

        // Create a temporary print sequence
        // We use the existing print-active logic you have in CSS
        receiptEl.classList.remove('hidden');
        receiptEl.classList.add('print-active');

        // Hide other printables just in case
        if (mainContent) mainContent.classList.remove('print-active');
        document.getElementById('printable-discharge-slip').classList.remove('print-active');

        // Trigger Print
        window.print();

        // Cleanup after print dialog closes (setTimeout is a simple hack for this)
        setTimeout(() => {
          receiptEl.classList.add('hidden');
          receiptEl.classList.remove('print-active');
        }, 1000);
      }

      // --- PAYMENT RECORDS LOGIC ---
      let allPaymentRecords = [];

      async function openPaymentRecordsModal() {
        if (currentUser.role !== 'Admin') {
          showSuccessModal('Access Denied. Admins only.', true);
          return;
        }

        const modal = document.getElementById('payment-records-modal');
        const tbody = document.getElementById('payment-records-body');
        const searchInput = document.getElementById('payment-records-search');

        // Reset search
        if (searchInput) searchInput.value = '';

        // Show loading
        tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400">
          <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
          <p>Loading payment records...</p>
        </td></tr>`;

        modal.classList.remove('hidden');

        try {
          const res = await fetch('/api/payment-records');
          if (res.ok) {
            allPaymentRecords = await res.json();
            renderPaymentRecords(allPaymentRecords);
          } else {
            tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">
              <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
              <p>Error loading payment records.</p>
            </td></tr>`;
          }
        } catch (e) {
          console.error('Error fetching payment records:', e);
          tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <p>Network error. Please try again.</p>
          </td></tr>`;
        }
      }

      function renderPaymentRecords(records) {
        const tbody = document.getElementById('payment-records-body');
        const countEl = document.getElementById('payment-records-count');
        const totalEl = document.getElementById('payment-records-total');

        if (records.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-400">
            <i class="fas fa-inbox text-3xl mb-2"></i>
            <p>No payment records found.</p>
          </td></tr>`;
          countEl.textContent = '0';
          totalEl.textContent = 'PKR 0';
          return;
        }

        let totalAmount = 0;
        let html = '';

        records.forEach((record, index) => {
          totalAmount += record.amount || 0;
          const modeClass =
            record.payment_method === 'Online'
              ? 'bg-purple-100 text-purple-700'
              : 'bg-emerald-100 text-emerald-700';

          const screenshotBtn = record.screenshot
            ? `<button onclick="showPaymentScreenshot('${record._id}')" class="text-[#c9a749] hover:text-[#5c4d1f]" title="View Screenshot">
                <i class="fas fa-image"></i>
               </button>`
            : '<span class="text-gray-300">-</span>';

          html += `
            <tr class="hover:bg-[#fffbf0] transition">
              <td class="px-4 py-3 text-gray-600">${index + 1}</td>
              <td class="px-4 py-3 font-semibold text-gray-800">${escapeHtml(
                record.patient_name
              )}</td>
              <td class="px-4 py-3 font-mono font-bold text-[#c9a749]">${(
                record.amount || 0
              ).toLocaleString()}</td>
              <td class="px-4 py-3 text-gray-600">${formatDate(record.date)}</td>
              <td class="px-4 py-3">
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${modeClass}">${
                  record.payment_method
                }</span>
              </td>
              <td class="px-4 py-3 text-gray-600">${escapeHtml(record.recorded_by)}</td>
              <td class="px-4 py-3 text-center">${screenshotBtn}</td>
            </tr>
          `;
        });

        tbody.innerHTML = html;
        countEl.textContent = records.length;
        totalEl.textContent = `PKR ${totalAmount.toLocaleString()}`;
      }

      function filterPaymentRecords() {
        const searchTerm = document
          .getElementById('payment-records-search')
          .value.toLowerCase()
          .trim();

        if (!searchTerm) {
          renderPaymentRecords(allPaymentRecords);
          return;
        }

        const filtered = allPaymentRecords.filter((record) =>
          record.patient_name.toLowerCase().includes(searchTerm)
        );
        renderPaymentRecords(filtered);
      }

      function showPaymentScreenshot(recordId) {
        const record = allPaymentRecords.find((r) => r._id === recordId);
        if (record && record.screenshot) {
          const previewModal = document.getElementById('screenshot-preview-modal');
          const previewImg = document.getElementById('screenshot-preview-img');
          previewImg.src = record.screenshot;
          previewModal.classList.remove('hidden');
        }
      }

      async function exportPaymentRecords(range) {
        try {
          const res = await fetch(`/api/payment-records/export?range=${range}`);
          if (!res.ok) {
            showSuccessModal('Export failed. Please try again.', true);
            return;
          }

          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download =
            range === 'six_months'
              ? 'payment_records_last_6_months.xlsx'
              : 'payment_records_this_month.xlsx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (e) {
          console.error('Export error', e);
          showSuccessModal('Export failed. Please try again.', true);
        }
      }

      // --- PSYCH SESSIONS ---
      let psychSessions = [];
      let psychNoteSessionId = '';

      async function initPsychSessionsView() {
        const assignCard = document.getElementById('psych-assign-card');
        if (assignCard) assignCard.style.display = currentUser.role === 'Admin' ? 'block' : 'none';

        const start = document.getElementById('psych-filter-start');
        const end = document.getElementById('psych-filter-end');
        const todayIso = new Date().toISOString().split('T')[0];
        if (start && !start.value) start.value = todayIso;
        if (end && !end.value) {
          const plusTwoWeeks = new Date();
          plusTwoWeeks.setDate(plusTwoWeeks.getDate() + 14);
          end.value = plusTwoWeeks.toISOString().split('T')[0];
        }

        const formDate = document.getElementById('psych-session-date');
        if (formDate && !formDate.value) formDate.value = todayIso;

        if (currentUser.role === 'Admin') {
          await populatePsychologists();
          await populatePsychPatients();
        }

        loadPsychSessions();
      }

      async function populatePsychologists() {
        const select = document.getElementById('psych-session-psychologist');
        if (!select) return;
        try {
          const res = await fetch('/api/users');
          if (!res.ok) throw new Error('user fetch failed');
          const users = await res.json();
          const psychs = users.filter((u) => u.role === 'Psychologist');
          select.innerHTML = psychs
            .map((u) => `<option value="${u._id}">${u.name || u.username}</option>`)
            .join('');
        } catch (e) {
          console.error('Psychologist load error', e);
          select.innerHTML = '<option value="">No psychologists found</option>';
        }
      }

      async function populatePsychPatients() {
        const select = document.getElementById('psych-session-patients');
        if (!select) return;
        if (patientsData.length === 0) await fetchPatients();
        const active = patientsData.filter((p) => !p.isDischarged);
        select.innerHTML = active
          .map((p) => `<option value="${p._id || p.id}">${escapeHtml(p.name)}</option>`)
          .join('');
      }

      async function loadPsychSessions() {
        const start = document.getElementById('psych-filter-start')?.value;
        const end = document.getElementById('psych-filter-end')?.value;
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);

        try {
          const res = await fetch(`/api/psych-sessions?${params.toString()}`);
          if (!res.ok) throw new Error('fetch failed');
          psychSessions = await res.json();
          renderPsychSessions();
        } catch (e) {
          console.error('Load psych sessions error', e);
          const tbody = document.getElementById('psych-sessions-body');
          if (tbody)
            tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-500">Unable to load sessions.</td></tr>`;
        }
      }

      function renderPsychSessions() {
        const tbody = document.getElementById('psych-sessions-body');
        if (!tbody) return;

        if (!psychSessions || psychSessions.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-400">No sessions found.</td></tr>`;
          return;
        }

        const canAddNote = ['Psychologist', 'Admin'].includes(currentUser.role);
        const isAdmin = currentUser.role === 'Admin';

        tbody.innerHTML = psychSessions
          .map((s) => {
            const patients = (s.patient_names || []).join(', ');
            const detail = s.note_detail || {};
            const noteStatus = s.note
              ? `<div class="text-emerald-700 font-semibold">Saved</div>
                 <div class="text-xs text-gray-600">Issue: ${escapeHtml(detail.issue || '')}</div>
                 <div class="text-xs text-gray-600">Intervention: ${escapeHtml(
                   detail.intervention || ''
                 )}</div>
                 <div class="text-xs text-gray-600">Response: ${escapeHtml(
                   detail.response || ''
                 )}</div>
                 <div class="text-[11px] text-gray-400">by ${escapeHtml(
                   s.note_author || 'Unknown'
                 )}</div>`
              : '<span class="text-amber-600 font-semibold">Pending</span>';

            const actionBtn = s.note
              ? isAdmin
                ? `<button class="text-blue-600 hover:text-blue-800 font-semibold" onclick="openPsychNoteModal('${s._id}', true)">Edit Note</button>`
                : '<span class="text-gray-400 text-sm">Locked</span>'
              : canAddNote
                ? `<button class="text-emerald-700 hover:text-[#5c4d1f] font-semibold" onclick="openPsychNoteModal('${s._id}')">Add Note</button>`
                : '-';

            return `
              <tr class="hover:bg-[#fffbf0]">
                <td class="px-3 py-2">${s.date || ''}</td>
                <td class="px-3 py-2">${s.time_slot || ''}</td>
                <td class="px-3 py-2">${escapeHtml(
                  s.psychologist_name || s.psychologist_id || ''
                )}</td>
                <td class="px-3 py-2">${patients}</td>
                <td class="px-3 py-2">${escapeHtml(s.title || '')}</td>
                <td class="px-3 py-2">${noteStatus}</td>
                <td class="px-3 py-2 text-center">${actionBtn}</td>
              </tr>`;
          })
          .join('');
      }

      async function submitPsychSession(e) {
        e.preventDefault();
        const psychId = document.getElementById('psych-session-psychologist')?.value;
        const dateVal = document.getElementById('psych-session-date')?.value;
        const timeVal = document.getElementById('psych-session-time')?.value;
        const titleVal = document.getElementById('psych-session-title')?.value || '';
        const patientSelect = document.getElementById('psych-session-patients');
        const patientIds = patientSelect
          ? Array.from(patientSelect.selectedOptions).map((o) => o.value)
          : [];

        if (!psychId || !dateVal || patientIds.length === 0) {
          showSuccessModal('Please select psychologist, date, and at least one patient.', true);
          return;
        }

        try {
          const res = await fetch('/api/psych-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              psychologist_id: psychId,
              date: dateVal,
              time_slot: timeVal,
              patient_ids: patientIds,
              title: titleVal,
            }),
          });
          if (!res.ok) throw new Error('save failed');
          showSuccessModal('Session saved');
          loadPsychSessions();
          document.getElementById('psych-session-form').reset();
          const todayIso = new Date().toISOString().split('T')[0];
          document.getElementById('psych-session-date').value = todayIso;
        } catch (err) {
          console.error(err);
          showSuccessModal('Could not save session.', true);
        }
      }

      function openPsychNoteModal(sessionId, isEdit = false) {
        psychNoteSessionId = sessionId;
        const modal = document.getElementById('psych-note-modal');
        const session = psychSessions.find((s) => s._id === sessionId) || {};
        const dateField = document.getElementById('psych-note-date');
        const issueField = document.getElementById('psych-note-issue');
        const intField = document.getElementById('psych-note-intervention');
        const respField = document.getElementById('psych-note-response');

        if (dateField) dateField.value = session.date || new Date().toISOString().split('T')[0];

        // If editing, populate fields with existing note data
        if (isEdit && session.note_detail) {
          if (issueField) issueField.value = session.note_detail.issue || '';
          if (intField) intField.value = session.note_detail.intervention || '';
          if (respField) respField.value = session.note_detail.response || '';
        } else {
          if (issueField) issueField.value = '';
          if (intField) intField.value = '';
          if (respField) respField.value = '';
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function closePsychNoteModal() {
        const modal = document.getElementById('psych-note-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        psychNoteSessionId = '';
      }

      async function savePsychNote() {
        const issue = document.getElementById('psych-note-issue')?.value.trim();
        const intervention = document.getElementById('psych-note-intervention')?.value.trim();
        const response = document.getElementById('psych-note-response')?.value.trim();
        if (!psychNoteSessionId || !issue || !intervention || !response) {
          showSuccessModal('Please fill all fields.', true);
          return;
        }

        try {
          const res = await fetch(`/api/psych-sessions/${psychNoteSessionId}/note`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ issue, intervention, response }),
          });
          if (!res.ok) {
            showSuccessModal('Could not save note.', true);
            return;
          }
          closePsychNoteModal();
          loadPsychSessions();
          showSuccessModal('Note saved');
        } catch (e) {
          console.error('Save note error', e);
          showSuccessModal('Could not save note.', true);
        }
      }

      function formatDate(dateStr) {
        if (!dateStr || dateStr === 'N/A') return 'N/A';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-PK', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
          });
        } catch (e) {
          return dateStr;
        }
      }

      // --- DAILY REPORT LOGIC (12-Hour 8-8 Split & Fully Editable) ---

      // 1. Define the 12-hour slots for Day (08:00 AM - 07:00 PM)
      const DAY_COLUMN_ORDER = [
        'slot_0800',
        'slot_0900',
        'slot_1000',
        'slot_1100',
        'slot_1200',
        'slot_1300',
        'slot_1400',
        'slot_1500',
        'slot_1600',
        'slot_1700',
        'slot_1800',
        'slot_1900',
      ];

      // 2. Define the 12-hour slots for Night (08:00 PM - 07:00 AM)
      const NIGHT_COLUMN_ORDER = [
        'slot_2000',
        'slot_2100',
        'slot_2200',
        'slot_2300',
        'slot_0000',
        'slot_0100',
        'slot_0200',
        'slot_0300',
        'slot_0400',
        'slot_0500',
        'slot_0600',
        'slot_0700',
      ];

      // 3. Define Default Labels (Time + Activity).
      // These appear if no custom config is saved, and are fully editable.
      const DEFAULT_DAY_CONFIG = [
        { key: 'slot_0800', label: '08:00 AM Breakfast' },
        { key: 'slot_0900', label: '09:00 AM Quran/Yoga' },
        { key: 'slot_1000', label: '10:00 AM Dr. Round' },
        { key: 'slot_1100', label: '11:00 AM Group Therapy' },
        { key: 'slot_1200', label: '12:00 PM Group Therapy' },
        { key: 'slot_1300', label: '01:00 PM Namaz' },
        { key: 'slot_1400', label: '02:00 PM Lunch' },
        { key: 'slot_1500', label: '03:00 PM Dr. Round' },
        { key: 'slot_1600', label: '04:00 PM TV Time' },
        { key: 'slot_1700', label: '05:00 PM Namaz' },
        { key: 'slot_1800', label: '06:00 PM Group Therapy' },
        { key: 'slot_1900', label: '07:00 PM Namaz' },
      ];

      const DEFAULT_NIGHT_CONFIG = [
        { key: 'slot_2000', label: '08:00 PM Dinner' },
        { key: 'slot_2100', label: '09:00 PM Meds/Namaz' },
        { key: 'slot_2200', label: '10:00 PM Sleep' },
        { key: 'slot_2300', label: '11:00 PM' },
        { key: 'slot_0000', label: '12:00 AM' },
        { key: 'slot_0100', label: '01:00 AM' },
        { key: 'slot_0200', label: '02:00 AM' },
        { key: 'slot_0300', label: '03:00 AM' },
        { key: 'slot_0400', label: '04:00 AM' },
        { key: 'slot_0500', label: '05:00 AM' },
        { key: 'slot_0600', label: '06:00 AM' },
        { key: 'slot_0700', label: '07:00 AM' },
      ];

      let DAY_CONFIG = [...DEFAULT_DAY_CONFIG];
      let NIGHT_CONFIG = [...DEFAULT_NIGHT_CONFIG];

      const escapeHtml = (str = '') =>
        String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      // Helper to sort columns
      const orderColumns = (columns, desiredOrder) => {
        if (!Array.isArray(columns)) return [];
        const columnMap = new Map(columns.map((col) => [col.key, col]));
        const ordered = [];
        desiredOrder.forEach((key) => {
          if (columnMap.has(key)) {
            ordered.push(columnMap.get(key));
            columnMap.delete(key);
          }
        });
        // Append any leftovers (e.g. from old configs) at the end
        return [...ordered, ...columnMap.values()];
      };

      // Helper to merge saved config with defaults
      const mergeWithDefaults = (columns, defaults, order) => {
        const baseMap = new Map(defaults.map((col) => [col.key, { ...col }]));
        if (Array.isArray(columns)) {
          columns.forEach((col) => {
            // If the key exists in our new 12-hour layout, update its label from DB.
            // If it's an old key (like slot_bkfst), it gets added to the map.
            if (baseMap.has(col.key)) {
              baseMap.set(col.key, { ...baseMap.get(col.key), label: col.label });
            } else {
              baseMap.set(col.key, col);
            }
          });
        }
        return orderColumns(Array.from(baseMap.values()), order);
      };

      async function loadDailyReport() {
        const datePicker = document.getElementById('report-date-picker');
        if (!datePicker || !datePicker.value) return;
        const date = datePicker.value;

        // Show Save Button only for Admins
        if (currentUser.role === 'Admin') {
          document.getElementById('btn-save-layout').classList.remove('hidden');
        }

        // 1. Fetch Layout Config
        try {
          const configRes = await fetch('/api/reports/config');
          if (configRes.ok) {
            const config = await configRes.json();
            DAY_CONFIG = mergeWithDefaults(
              config.day_columns,
              DEFAULT_DAY_CONFIG,
              DAY_COLUMN_ORDER
            );
            NIGHT_CONFIG = mergeWithDefaults(
              config.night_columns,
              DEFAULT_NIGHT_CONFIG,
              NIGHT_COLUMN_ORDER
            );
          } else {
            DAY_CONFIG = mergeWithDefaults(undefined, DEFAULT_DAY_CONFIG, DAY_COLUMN_ORDER);
            NIGHT_CONFIG = mergeWithDefaults(undefined, DEFAULT_NIGHT_CONFIG, NIGHT_COLUMN_ORDER);
          }
        } catch (e) {
          console.error('Config load error, using defaults', e);
          DAY_CONFIG = mergeWithDefaults(undefined, DEFAULT_DAY_CONFIG, DAY_COLUMN_ORDER);
          NIGHT_CONFIG = mergeWithDefaults(undefined, DEFAULT_NIGHT_CONFIG, NIGHT_COLUMN_ORDER);
        }

        // Clean up: Filter out old legacy keys if you want a strictly clean table
        // (Optional: this line removes columns that aren't in our new 12-hour definition)
        DAY_CONFIG = DAY_CONFIG.filter((c) => DAY_COLUMN_ORDER.includes(c.key));
        NIGHT_CONFIG = NIGHT_CONFIG.filter((c) => NIGHT_COLUMN_ORDER.includes(c.key));

        // 2. Fetch Active Patients
        if (typeof patientsData === 'undefined' || patientsData.length === 0) await fetchPatients();
        const activePatients = patientsData.filter((p) => !p.isDischarged);

        // 3. Fetch Status Data
        let reportData = [];
        try {
          const res = await fetch(`/api/reports?date=${date}`);
          if (res.ok) reportData = await res.json();
        } catch (e) {
          console.error('Data load error', e);
        }

        const reportMap = {};
        reportData.forEach((r) => {
          reportMap[r.patient_id] = r.schedule || {};
        });

        // 4. Render Both Tables
        renderSplitTable('day', DAY_CONFIG, activePatients, reportMap);
        renderSplitTable('night', NIGHT_CONFIG, activePatients, reportMap);
      }

      // Toggle Status: Day -> Empty -> Done -> Not Done -> Complaint -> Empty
      // Night -> Empty -> Done -> Not Done -> Med -> WC -> Empty
      window.cycleReportStatus = async function (
        btnElement,
        patientId,
        timeSlot,
        currentStatus,
        reportType
      ) {
        let nextStatus = 'done';

        // Determine which cycle to use based on report type
        if (reportType === 'night') {
          // Night report cycle: Empty -> Done -> Not Done -> Med -> W -> Empty
          if (currentStatus === 'done') nextStatus = 'not_done';
          else if (currentStatus === 'not_done') nextStatus = 'med';
          else if (currentStatus === 'med') nextStatus = 'wc';
          else if (currentStatus === 'wc') nextStatus = '';
        } else {
          // Day report cycle: Empty -> Done -> Not Done -> Complaint -> Empty
          if (currentStatus === 'done') nextStatus = 'not_done';
          else if (currentStatus === 'not_done') nextStatus = 'complaint';
          else if (currentStatus === 'complaint') nextStatus = '';
        }

        // Optimistic UI Update
        btnElement.className = `w-full h-6 rounded flex items-center justify-center transition-all text-xs ${getStatusClass(
          nextStatus
        )}`;
        btnElement.innerHTML = getStatusIcon(nextStatus);
        btnElement.dataset.status = nextStatus || '';
        btnElement.setAttribute('aria-label', statusLabelMap[nextStatus] || 'No Status');
        btnElement.setAttribute(
          'onclick',
          `cycleReportStatus(this, '${patientId}', '${timeSlot}', '${nextStatus}', '${reportType}')`
        );

        // Send to Backend
        const datePicker = document.getElementById('report-date-picker');
        const date = datePicker ? datePicker.value : new Date().toISOString().split('T')[0];

        try {
          await fetch('/api/reports/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              date: date,
              patient_id: patientId,
              time_slot: timeSlot,
              status: nextStatus,
            }),
          });
        } catch (e) {
          console.error('Network error updating status', e);
        }
      };

      const statusLabelMap = {
        done: 'Done',
        not_done: 'Not Done',
        complaint: 'Emergency / Complaint',
        med: 'Medicine',
        wc: 'Washroom',
        '': 'No Status',
        null: 'No Status',
        undefined: 'No Status',
      };

      const printableSymbolMap = {
        done: '',
        not_done: '',
        complaint: '!',
        med: 'Med',
        wc: 'WC',
      };

      function renderSplitTable(type, columns, patients, reportMap) {
        const headerRow = document.getElementById(`${type}-header-row`);
        const tbody = document.getElementById(`${type}-table-body`);
        const isAdmin = currentUser.role === 'Admin';

        // Build Headers
        const headerBaseClasses =
          type === 'day'
            ? 'px-2 py-2 text-left whitespace-nowrap sticky left-0 z-20 shadow-md bg-[#c9a749] text-white'
            : 'px-2 py-2 text-left whitespace-nowrap sticky left-0 z-20 shadow-md bg-indigo-900 text-white';

        let headersHtml = `<th id="${type}-patient-header" class="${headerBaseClasses}" style="min-width: 100px; max-width: 140px;">
                           <span class="patient-header-label font-semibold tracking-wide text-xs">Patient</span>
                         </th>`;

        columns.forEach((col, index) => {
          // *** EDITABLE HEADER LOGIC ***
          // We set contenteditable="true" for ALL columns if user is Admin.
          const isEditable = isAdmin;
          const editableAttr = isEditable ? 'contenteditable="true"' : '';
          const blurAttr = isEditable ? 'onblur="markLayoutDirty()"' : '';
          const cursorClass = isEditable ? 'cursor-text hover:bg-white/10' : 'cursor-default';
          const titleAttr = `title="${escapeHtml(col.label || '')}"`;

          // Render simple text inside the header so it's easily editable
          const headerContent = `<span class="text-[0.6rem] leading-tight block whitespace-pre-wrap">${escapeHtml(
            col.label || ''
          )}</span>`;

          headersHtml += `<th ${editableAttr} data-idx="${index}" ${titleAttr} ${blurAttr}
                        class="px-1 py-2 text-center align-middle whitespace-normal min-w-[50px] max-w-[70px] border-l border-white/20 ${cursorClass}">
                        ${headerContent}
                    </th>`;
        });
        headerRow.innerHTML = headersHtml;

        // Build Rows
        tbody.innerHTML = '';
        if (patients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="${
            columns.length + 1
          }" class="p-6 text-center text-gray-400">No active patients.</td></tr>`;
          return;
        }

        if (!window.reportTableState[type]) {
          window.reportTableState[type] = { showAll: false };
        }
        const showAllNormal = window.reportTableState[type].showAll;
        const flaggedRows = [];
        const normalRows = [];

        patients.forEach((p) => {
          const pId = p._id || p.id;
          const schedules = reportMap[pId] || {};
          let hasIssue = false;

          const rowBaseClasses =
            type === 'day'
              ? 'px-2 py-1 font-bold text-[#5c4d1f] bg-[#fffbf0]'
              : 'px-2 py-1 font-bold text-indigo-900 bg-indigo-50';

          let rowHtml = `<td class="${rowBaseClasses} sticky left-0 border-r z-20 whitespace-nowrap text-[0.65rem] max-w-[140px]" style="min-width: 100px;">
                         <span class="block truncate" title="${escapeHtml(p.name)}">${escapeHtml(
                           p.name
                         )}</span>
                       </td>`;

          columns.forEach((col) => {
            const status = schedules[col.key];
            if (status === 'complaint') hasIssue = true;
            const cellClass = getStatusClass(status);
            const icon = getStatusIcon(status);
            const statusLabel = statusLabelMap[status] || 'No Status';

            rowHtml += `
            <td class="p-0.5 border text-center align-middle">
              <button onclick="cycleReportStatus(this, '${pId}', '${col.key}', '${status || ''}', '${type}')" 
                      class="w-full h-6 rounded flex items-center justify-center transition-all text-xs ${cellClass}"
                      data-status="${status || ''}"
                      data-patient="${pId}"
                      data-slot="${col.key}"
                      aria-label="${statusLabel}">
                ${icon}
              </button>
            </td>`;
          });

          const tr = document.createElement('tr');
          tr.innerHTML = rowHtml;
          tr.className = 'hover:bg-gray-50 transition';

          if (hasIssue) {
            tr.classList.add('bg-rose-50');
            flaggedRows.push(tr);
          } else {
            tr.classList.add('report-normal-row', `report-normal-row-${type}`);
            if (!showAllNormal) tr.classList.add('hidden');
            normalRows.push(tr);
          }
        });

        const fragment = document.createDocumentFragment();

        // Logic to show "All on track" message or toggle button
        if (flaggedRows.length === 0 && normalRows.length > 0) {
          const infoRow = document.createElement('tr');
          infoRow.innerHTML = `<td colspan="${
            columns.length + 1
          }" class="px-4 py-4 text-center text-sm text-[#5c4d1f] bg-[#fffbf0] font-semibold">All patients are currently on track.</td>`;
          fragment.appendChild(infoRow);
        }

        flaggedRows.forEach((row) => fragment.appendChild(row));

        if (normalRows.length > 0) {
          const toggleRow = document.createElement('tr');
          const toggleCell = document.createElement('td');
          toggleCell.colSpan = columns.length + 1;
          toggleCell.className = 'bg-amber-50 text-center py-3';
          const toggleBtn = document.createElement('button');
          toggleBtn.type = 'button';
          toggleBtn.id = `report-toggle-btn-${type}`;
          toggleBtn.dataset.count = normalRows.length;
          toggleBtn.className =
            'inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-full border border-amber-300 bg-white text-amber-700 shadow-sm hover:bg-amber-100 transition';
          toggleBtn.setAttribute('onclick', `toggleReportRows('${type}')`);
          toggleBtn.innerHTML = showAllNormal
            ? '<i class="fas fa-eye-slash"></i> Hide On-Track Patients'
            : `<i class="fas fa-eye"></i> Show ${normalRows.length} On-Track Patients`;
          toggleCell.appendChild(toggleBtn);
          toggleRow.appendChild(toggleCell);
          fragment.appendChild(toggleRow);

          normalRows.forEach((row) => fragment.appendChild(row));
        }

        if (flaggedRows.length === 0 && normalRows.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `<td colspan="${
            columns.length + 1
          }" class="p-6 text-center text-gray-400">No active patients.</td>`;
          fragment.appendChild(emptyRow);
        }

        tbody.appendChild(fragment);
        attachReportScrollHandler(type);
      }

      const attachReportScrollHandler = (type) => {
        const container = document.querySelector(`#${type}-report-container .overflow-x-auto`);
        if (!container) return;
        if (!container.dataset.scrollWatcherAttached) {
          container.addEventListener('scroll', () => updateReportHeaderVisibility(type, container));
          container.dataset.scrollWatcherAttached = 'true';
        }
        updateReportHeaderVisibility(type, container);
      };

      const updateReportHeaderVisibility = (type, container) => {
        const headerCell = document.getElementById(`${type}-patient-header`);
        if (!headerCell) return;
        const label = headerCell.querySelector('.patient-header-label');
        // Simple fade effect on scroll for the "Patient" label
        const isScrolled = container.scrollLeft > 0;
        if (label) label.style.opacity = isScrolled ? '0' : '1';
      };

      window.toggleReportRows = function (type) {
        if (!window.reportTableState || !window.reportTableState[type]) return;
        const state = window.reportTableState[type];
        state.showAll = !state.showAll;

        const rows = document.querySelectorAll(`.report-normal-row-${type}`);
        rows.forEach((row) => {
          if (state.showAll) row.classList.remove('hidden');
          else row.classList.add('hidden');
        });

        const btn = document.getElementById(`report-toggle-btn-${type}`);
        if (btn) {
          const count = btn.dataset.count || rows.length || 0;
          btn.innerHTML = state.showAll
            ? '<i class="fas fa-eye-slash"></i> Hide On-Track Patients'
            : `<i class="fas fa-eye"></i> Show ${count} On-Track Patients`;
        }
      };

      function markLayoutDirty() {
        const btn = document.getElementById('btn-save-layout');
        btn.classList.add('bg-yellow-500', 'animate-pulse');
        btn.classList.remove('bg-gray-800');
      }

      async function saveLayoutConfig() {
        const scrapeHeaders = (id) => {
          const ths = document.querySelectorAll(`#${id}-header-row th[data-idx]`);
          const newCols = [];
          ths.forEach((th) => {
            const idx = th.getAttribute('data-idx');
            // Retrieve the original key based on index to maintain backend data mapping
            const originalKey = id === 'day' ? DAY_CONFIG[idx].key : NIGHT_CONFIG[idx].key;
            // Capture the new text entered by the user
            newCols.push({ key: originalKey, label: th.innerText.trim() });
          });
          return newCols;
        };

        const newDayConfig = scrapeHeaders('day');
        const newNightConfig = scrapeHeaders('night');

        try {
          const res = await fetch('/api/reports/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ day_columns: newDayConfig, night_columns: newNightConfig }),
          });

          if (res.ok) {
            showSuccessModal('Layout Saved');
            const btn = document.getElementById('btn-save-layout');
            btn.classList.remove('bg-yellow-500', 'animate-pulse');
            btn.classList.add('bg-gray-800');
            // Update local state
            DAY_CONFIG = newDayConfig;
            NIGHT_CONFIG = newNightConfig;
          }
        } catch (e) {
          showSuccessModal('Error saving layout', true);
        }
      }

      // --- Print Logic ---
      window.printReport = function (mode) {
        const printableHTML = generatePrintableReport(mode);
        const printWindow = window.open('', '', 'width=1200,height=800');
        if (!printWindow) {
          alert('Please allow pop-ups to print the report.');
          return;
        }

        printWindow.document.write(printableHTML);
        printWindow.document.close();
        printWindow.focus();
        printWindow.addEventListener('load', () => {
          printWindow.print();
          setTimeout(() => {
            printWindow.close();
          }, 200);
        });
      };

      function generatePrintableReport(mode) {
        const styles = `
          <style>
            @page { size: landscape; margin: 15mm; }
            body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 24px; color: #0f172a; }
            header { text-align: center; margin-bottom: 24px; }
            header h1 { margin: 0 0 6px 0; font-size: 26px; letter-spacing: 0.5px; }
            header p { margin: 2px 0; color: #4b5563; font-size: 13px; }
            .report-meta { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 16px; color: #4b5563; }
            .report-section { margin-bottom: 28px; }
            .report-section h2 { margin-bottom: 12px; font-size: 18px; color: #065f46; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #9ca3af; padding: 6px 8px; }
            th { background: #0f3c2d; color: white; text-align: center; }
            td { text-align: center; }
            td.patient-col { text-align: left; font-weight: 600; width: 220px; }
            tr:nth-child(even) td { background: #f8f9fb; }
            .legend { font-size: 11px; color: #4b5563; margin-top: 8px; }
            .no-data { font-size: 12px; color: #6b7280; font-style: italic; }
            .page-break { page-break-before: always; }
          </style>
        `;

        const datePicker = document.getElementById('report-date-picker');
        const selectedDate =
          datePicker && datePicker.value ? new Date(`${datePicker.value}T00:00:00`) : new Date();
        const generatedAt = new Date().toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
        });
        const reportDate = formatPrintableDate(selectedDate);

        const sections = [];
        if (mode === 'day' || mode === 'both') {
          sections.push(buildPrintableSection('Day Report', 'day'));
        }
        if (mode === 'night' || mode === 'both') {
          sections.push(buildPrintableSection('Night Report', 'night'));
        }

        if (!sections.length) {
          sections.push('<p>No report data available for printing.</p>');
        }

        const sectionsHtml = sections.join('<div class="page-break"></div>');

        const legend = `
          <div class="legend">
            <strong>Status Legend:</strong> Leave blank if no update. Use  for Done,  for Not Done, ! for Emergency / Complaint.
          </div>
        `;

        return `<!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>Rooh Daily Report</title>
              ${styles}
            </head>
            <body>
              <header>
                <h1>Rooh</h1>
                <p>Daily Patient Activity Report</p>
              </header>
              <div class="report-meta">
                <span>Date: ${reportDate}</span>
                <span>Generated: ${generatedAt}</span>
              </div>
              ${sectionsHtml}
              ${legend}
            </body>
          </html>`;
      }

      function buildPrintableSection(title, type) {
        const table = buildPrintableTable(type);
        return `<section class="report-section"><h2>${title}</h2>${table}</section>`;
      }

      function buildPrintableTable(type) {
        const headerRow = document.getElementById(`${type}-header-row`);
        const bodyRows = document.querySelectorAll(`#${type}-table-body tr`);
        if (!headerRow || !headerRow.children.length) {
          return '<p class="no-data">No columns configured for this report.</p>';
        }
        if (!bodyRows.length) {
          return '<p class="no-data">No active patients for this report.</p>';
        }

        const sanitize = (text) => (text || '').replace(/\s+/g, ' ').trim();

        const headers = Array.from(headerRow.children)
          .map(
            (th, idx) =>
              `<th class="${idx === 0 ? 'patient-col' : ''}">${sanitize(th.textContent)}</th>`
          )
          .join('');

        const rows = Array.from(bodyRows)
          .map((tr) => {
            const cells = Array.from(tr.children)
              .map((td, idx) => {
                if (idx === 0) {
                  return `<td class="patient-col">${sanitize(td.textContent)}</td>`;
                }
                const btn = td.querySelector('button');
                const status = btn ? btn.dataset.status || '' : '';
                const symbol = printableSymbolMap[status] || '';
                const aria = statusLabelMap[status] || '';
                return `<td>${symbol ? `<span aria-label="${aria}">${symbol}</span>` : ''}</td>`;
              })
              .join('');
            return `<tr>${cells}</tr>`;
          })
          .join('');

        return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
      }

      function formatPrintableDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '-';
        return date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      }

      // Helper functions (keep existing ones or ensure they are here)
      function getStatusClass(status) {
        if (status === 'done') return 'bg-[#fffbf0] hover:bg-green-200 border border-[#b8941f]';
        if (status === 'not_done') return 'bg-red-100 hover:bg-red-200 border border-red-300';
        if (status === 'complaint')
          return 'bg-yellow-100 hover:bg-yellow-200 border border-yellow-300';
        if (status === 'med') return 'bg-blue-100 hover:bg-blue-200 border border-blue-300';
        if (status === 'wc') return 'bg-purple-100 hover:bg-purple-200 border border-purple-300';
        return 'bg-gray-50 hover:bg-gray-100 border border-gray-100';
      }

      function getStatusIcon(status) {
        if (status === 'done') return '<i class="fas fa-check text-[#c9a749] text-sm"></i>';
        if (status === 'not_done') return '<i class="fas fa-times text-red-600 text-sm"></i>';
        if (status === 'complaint')
          return '<i class="fas fa-exclamation text-yellow-600 text-sm"></i>';
        if (status === 'med') return '<span class="text-blue-600 text-xs font-bold">Med</span>';
        if (status === 'wc') return '<span class="text-purple-600 text-xs font-bold">WC</span>';
        return '<span class="text-gray-200 text-xs"></span>';
      }

      // --- EMERGENCY SECTION LOGIC ---
      async function loadEmergencyAlerts() {
        try {
          const res = await fetch('/api/emergency');
          if (!res.ok) return;
          const alerts = await res.json();
          const container = document.getElementById('emergency-list');
          if (!container) return; // Guard clause

          container.innerHTML = '';
          if (alerts.length === 0) {
            container.innerHTML =
              '<div class="col-span-full text-center text-gray-400 py-2">No active alerts.</div>';
            return;
          }

          alerts.forEach((a) => {
            const color =
              a.severity === 'critical'
                ? 'bg-red-100 border-red-300 text-red-800'
                : 'bg-orange-100 border-orange-300 text-orange-800';
            const icon =
              a.severity === 'critical' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';

            container.innerHTML += `
                <div class="${color} border rounded p-3 shadow-sm relative animate-pulse-slow">
                    <button onclick="resolveEmergencyAlert('${a._id}')" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800" title="Resolve"><i class="fas fa-check"></i></button>
                    <div class="font-bold text-sm"><i class="fas ${icon}"></i> ${a.patient_name}</div>
                    <div class="text-sm mt-1">${a.note}</div>
                    <div class="text-xs mt-2 opacity-75">By ${a.added_by} at ${a.date}</div>
                </div>
            `;
          });
        } catch (e) {
          console.error(e);
        }
      }

      // --- NEW EMERGENCY LOGIC ---

      // 1. Function to open modal and load patients
      async function openEmergencyModal() {
        const modal = document.getElementById('emergency-modal');
        const select = document.getElementById('emer-name');

        modal.classList.remove('hidden');
        select.innerHTML = '<option value="">Loading...</option>';

        try {
          // Reuse existing patients data if available, otherwise fetch
          if (patientsData.length === 0) await fetchPatients();

          const active = patientsData.filter((p) => !p.isDischarged);

          if (active.length === 0) {
            select.innerHTML = '<option value="">No active patients found</option>';
            return;
          }

          select.innerHTML = active
            .sort((a, b) => a.name.localeCompare(b.name))
            .map(
              (p) => `<option value="${p.name}">${p.name} (Father: ${p.fatherName || '-'})</option>`
            )
            .join('');
        } catch (e) {
          console.error('Error loading patients for emergency:', e);
          select.innerHTML = '<option value="">Error loading list</option>';
        }
      }

      // 2. Fixed Save Function
      async function addEmergencyAlert(e) {
        e.preventDefault();

        const nameSelect = document.getElementById('emer-name');
        const noteInput = document.getElementById('emer-note');
        const severityInput = document.getElementById('emer-severity');

        // Validation
        if (!nameSelect.value) {
          showSuccessModal('Please select a patient.', true);
          return;
        }

        const payload = {
          patient_name: nameSelect.value, // Sends the name string
          note: noteInput.value,
          severity: severityInput.value,
        };

        try {
          const res = await fetch('/api/emergency', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            document.getElementById('emergency-modal').classList.add('hidden');
            // Clear form
            noteInput.value = '';

            // Reload alerts immediately
            await loadEmergencyAlerts();
            showSuccessModal('Emergency Alert Posted');
          } else {
            const err = await res.json();
            showSuccessModal('Error: ' + (err.error || 'Could not save'), true);
          }
        } catch (error) {
          console.error('Save alert error:', error);
          showSuccessModal('Network error. Please try again.', true);
        }
      }
      async function resolveEmergencyAlert(id) {
        if (!(await showConfirmModal('Mark this alert as resolved?'))) return;
        await fetch(`/api/emergency/${id}`, { method: 'DELETE' });
        loadEmergencyAlerts();
      }

      // Hook into dashboard update
      const originalUpdateDashboard = window.updateDashboard;
      window.updateDashboard = async function () {
        if (originalUpdateDashboard) await originalUpdateDashboard();
        await loadEmergencyAlerts(); // Load alerts when dashboard opens
      };
      // --- PRESCRIPTION LOGIC (START) ---
      let prescriptionOptions = [];

      // 1. Open Modal & Initialize
      async function openPrescriptionModal() {
        const modal = document.getElementById('prescription-modal');
        const list = document.getElementById('prescription-patient-list');
        const input = document.getElementById('prescription-patient-input');

        // Reset the form fields
        document.getElementById('prescription-form').reset();

        // Clear previous medication rows
        document.getElementById('medication-rows-container').innerHTML = '';
        list.innerHTML = '';

        // Add one empty row by default so the user has somewhere to type immediately
        addMedicationRow();

        modal.classList.remove('hidden');

        // Load Patients for the Searchable Dropdown
        try {
          // Only fetch if not already loaded
          if (!patientsData || patientsData.length === 0) {
            await fetchPatients();
          }

          // Filter for active patients only
          prescriptionOptions = patientsData
            .filter((p) => !p.isDischarged)
            .map((p) => ({
              id: p._id || p.id,
              name: p.name,
              age: p.age || '',
              father: p.fatherName || '',
            }));

          if (prescriptionOptions.length === 0) {
            input.placeholder = 'No active patients. Type name manually.';
          } else {
            input.placeholder = 'Search or type new name...';
            list.innerHTML = prescriptionOptions
              .map(
                (p) =>
                  `<option value="${escapeHtml(p.name)}">Father: ${escapeHtml(p.father)} | Age: ${
                    p.age
                  }</option>`
              )
              .join('');
          }
        } catch (e) {
          console.error('Error loading prescription patients', e);
        }
      }

      // 2. Auto-fill Age if Name Matches an Existing Patient
      function handlePrescriptionInput() {
        const input = document.getElementById('prescription-patient-input');
        const ageInput = document.getElementById('prescription-patient-age');
        const val = input.value;

        // Find matching patient object
        const match = prescriptionOptions.find((p) => p.name === val);

        if (match) {
          ageInput.value = match.age;
        }
        // If no match, we keep whatever the user typed (allows new patients)
      }

      // 3. Add a New Medicine Row (Inputs)
      function addMedicationRow() {
        const container = document.getElementById('medication-rows-container');
        const rowId = Date.now(); // Unique ID for delete button
        const div = document.createElement('div');

        // *** CRITICAL CLASS 'med-row' ADDED HERE ***
        div.className = 'grid grid-cols-12 gap-2 mb-2 items-start med-row';
        div.id = `med-row-${rowId}`;

        div.innerHTML = `
        <div class="col-span-4">
          <input class="med-name w-full border p-2 rounded text-sm" placeholder="Medicine Name">
        </div>
        <div class="col-span-3">
          <input class="med-dosage w-full border p-2 rounded text-sm" placeholder="Dosage (e.g. 1+0+1)">
        </div>
        <div class="col-span-2">
          <input class="med-freq w-full border p-2 rounded text-sm" placeholder="Days">
        </div>
        <div class="col-span-2">
          <input class="med-instr w-full border p-2 rounded text-sm" placeholder="Instruction">
        </div>
        <div class="col-span-1 text-center pt-1">
          <button type="button" onclick="document.getElementById('med-row-${rowId}').remove()" class="text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
        container.appendChild(div);
      }

      // 4. Generate Data & Trigger Print
      function handlePrescriptionGeneration(e) {
        e.preventDefault();

        // --- A. Capture Static Values ---
        const name = document.getElementById('prescription-patient-input').value || '';
        const age = document.getElementById('prescription-patient-age').value || '';
        const diagnosis = document.getElementById('prescription-diagnosis').value || '';
        const symptoms = document.getElementById('prescription-symptoms').value || '';
        const notes = document.getElementById('prescription-notes').value || '';

        // --- B. Map to Print Layout ---

        // 1. Header Info
        document.getElementById('rx-date-print').innerText = new Date().toLocaleDateString(
          'en-PK',
          {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
          }
        );
        document.getElementById('rx-name-print').innerText = name;
        document.getElementById('rx-age-print').innerText = age ? `${age} Yrs` : '';

        // 2. Clinical Info (Convert newlines to <br> for HTML display)
        // Check elements exist before setting to avoid errors
        const diagEl = document.getElementById('rx-diagnosis-print');
        if (diagEl) diagEl.innerHTML = diagnosis.replace(/\n/g, '<br>');

        const sympEl = document.getElementById('rx-symptoms-print');
        if (sympEl) sympEl.innerHTML = symptoms.replace(/\n/g, '<br>');

        const notesEl = document.getElementById('rx-notes-print');
        if (notesEl) notesEl.innerHTML = notes.replace(/\n/g, '<br>');

        // 3. Medicine Table Loop
        const tbody = document.getElementById('rx-table-body');
        tbody.innerHTML = ''; // Clear previous print data

        // Select all rows we created in the modal using the 'med-row' class
        const inputRows = document.querySelectorAll('#medication-rows-container .med-row');
        let hasValidMeds = false;

        inputRows.forEach((row, index) => {
          // Safe navigation to get values
          const medName = row.querySelector('.med-name')?.value || '';
          const medDosage = row.querySelector('.med-dosage')?.value || '';
          const medFreq = row.querySelector('.med-freq')?.value || '';
          const medInstr = row.querySelector('.med-instr')?.value || '';

          // Only add row to print table if Medicine Name is not empty
          if (medName.trim() !== '') {
            hasValidMeds = true;
            tbody.innerHTML += `
            <tr>
                <td class="border border-gray-300 p-2 text-center text-gray-500 text-xs">${
                  index + 1
                }</td>
                <td class="border border-gray-300 p-2 font-bold text-gray-800 text-sm">${medName}</td>
                <td class="border border-gray-300 p-2 text-sm">${medDosage}</td>
                <td class="border border-gray-300 p-2 text-sm">${medFreq}</td>
                <td class="border border-gray-300 p-2 text-sm">${medInstr}</td>
            </tr>`;
          }
        });

        // 4. Fallback: If table is empty (no meds added), show blank ruled lines for handwriting
        if (!hasValidMeds) {
          for (let i = 1; i <= 5; i++) {
            tbody.innerHTML += `
            <tr>
               <td class="border border-gray-300 p-4 text-center text-gray-300">${i}</td>
               <td class="border border-gray-300"></td>
               <td class="border border-gray-300"></td>
               <td class="border border-gray-300"></td>
               <td class="border border-gray-300"></td>
            </tr>`;
          }
        }

        // --- C. Switch to Print View ---
        document.getElementById('prescription-modal').classList.add('hidden');

        const printEl = document.getElementById('printable-prescription');
        const mainContent = document.getElementById('printable-area');

        // Hide all other views
        if (mainContent) mainContent.classList.remove('print-active');
        document.getElementById('printable-receipt').classList.remove('print-active');
        document.getElementById('printable-discharge-slip').classList.remove('print-active');

        // Show Prescription Container
        printEl.classList.remove('hidden');
        printEl.classList.add('print-active');

        // Trigger Browser Print
        window.print();

        // Restore View after print dialog closes
        setTimeout(() => {
          printEl.classList.add('hidden');
          printEl.classList.remove('print-active');
        }, 1000);
      }
      // --- PRESCRIPTION LOGIC (END) ---

      // --- OLD BALANCE LOGIC ---
      async function loadOldBalances() {
        try {
          const res = await fetch('/api/old-balances');
          const records = await res.json();
          const tbody = document.getElementById('old-balance-body');

          if (!tbody) return;
          tbody.innerHTML = '';

          if (records.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="p-6 text-center text-gray-400">No recovery records found.</td></tr>';
            return;
          }

          records.forEach((rec, index) => {
            tbody.innerHTML += `
            <tr class="hover:bg-indigo-50 transition border-b border-gray-100">
              <td class="px-4 py-3 text-center text-gray-500 text-xs">${index + 1}</td>
              <td class="px-4 py-3 font-semibold text-gray-800">${rec.name}</td>
              <td class="px-4 py-3 font-mono font-bold text-indigo-700">${formatCurrency(
                rec.amount
              )}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${formatDisplayDate(
                rec.commitment_date
              )}</td>
              <td class="px-4 py-3 text-sm text-gray-600">${formatDisplayDate(
                rec.last_call_date
              )}</td>
              <td class="px-4 py-3 text-center">
                <button onclick="deleteOldBalance('${
                  rec.id
                }')" class="text-red-500 hover:text-red-700 transition" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
          });
        } catch (e) {
          console.error('Error loading old balances', e);
        }
      }

      async function addOldBalance(e) {
        e.preventDefault();
        const data = {
          name: document.getElementById('ob-name').value,
          amount: document.getElementById('ob-amount').value,
          commitment_date: document.getElementById('ob-commit-date').value,
          last_call_date: document.getElementById('ob-call-date').value,
        };

        const res = await fetch('/api/old-balances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showSuccessModal('Recovery Record Added');
          e.target.reset();
          loadOldBalances();
        } else {
          showSuccessModal('Error adding record', true);
        }
      }

      async function deleteOldBalance(id) {
        if (!(await showConfirmModal('Delete this recovery record?'))) return;

        const res = await fetch(`/api/old-balances/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showSuccessModal('Record Deleted');
          loadOldBalances();
        }
      }
    </script>
  </head>

  <body class="h-screen flex flex-col md:flex-row overflow-hidden font-sans text-gray-800">
    <div
      id="app-loading-overlay"
      class="fixed inset-0 z-50 bg-white/80 backdrop-blur-sm flex items-center justify-center hidden"
    >
      <div class="flex items-center gap-3 text-[#5c4d1f] font-semibold">
        <i class="fas fa-spinner fa-spin text-2xl"></i>
        <span>Loading...</span>
      </div>
    </div>

    <section
      id="login-view"
      class="view-section fixed inset-0 z-40 bg-gray-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
        <img
          src="/static/RoohLogo.jpg"
          alt="Rooh Logo"
          class="w-16 h-16 mx-auto mb-4 rounded-full border-2 border-[#c9a749]"
        />
        Rooh System
        <form onsubmit="handleLogin(event)">
          <input
            type="text"
            id="login-username"
            class="w-full p-3 mb-4 border rounded"
            placeholder="Username"
            required
          />
          <input
            type="password"
            id="login-password"
            class="w-full p-3 mb-3 border rounded"
            placeholder="Password"
            required
          />
          <div class="text-right mb-4">
            <button
              type="button"
              onclick="openForgotPasswordModal()"
              class="text-sm text-[#5c4d1f] hover:underline"
            >
              Forgot password?
            </button>
          </div>
          <button
            type="submit"
            class="w-full bg-[#c9a749] text-white p-3 rounded font-bold hover:bg-[#b8941f]"
          >
            Log In
          </button>
        </form>
      </div>
    </section>

    <!-- FORGOT PASSWORD MODAL -->
    <div
      id="forgot-password-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900">Forgot Password</h3>
            <p class="text-sm text-gray-600">Enter your username and registered email.</p>
          </div>
          <button onclick="closeForgotPasswordModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <form onsubmit="handleForgotPassword(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Username</label>
            <input
              id="forgot-username"
              class="w-full border rounded px-3 py-2"
              placeholder="Your username"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
            <input
              id="forgot-email"
              type="email"
              class="w-full border rounded px-3 py-2"
              placeholder="you@example.com"
              required
            />
          </div>
          <div class="flex gap-3 pt-2">
            <button
              type="submit"
              class="flex-1 bg-[#c9a749] hover:bg-[#b8941f] text-white py-2 rounded font-semibold transition"
            >
              Send Reset Link
            </button>
            <button
              type="button"
              onclick="closeForgotPasswordModal()"
              class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-semibold hover:bg-gray-200 transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- RESET PASSWORD MODAL (FROM EMAIL LINK) -->
    <div
      id="reset-password-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900">Set a New Password</h3>
            <p class="text-sm text-gray-600">Paste from your email link if not auto-filled.</p>
          </div>
          <button onclick="closeResetPasswordModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <form onsubmit="handleResetPassword(event)" class="space-y-4">
          <input id="reset-token-input" type="hidden" />
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">New Password</label>
            <input
              id="reset-new-password"
              type="password"
              class="w-full border rounded px-3 py-2"
              placeholder="Enter new password"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Confirm Password</label>
            <input
              id="reset-confirm-password"
              type="password"
              class="w-full border rounded px-3 py-2"
              placeholder="Confirm new password"
              required
            />
          </div>
          <div class="flex gap-3 pt-2">
            <button
              type="submit"
              class="flex-1 bg-[#c9a749] hover:bg-[#b8941f] text-white py-2 rounded font-semibold transition"
            >
              Update Password
            </button>
            <button
              type="button"
              onclick="closeResetPasswordModal()"
              class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-semibold hover:bg-gray-200 transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      class="md:hidden bg-[#c9a749] text-white p-4 flex justify-between items-center shadow z-30 flex-none"
    >
      <h1 class="font-bold text-lg flex items-center gap-2">
        <img
          src="/static/RoohLogo.jpg"
          alt="Logo"
          class="w-8 h-8 rounded-full border border-white"
        />
        Rooh System
      </h1>
      <button onclick="toggleSidebar()" class="focus:outline-none">
        <i class="fas fa-bars text-xl"></i>
      </button>
    </div>

    <aside
      id="main-sidebar"
      class="bg-gradient-to-b from-[#fffbf0] via-white to-[#fffbf0] text-[#5c4d1f] flex-col no-print shadow-xl border-r border-emerald-100 z-20 absolute md:relative inset-y-0 left-0 w-64 transform -translate-x-full md:translate-x-0 sidebar-transition md:flex h-full"
    >
      <div class="p-6 border-b border-emerald-100 hidden md:block">
        <h1 class="text-2xl font-bold flex items-center gap-2 text-[#5c4d1f]">
          <img
            src="/static/RoohLogo.jpg"
            alt="Rooh Logo"
            class="w-10 h-10 rounded-full border border-[#c9a749]"
          />
          Rooh System
        </h1>
      </div>
      <div
        class="p-4 text-xs bg-[#fffbf0] border-b border-emerald-100 font-semibold text-[#5c4d1f]"
        id="logged-in-user"
      >
        Guest
      </div>
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button
          id="nav-dash"
          onclick="window.navigateTo('dashboard-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg bg-[#c9a749]/20 text-[#5c4d1f] shadow-sm border border-[#c9a749] transition"
        >
          Dashboard
        </button>
        <button
          id="nav-patients"
          onclick="window.navigateTo('patients-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          Patients Directory
        </button>
        <button
          id="nav-accounts"
          onclick="window.navigateTo('accounts-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          Accounts & Discharge
        </button>
        <button
          id="nav-canteen"
          onclick="window.navigateTo('canteen-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          Canteen
        </button>
        <!-- <button id="nav-expenses" onclick="window.navigateTo('expenses-view')"
        class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
        style="display: none">
        Expenses
      </button> -->
        <button
          id="nav-users"
          onclick="window.navigateTo('user-management-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          User Management
        </button>
        <button
          id="nav-psych-sessions"
          onclick="window.navigateTo('psych-sessions-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          Psych Sessions
        </button>
        <button
          id="nav-overheads-finance"
          onclick="window.navigateTo('overheads-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          <i class="fas fa-coins mr-2"></i>Overheads & Finance
        </button>
        <button
          id="nav-monthly-overheads"
          onclick="window.navigateTo('monthly-overheads-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          <i class="fas fa-calculator mr-2"></i>Monthly Overheads
        </button>
        <button
          id="nav-attendance"
          onclick="window.navigateTo('attendance-view')"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          Attendance
        </button>
        <button
          id="nav-prescription"
          onclick="openPrescriptionModal()"
          class="nav-item w-full text-left px-4 py-3 rounded-lg text-[#5c4d1f] hover:bg-[#c9a749] hover:text-white border border-transparent transition"
          style="display: none"
        >
          <i class="fas fa-file-prescription mr-2"></i> Generate Prescription
        </button>
      </nav>
      <div class="p-4 border-t border-emerald-100 flex-none">
        <button
          onclick="document.getElementById('password-modal').classList.remove('hidden')"
          class="w-full text-left px-4 py-2 text-sm text-[#5c4d1f] hover:text-[#5c4d1f]"
        >
          <i class="fas fa-key mr-2"></i> Password
        </button>
        <button
          onclick="handleLogout()"
          class="w-full text-left px-4 py-2 text-sm text-[#5c4d1f] hover:text-[#5c4d1f]"
        >
          <i class="fas fa-sign-out-alt mr-2"></i> Logout
        </button>
      </div>
    </aside>

    <main class="flex-1 overflow-auto relative bg-gray-100 w-full">
      <section id="dashboard-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold text-[#5c4d1f]">System Overview</h2>
            <p class="text-sm text-gray-500">
              Live snapshot across admissions, revenue, and canteen
            </p>
          </div>
          <div class="text-right">
            <div
              class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-emerald-100 flex justify-between items-center gap-3"
            >
              <button
                onclick="openReceiptModal()"
                class="bg-[#c9a749] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#b8941f] transition shadow flex items-center gap-2"
              >
                <i class="fas fa-receipt"></i> Generate Receipt
              </button>
              <button
                onclick="openPaymentRecordsModal()"
                class="bg-[#c9a749] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#b8941f] transition shadow flex items-center gap-2"
              >
                <i class="fas fa-list-alt"></i> Payment Records
              </button>
            </div>
            <div class="text-lg font-semibold text-[#5c4d1f]" id="current-date"></div>
            <div class="text-sm text-gray-600" id="current-time"></div>
          </div>
        </div>

        <div class="mb-8 bg-red-50 border-l-4 border-red-500 rounded-r-lg shadow-sm p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-red-700 flex items-center">
              <i class="fas fa-heartbeat animate-pulse mr-2"></i> Emergency / Critical Alerts
            </h3>
            <button
              onclick="openEmergencyModal()"
              class="bg-red-600 text-white px-4 py-2 rounded font-bold hover:bg-red-700 text-sm"
            >
              <i class="fas fa-plus mr-1"></i> Add Alert
            </button>
          </div>

          <div id="emergency-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="text-gray-500 text-sm italic">No active emergencies.</div>
          </div>
        </div>

        <div
          id="emergency-modal"
          class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[60]"
        >
          <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold text-red-700 mb-4">Report Emergency Condition</h3>
            <form onsubmit="addEmergencyAlert(event)">
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Select Patient</label
              >
              <select id="emer-name" class="w-full border p-2 mb-3 rounded bg-gray-50" required>
                <option value="">Loading patients...</option>
              </select>

              <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Condition / Note</label
              >
              <textarea
                id="emer-note"
                class="w-full border p-2 mb-3 rounded h-24"
                placeholder="e.g. Low BP 90/60, Chest Pain, High Fever"
                required
              ></textarea>

              <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Severity Level</label
              >
              <select id="emer-severity" class="w-full border p-2 mb-4 rounded">
                <option value="critical">Critical (Red)</option>
                <option value="warning">Warning (Orange)</option>
              </select>

              <button
                type="submit"
                class="w-full bg-red-600 text-white py-2 rounded font-bold hover:bg-red-700 shadow-md transition transform active:scale-95"
              >
                Post Alert
              </button>
            </form>
            <button
              onclick="document.getElementById('emergency-modal').classList.add('hidden')"
              class="mt-3 w-full text-gray-500 text-sm hover:text-gray-800"
            >
              Cancel
            </button>
          </div>
        </div>
        <div class="flex flex-wrap gap-6 mb-6 w-full">
          <div
            class="kpi-card kpi-accent-shamrock flex-1 min-w-xs cursor-pointer hover:shadow-lg transition-all"
            onclick="window.navigateTo('patients-view')"
          >
            <div class="flex items-start justify-between">
              <div>
                <div class="text-sm text-gray-700">Total Patients</div>
                <div class="metric-number text-3xl font-extrabold mt-2" id="dash-total">0</div>
              </div>
              <div class="kpi-icon"><i class="fas fa-users"></i></div>
            </div>
          </div>

          <div
            class="kpi-card kpi-accent-amber flex-1 min-w-xs cursor-pointer hover:shadow-lg transition-all"
            onclick="openAdmissionsModal()"
          >
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="text-sm text-gray-700 font-semibold mb-2">
                  <span id="dash-month-label">Month</span> Summary
                </div>
                <div class="flex items-center gap-4">
                  <div>
                    <div class="text-xs text-gray-600">Admitted</div>
                    <div class="text-2xl font-bold text-[#5c4d1f]" id="dash-admitted">0</div>
                  </div>
                  <div class="text-gray-300">|</div>
                  <div>
                    <div class="text-xs text-gray-600">Discharged</div>
                    <div class="text-2xl font-bold text-gray-700" id="dash-discharged">0</div>
                  </div>
                </div>
              </div>
              <div class="kpi-icon"><i class="fas fa-hospital-user"></i></div>
            </div>
          </div>
        </div>

        <!-- Daily Report Section -->
        <div id="dash-daily-report-section" class="mt-8 pt-8 border-t border-emerald-100">
          <div
            class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4"
          >
            <div>
              <h3 class="text-xl font-bold text-[#5c4d1f]">
                <i class="fas fa-clipboard-list mr-2"></i>Day & Night Reports
              </h3>
              <p class="text-sm text-gray-500">
                Click headers to edit activity names. Click "Save Layout" to persist changes.
              </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <input
                type="date"
                id="report-date-picker"
                onchange="loadDailyReport()"
                class="border p-2 rounded shadow-sm focus:ring-2 focus:ring-emerald-500 text-sm font-bold text-gray-700"
              />

              <div class="h-8 w-px bg-gray-300 mx-2"></div>

              <button
                onclick="printReport('day')"
                class="bg-white border border-emerald-600 text-emerald-700 px-3 py-1.5 rounded hover:bg-[#fffbf0] text-sm font-bold shadow-sm"
              >
                <i class="fas fa-sun mr-1"></i> Print Day
              </button>
              <button
                onclick="printReport('night')"
                class="bg-white border border-indigo-600 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-50 text-sm font-bold shadow-sm"
              >
                <i class="fas fa-moon mr-1"></i> Print Night
              </button>
              <button
                onclick="printReport('both')"
                class="bg-[#c9a749] text-white px-3 py-1.5 rounded hover:bg-[#b8941f] text-sm font-bold shadow-sm"
              >
                <i class="fas fa-print mr-1"></i> Print Both
              </button>

              <button
                id="btn-save-layout"
                onclick="saveLayoutConfig()"
                class="hidden ml-2 bg-gray-800 text-white px-3 py-1.5 rounded hover:bg-gray-900 text-sm font-bold shadow-sm"
                title="Save Column Names"
              >
                <i class="fas fa-save"></i>
              </button>
            </div>
          </div>

          <div id="day-report-container" class="mb-8">
            <div class="flex justify-between items-center mb-2 px-2">
              <h4 class="font-bold text-[#5c4d1f] text-lg">
                <i class="fas fa-sun mr-2 text-yellow-500"></i>Day Report
              </h4>
            </div>
            <div class="bg-white rounded-xl shadow-lg border border-emerald-100 overflow-hidden">
              <div class="w-full">
                <table
                  class="w-full divide-y divide-emerald-100 relative"
                  style="table-layout: fixed"
                >
                  <thead class="bg-[#c9a749] text-white">
                    <tr id="day-header-row"></tr>
                  </thead>
                  <tbody
                    id="day-table-body"
                    class="divide-y divide-emerald-50 bg-white text-xs"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="night-report-container">
            <div class="flex justify-between items-center mb-2 px-2">
              <h4 class="font-bold text-indigo-900 text-lg">
                <i class="fas fa-moon mr-2 text-indigo-500"></i>Night Report
              </h4>
            </div>
            <div class="bg-white rounded-xl shadow-lg border border-indigo-100 overflow-hidden">
              <div class="w-full">
                <table
                  class="w-full divide-y divide-indigo-100 relative"
                  style="table-layout: fixed"
                >
                  <thead class="bg-indigo-900 text-white">
                    <tr id="night-header-row"></tr>
                  </thead>
                  <tbody
                    id="night-table-body"
                    class="divide-y divide-indigo-50 bg-white text-xs"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-4 text-xs font-semibold text-gray-600 justify-end">
            <div class="flex items-center gap-1.5">
              <div class="w-3 h-3 bg-[#fffbf0] border border-[#c9a749] rounded"></div>
              Done
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-3 h-3 bg-red-100 border border-red-500 rounded"></div>
              Not Done
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-3 h-3 bg-yellow-100 border border-yellow-500 rounded"></div>
              Emergency/Complain
            </div>
          </div>
        </div>

        <!-- Call & Meeting Tracker Section -->
        <div
          id="dash-call-meeting-section"
          class="mt-10 pt-10 border-t border-emerald-100"
          style="display: none"
        >
          <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="space-y-1">
              <h3 class="text-2xl font-bold text-[#5c4d1f]">Call & Meeting Tracker</h3>
              <p class="text-sm text-gray-500" id="call-meeting-month-label">
                Click a cell to mark a scheduled meeting/call (tick).
              </p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <input
                type="month"
                id="call-meeting-month"
                onchange="loadCallMeetingData()"
                class="border p-2 rounded shadow-sm focus:ring-2 focus:ring-emerald-500 text-sm font-bold text-gray-700"
              />
              <div
                class="flex items-center gap-1 text-xs sm:text-sm text-gray-600"
                aria-live="polite"
              >
                <i class="fas fa-calendar-day text-[#c9a749]"></i>
                <span id="call-meeting-current-date" class="font-semibold"></span>
              </div>
              <button
                onclick="printCallMeetingReport()"
                class="bg-white border border-emerald-600 text-[#5c4d1f] px-4 py-2 rounded-lg hover:bg-[#fffbf0] transition font-semibold shadow-sm"
              >
                <i class="fas fa-print mr-2"></i>Print
              </button>
              <button
                onclick="openCallMeetingModal()"
                class="bg-[#c9a749] text-white px-4 py-2 rounded-lg hover:bg-[#b8941f] transition font-semibold shadow-sm"
              >
                <i class="fas fa-plus mr-2"></i>Add Entry
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg border border-emerald-100 overflow-hidden">
            <div class="overflow-x-auto">
              <table
                id="call-meeting-table"
                class="min-w-full divide-y divide-[#c9a749]/30 relative"
              >
                <thead class="bg-[#c9a749] text-white">
                  <tr id="call_meeting_header_row"></tr>
                </thead>
                <tbody
                  id="call_meeting_table_body"
                  class="divide-y divide-[#c9a749]/10 bg-white text-sm"
                ></tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-4 text-xs font-semibold text-gray-600 justify-end">
            <div class="flex items-center gap-1.5">
              <div
                class="w-4 h-4 rounded-full bg-emerald-100 border border-[#c9a749] flex items-center justify-center"
              >
                <i class="fas fa-check text-[#5c4d1f] text-[10px]"></i>
              </div>
              Click a date cell to add/remove a meeting/call (tick)
            </div>
          </div>
        </div>
      </section>

      <section id="expenses-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold text-[#5c4d1f]">Expenses</h2>
            <p class="text-sm text-gray-500">Track incoming and outgoing money.</p>
          </div>
          <div>
            <button
              id="add-expense-btn"
              onclick="openExpenseModal()"
              class="hidden bg-[#c9a749] text-white px-4 py-2 rounded-lg hover:bg-[#b8941f] transition font-semibold shadow-md"
            >
              <i class="fas fa-plus mr-2"></i>Add Entry
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div
            class="kpi-card"
            style="
              background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
              border-color: rgba(201, 167, 73, 0.2);
            "
          >
            <div class="text-sm text-gray-700 font-bold">Incoming (Month)</div>
            <div class="text-3xl font-bold text-[#5c4d1f] mt-2" id="expense-incoming">0</div>
          </div>
          <div
            class="kpi-card"
            style="
              background: linear-gradient(135deg, #fee2e2 0%, #fecdd3 100%);
              border-color: rgba(248, 113, 113, 0.2);
            "
          >
            <div class="text-sm text-gray-700 font-bold">Outgoing (Month)</div>
            <div class="text-3xl font-bold text-red-600 mt-2" id="expense-outgoing">0</div>
          </div>
          <div
            class="kpi-card"
            style="
              background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%);
              border-color: rgba(59, 130, 246, 0.2);
            "
          >
            <div class="text-sm text-gray-700 font-bold">Net (Month)</div>
            <div class="text-3xl font-bold text-blue-700 mt-2" id="expense-net">0</div>
          </div>
        </div>

        <div
          class="kpi-card overflow-x-auto"
          style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
        >
          <table class="min-w-full divide-y divide-[#c9a749]/30">
            <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
              <tr>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Date</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Category</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Type</th>
                <th class="px-6 py-3 text-right whitespace-nowrap font-semibold">Amount</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Note</th>
                <th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="expenses-table-body" class="divide-y divide-[#c9a749]/10"></tbody>
          </table>
        </div>
      </section>

      <section id="accounts-view" class="view-section hidden p-4 md:p-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6 text-[#5c4d1f]">
          <i class="fas fa-file-invoice-dollar mr-2"></i>Accounts & Discharge
        </h2>
        <div
          class="kpi-card overflow-x-auto"
          style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
        >
          <table class="min-w-full divide-y divide-[#c9a749]/30 overflow-x-auto">
            <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
              <tr>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Patient Name</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Father Name</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Admission</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Total Bill</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Received</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Balance Due</th>
                <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="accounts-table-body" class="divide-y divide-[#c9a749]/10"></tbody>
          </table>
        </div>
      </section>

      <section id="patients-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between mb-4">
          <div class="flex flex-col gap-3 flex-1">
            <h2 class="text-2xl font-bold">Patients Directory</h2>
            <div class="relative w-full md:max-w-sm">
              <span
                class="absolute inset-y-0 left-3 flex items-center text-[#c9a749] pointer-events-none"
              >
                <i class="fas fa-search"></i>
              </span>
              <input
                type="search"
                id="patients-search-input"
                class="w-full pl-10 pr-4 py-2 border border-[#c9a749] rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-[#c9a749] text-sm text-gray-700 placeholder:text-gray-400 bg-white"
                placeholder="Search patients by name"
                aria-label="Search patients by name"
                oninput="handlePatientsSearch(this.value)"
              />
            </div>
          </div>
          <div
            class="flex flex-col sm:flex-row gap-2 w-full md:w-auto md:items-center md:justify-end"
          >
            <button
              onclick="document.getElementById('export-modal').classList.remove('hidden')"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-semibold shadow-md text-center"
            >
              <i class="fas fa-file-excel mr-2"></i>Export
            </button>
            <button
              id="add-new-patient-btn"
              onclick="openNewAdmissionModal()"
              class="bg-[#c9a749] text-white px-4 py-2 rounded hover:bg-[#b8941f] transition font-semibold shadow-md text-center"
            >
              <i class="fas fa-plus mr-2"></i>New Admission
            </button>
          </div>
        </div>
        <div
          class="kpi-card overflow-x-auto"
          style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
        >
          <table class="min-w-full divide-y divide-[#c9a749]/30" style="font-size: 0.875rem">
            <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
              <tr id="patients-table-headers">
                <th class="px-3 py-2 text-left whitespace-nowrap font-semibold text-xs">
                  Serial No
                </th>
                <th class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs">Name</th>
                <th class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs">
                  Father Name
                </th>
                <th class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs">
                  Admission Date
                </th>
                <th
                  id="header-contact"
                  class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs"
                >
                  Contact
                </th>
                <th class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs">Area</th>
                <th class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs">Drug</th>
                <th
                  id="header-fee"
                  class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs admin-only-column"
                >
                  Calculated Fee
                </th>
                <th class="px-2 py-2 text-center whitespace-nowrap font-semibold text-xs">
                  Days Done
                </th>
                <th class="px-2 py-2 text-center whitespace-nowrap font-semibold text-xs">
                  Months Done
                </th>
                <th
                  id="header-received"
                  class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs admin-only-column"
                >
                  Received Amt
                </th>
                <th
                  id="header-pending"
                  class="px-2 py-2 text-left whitespace-nowrap font-semibold text-xs admin-only-column"
                >
                  Pending Amt
                </th>
                <th class="px-2 py-2 text-right whitespace-nowrap font-semibold text-xs">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="patients-table-body" class="divide-y divide-[#c9a749]/10"></tbody>
          </table>
        </div>
      </section>

      <section id="patient-detail-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
          <button onclick="navigateTo('patients-view')" class="text-[#c9a749] font-bold self-start">
            <i class="fas fa-arrow-left mr-2"></i>Back
          </button>
          <div class="flex gap-2">
            <button onclick="window.print()" class="bg-white border px-4 py-2 rounded text-sm">
              <i class="fas fa-print mr-2"></i>Print
            </button>
            <button
              onclick="document.getElementById('save-det-btn-submit').click()"
              class="bg-[#c9a749] text-white px-4 py-2 rounded text-sm"
            >
              Save
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-6 rounded shadow">
            <form id="patient-details-form" onsubmit="savePatientDetails(event)">
              <input type="submit" id="save-det-btn-submit" class="hidden" />
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input id="det-name" class="border p-2 rounded" placeholder="Name" />
                <input id="det-father" class="border p-2 rounded" placeholder="Father Name" />
                <input id="det-admission" type="date" class="border p-2 rounded" />
                <input id="det-id" class="border p-2 rounded" placeholder="ID" />
                <input id="det-age" class="border p-2 rounded" placeholder="Age" />
                <input id="det-cnic" class="border p-2 rounded" placeholder="CNIC" />
                <input id="det-contact" class="border p-2 rounded" placeholder="Contact" />
                <input id="det-guardian" class="border p-2 rounded" placeholder="Guardian" />
                <input id="det-relation" class="border p-2 rounded" placeholder="Relation" />
                <input id="det-area" class="border p-2 rounded" placeholder="Area / City" />
                <div class="md:col-span-2 lg:col-span-3">
                  <input id="det-address" class="border p-2 w-full rounded" placeholder="Address" />
                </div>
                <div class="md:col-span-2 lg:col-span-3">
                  <textarea
                    id="det-complaint"
                    class="border p-2 w-full rounded"
                    placeholder="Complaint"
                  ></textarea>
                </div>
                <div class="md:col-span-2 lg:col-span-3">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-2">
                      <div
                        class="aspect-video overflow-hidden rounded border bg-gray-50 flex items-center justify-center"
                      >
                        <img
                          id="det-photo1-img"
                          class="object-cover w-full h-full"
                          alt="No photo available"
                        />
                      </div>
                      <input
                        id="det-photo1-file"
                        type="file"
                        accept="image/*"
                        class="w-full text-sm"
                      />
                      <input id="det-photo1" type="hidden" />
                      <input id="det-photo1-hidden" type="hidden" />
                    </div>
                    <div class="space-y-2">
                      <div
                        class="aspect-video overflow-hidden rounded border bg-gray-50 flex items-center justify-center"
                      >
                        <img
                          id="det-photo2-img"
                          class="object-cover w-full h-full"
                          alt="No photo available"
                        />
                      </div>
                      <input
                        id="det-photo2-file"
                        type="file"
                        accept="image/*"
                        class="w-full text-sm"
                      />
                      <input id="det-photo2" type="hidden" />
                      <input id="det-photo2-hidden" type="hidden" />
                    </div>
                    <div class="space-y-2">
                      <div
                        class="aspect-video overflow-hidden rounded border bg-gray-50 flex items-center justify-center"
                      >
                        <img
                          id="det-photo3-img"
                          class="object-cover w-full h-full"
                          alt="No photo available"
                        />
                      </div>
                      <input
                        id="det-photo3-file"
                        type="file"
                        accept="image/*"
                        class="w-full text-sm"
                      />
                      <input id="det-photo3" type="hidden" />
                      <input id="det-photo3-hidden" type="hidden" />
                    </div>
                  </div>
                </div>
                <input id="det-prev" class="border p-2 rounded" placeholder="Prev Admissions" />

                <div class="md:col-span-2 lg:col-span-3 mt-4 border-t pt-4 bg-gray-50 p-4">
                  <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase">
                    Financial Settings (Admin Only)
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input
                      id="det-fee"
                      class="financial-input border p-2 rounded"
                      placeholder="Monthly Fee"
                    />
                    <input
                      id="det-received"
                      class="financial-input border p-2 rounded"
                      placeholder="Received Amount"
                    />
                    <input
                      id="det-drug"
                      class="financial-input border p-2 rounded"
                      placeholder="Drug"
                    />
                    <div class="md:col-span-2">
                      <label
                        class="flex items-center gap-3 p-3 bg-white border border-[#c9a749] rounded-lg cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="det-laundry-status"
                          class="financial-input w-5 h-5 text-[#c9a749] border-gray-300 rounded focus:ring-2 focus:ring-emerald-500"
                        />
                        <span id="det-laundry-label" class="text-sm font-semibold text-gray-700"
                          >Enable Laundry Service</span
                        >
                      </label>
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1"
                        >Laundry Amount (PKR)</label
                      >
                      <input
                        id="det-laundry-amount"
                        type="number"
                        class="financial-input border p-2 rounded w-full"
                        placeholder="3500"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </form>

            <div class="mt-6 border-t pt-4">
              <div class="flex border-b mb-4">
                <button
                  onclick="showTab('notes')"
                  id="notes-tab-btn"
                  class="flex-1 py-2 text-[#5c4d1f] border-b-2 border-green-700 font-bold"
                >
                  Notes
                </button>
                <button
                  onclick="showTab('records')"
                  id="records-tab-btn"
                  class="flex-1 py-2 text-gray-500"
                >
                  Medical Records
                </button>
              </div>
              <div id="tab-notes">
                <div
                  id="session-notes-list"
                  class="h-64 overflow-y-auto border p-2 mb-2 bg-gray-50 rounded"
                ></div>
                <form onsubmit="addSessionNote(event)" class="flex gap-2">
                  <input
                    id="new-session-note-input"
                    class="flex-1 border p-2 rounded"
                    placeholder="Add Note..."
                  /><button class="bg-[#c9a749] text-white px-4 rounded">Add</button>
                </form>
              </div>
              <div id="tab-med" class="hidden">
                <div
                  id="medical-records-list"
                  class="h-64 overflow-y-auto border p-2 mb-2 bg-gray-50 rounded"
                ></div>
                <form onsubmit="addMedicalRecord(event)" class="grid gap-2">
                  <input id="new-med-title" class="border p-2 rounded" placeholder="Title" />
                  <textarea
                    id="new-med-details"
                    class="border p-2 rounded"
                    placeholder="Details"
                  ></textarea>
                  <button class="bg-[#c9a749] text-white p-2 rounded">Add Record</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-span-1 space-y-6">
            <div
              id="call-info-panel"
              class="bg-white p-6 rounded shadow border-t-4 border-green-600"
            >
              <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800">
                  <i class="fas fa-phone-alt mr-2"></i>Weekly Call
                </h3>
                <span class="bg-[#fffbf0] text-[#5c4d1f] text-xs px-2 py-1 rounded-full font-bold"
                  >Active</span
                >
              </div>
              <div
                id="next-call-display"
                class="mb-6 p-4 bg-[#fffbf0] rounded border border-green-100"
              ></div>
              <div>
                <h4 class="text-xs font-bold text-gray-400 uppercase">Calendar</h4>
                <div id="mini-calendar" class="calendar-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="psych-sessions-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col lg:flex-row gap-6">
          <div
            id="psych-assign-card"
            class="lg:w-1/3 bg-white p-5 rounded-xl shadow-sm border border-emerald-100 hidden"
          >
            <h3 class="text-lg font-bold mb-3 text-[#5c4d1f] flex items-center gap-2">
              <i class="fas fa-calendar-plus"></i> Assign Sessions (Admin)
            </h3>
            <form id="psych-session-form" class="space-y-3" onsubmit="submitPsychSession(event)">
              <div>
                <label class="text-xs font-semibold text-gray-600">Psychologist</label>
                <select
                  id="psych-session-psychologist"
                  class="w-full border rounded px-3 py-2"
                  required
                ></select>
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-600">Date</label>
                <input
                  type="date"
                  id="psych-session-date"
                  class="w-full border rounded px-3 py-2"
                  required
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-600">Time Slot</label>
                <input
                  type="text"
                  id="psych-session-time"
                  class="w-full border rounded px-3 py-2"
                  placeholder="e.g. 10:00 - 11:00"
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-600">Patients</label>
                <select
                  id="psych-session-patients"
                  multiple
                  size="6"
                  class="w-full border rounded px-3 py-2"
                ></select>
                <p class="text-xs text-gray-500 mt-1">
                  Hold Ctrl/Command to select multiple patients.
                </p>
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-600">Title / Focus</label>
                <input
                  type="text"
                  id="psych-session-title"
                  class="w-full border rounded px-3 py-2"
                  placeholder="Optional"
                />
              </div>
              <button
                type="submit"
                class="w-full bg-[#c9a749] text-white py-2 rounded-lg font-semibold hover:bg-[#b8941f]"
              >
                Save Session
              </button>
            </form>
          </div>

          <div class="flex-1 bg-white p-5 rounded-xl shadow-sm border border-emerald-100">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
              <div>
                <h3 class="text-xl font-bold text-[#5c4d1f]">Psych Sessions</h3>
                <p class="text-sm text-gray-500">Assigned sessions for the selected window.</p>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                <input
                  type="date"
                  id="psych-filter-start"
                  class="border rounded px-2 py-1 text-sm w-full sm:w-auto"
                />
                <input
                  type="date"
                  id="psych-filter-end"
                  class="border rounded px-2 py-1 text-sm w-full sm:w-auto"
                />
                <button
                  class="bg-[#c9a749] text-white px-3 py-2 rounded text-sm w-full sm:w-auto"
                  onclick="loadPsychSessions()"
                >
                  Refresh
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[#c9a749]/30 text-sm">
                <thead class="bg-[#c9a749] text-white">
                  <tr>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Time</th>
                    <th class="px-3 py-2 text-left" id="psych-col-psych">Psychologist</th>
                    <th class="px-3 py-2 text-left">Patients</th>
                    <th class="px-3 py-2 text-left">Title</th>
                    <th class="px-3 py-2 text-left">Note</th>
                    <th class="px-3 py-2 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="psych-sessions-body" class="divide-y divide-[#c9a749]/10">
                  <tr>
                    <td colspan="7" class="p-6 text-center text-gray-400">Loading sessions...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="canteen-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6 flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold text-[#5c4d1f]">
              <i class="fas fa-utensils mr-2"></i>Canteen Management
            </h2>
            <p class="text-sm text-gray-500 mt-1">Daily spending tracker with monthly totals</p>
          </div>
          <!-- Month/Year Selector -->
          <div class="flex gap-2 items-center">
            <label class="text-sm font-medium text-gray-700">Month:</label>
            <select id="canteen-month-select" class="border rounded px-3 py-2 text-sm">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <select id="canteen-year-select" class="border rounded px-3 py-2 text-sm">
              <!-- Years will be populated by JavaScript -->
            </select>
            <button
              onclick="loadCanteenMonthlyTable()"
              class="bg-[#c9a749] hover:bg-[#b8941f] text-white px-4 py-2 rounded text-sm font-medium transition"
            >
              Load
            </button>
          </div>
        </div>

        <!-- Monthly Table -->
        <div class="bg-white rounded shadow overflow-x-auto">
          <div class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white px-6 py-3">
            <h3 class="font-semibold text-lg">Monthly Canteen Tracker</h3>
            <p class="text-xs opacity-90" id="canteen-month-display">Loading...</p>
          </div>
          <div class="overflow-x-auto" style="max-height: 600px">
            <table id="canteen-monthly-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-[#fffbf0] sticky top-0">
                <tr id="canteen-table-header">
                  <!-- Headers will be dynamically generated -->
                </tr>
              </thead>
              <tbody id="canteen-monthly-body" class="divide-y divide-gray-100">
                <!-- Rows will be dynamically generated -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="user-management-view" class="view-section hidden p-4 md:p-8">
        <h2 class="text-2xl font-bold mb-6">User Management</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="col-span-1 bg-white p-6 rounded shadow">
            <h3 class="font-bold mb-4">Create User</h3>
            <form onsubmit="createUser(event)">
              <input
                name="new-name"
                class="w-full border p-2 mb-2 rounded"
                placeholder="Name"
                required
              />
              <input
                name="new-username"
                class="w-full border p-2 mb-2 rounded"
                placeholder="Username"
                required
              />
              <input
                name="new-email"
                type="email"
                class="w-full border p-2 mb-2 rounded"
                placeholder="Email"
                required
              />
              <input
                name="new-password"
                type="password"
                class="w-full border p-2 mb-2 rounded"
                placeholder="Password"
                required
              />
              <select name="new-role" class="w-full border p-2 mb-4 rounded">
                <option value="Admin">Admin</option>
                <option value="Doctor">Doctor</option>
                <option value="Psychologist">Psychologist</option>
                <option value="Canteen">Canteen</option>
                <option value="General Staff">General Staff</option>
              </select>
              <button
                class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition font-semibold shadow-md"
              >
                Create
              </button>
            </form>
          </div>
          <div
            class="col-span-2 kpi-card overflow-x-auto"
            style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
          >
            <table class="min-w-full divide-y divide-[#c9a749]/30">
              <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
                <tr>
                  <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Name</th>
                  <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">User</th>
                  <th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Role</th>
                  <th class="px-6 py-3 whitespace-nowrap font-semibold text-center">Action</th>
                </tr>
              </thead>
              <tbody id="user-table-body" class="divide-y divide-[#c9a749]/10"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="overheads-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-8">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-[#5c4d1f]">
              <i class="fas fa-coins mr-2"></i>Overheads & Finance
            </h2>
            <p class="text-sm text-gray-500">
              Monthly financial projection: Expected Incoming Fees vs. Estimated Costs.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-[#fffbf0] border border-[#c9a749] px-6 py-5 rounded-xl shadow-sm flex flex-col justify-between relative overflow-hidden"
            >
              <div class="z-10">
                <span class="text-xs font-bold text-[#c9a749] uppercase tracking-wide">
                  <i class="fas fa-arrow-down mr-1"></i> Total Expected Incoming
                </span>
                <div class="mt-2 flex items-baseline gap-2">
                  <span id="overhead-total-income" class="text-3xl font-extrabold text-[#5c4d1f]"
                    >PKR 0</span
                  >
                  <span class="text-xs text-[#c9a749] font-medium opacity-80"
                    >(Fees from Active Patients)</span
                  >
                </div>
              </div>
              <div
                class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-[#fffbf0]/50 to-transparent pointer-events-none"
              ></div>
            </div>

            <div
              class="bg-red-50 border border-red-200 px-6 py-5 rounded-xl shadow-sm flex flex-col justify-between relative overflow-hidden"
            >
              <div class="z-10">
                <span class="text-xs font-bold text-red-600 uppercase tracking-wide">
                  <i class="fas fa-arrow-up mr-1"></i> Total Estimated Overheads
                </span>
                <div class="mt-2 flex items-baseline gap-2">
                  <span id="grand-overhead-total" class="text-3xl font-extrabold text-red-700"
                    >PKR 0</span
                  >
                </div>
                <div class="text-xs text-red-500 mt-1 font-medium">
                  (Salaries: <span id="total-salary-display">0</span> + Bills:
                  <span id="total-bills-display">0</span>)
                </div>
              </div>
              <div
                class="absolute right-0 top-0 h-full w-24 bg-gradient-to-l from-red-100/50 to-transparent pointer-events-none"
              ></div>
            </div>
          </div>
        </div>

        <div class="mb-10">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-users mr-2"></i>Staff Salaries
            </h3>
            <button
              onclick="openEmployeeModal()"
              class="bg-[#c9a749] text-white px-3 py-1 rounded text-sm hover:bg-[#b8941f] transition shadow-md"
            >
              <i class="fas fa-plus mr-1"></i> Add Employee
            </button>
          </div>
          <div
            class="kpi-card overflow-hidden"
            style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
          >
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[#c9a749]/30">
                <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
                  <tr>
                    <th class="px-4 py-3 text-center text-xs uppercase">S.No</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Designation</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Pay</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Advance</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Remaining</th>
                    <th class="px-4 py-3 text-left text-xs uppercase">Contact</th>
                    <th class="px-4 py-3 text-center text-xs uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="team-table-body" class="divide-y divide-[#c9a749]/10 bg-white"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div>
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-file-invoice mr-2"></i>Pending Utility Bills
            </h3>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
              <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Add New Bill</h4>
              <form onsubmit="addUtilityBill(event)">
                <div class="grid grid-cols-2 gap-3 mb-3">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Type</label>
                    <select id="bill-type" class="w-full border bg-gray-50 p-2 rounded text-sm">
                      <option value="Electricity">Electricity</option>
                      <option value="Gas">Gas</option>
                      <option value="Internet">Internet</option>
                      <option value="Water">Water</option>
                      <option value="Rent">Rent</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Amount</label>
                    <input
                      id="bill-amount"
                      type="number"
                      class="w-full border p-2 rounded text-sm"
                      placeholder="0"
                      required
                    />
                  </div>
                </div>
                <div class="mb-3">
                  <label class="block text-xs font-bold text-gray-500 mb-1">Due Date</label>
                  <input
                    id="bill-due-date"
                    type="date"
                    class="w-full border p-2 rounded text-sm"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-xs font-bold text-gray-500 mb-1">Ref / Note</label>
                  <input
                    id="bill-ref"
                    type="text"
                    class="w-full border p-2 rounded text-sm"
                    placeholder="Ref ID"
                  />
                </div>
                <button
                  class="w-full bg-[#c9a749] hover:bg-[#b8941f] text-white py-2 rounded font-bold shadow text-sm"
                >
                  Add Bill
                </button>
              </form>
            </div>

            <div class="col-span-1 lg:col-span-2">
              <div id="bills-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
              <div
                id="bills-empty-state"
                class="hidden flex flex-col items-center justify-center py-8 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300"
              >
                <i class="fas fa-check-circle text-3xl mb-2 text-green-200"></i>
                <p class="text-sm">No pending bills.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-12 pt-8 border-t-2 border-dashed border-gray-300">
          <div class="mb-6">
            <h2 class="text-xl font-bold text-indigo-900 flex items-center">
              <i class="fas fa-history mr-2"></i> Old Balance / Recoveries
            </h2>
            <p class="text-sm text-gray-500">
              Track outstanding balances and recovery commitments.
            </p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div
              class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-indigo-100 h-fit"
            >
              <h4 class="font-bold text-indigo-800 mb-3 text-sm uppercase">Add Recovery Record</h4>
              <form onsubmit="addOldBalance(event)">
                <div class="mb-3">
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                    >Person Name</label
                  >
                  <input
                    id="ob-name"
                    type="text"
                    class="w-full border bg-gray-50 p-2 rounded text-sm focus:ring-2 focus:ring-indigo-500"
                    placeholder="Name"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                    >Amount (PKR)</label
                  >
                  <input
                    id="ob-amount"
                    type="number"
                    class="w-full border p-2 rounded text-sm"
                    placeholder="0"
                    required
                  />
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                      >Commitment Date</label
                    >
                    <input
                      id="ob-commit-date"
                      type="date"
                      class="w-full border p-2 rounded text-sm"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                      >Last Call Date</label
                    >
                    <input
                      id="ob-call-date"
                      type="date"
                      class="w-full border p-2 rounded text-sm"
                      required
                    />
                  </div>
                </div>
                <button
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold shadow transition text-sm"
                >
                  <i class="fas fa-plus mr-2"></i> Add Record
                </button>
              </form>
            </div>

            <div class="col-span-1 lg:col-span-2">
              <div class="bg-white rounded-xl shadow-sm border border-indigo-100 overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-indigo-100">
                    <thead class="bg-indigo-50 text-indigo-900">
                      <tr>
                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">#</th>
                        <th class="px-4 py-3 text-left text-xs font-bold uppercase">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-bold uppercase">Amount</th>
                        <th class="px-4 py-3 text-left text-xs font-bold uppercase">Commitment</th>
                        <th class="px-4 py-3 text-left text-xs font-bold uppercase">Last Call</th>
                        <th class="px-4 py-3 text-center text-xs font-bold uppercase">Action</th>
                      </tr>
                    </thead>
                    <tbody
                      id="old-balance-body"
                      class="divide-y divide-gray-50 bg-white text-sm"
                    ></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= ATTENDANCE VIEW SECTION ================= -->
      <section id="attendance-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-[#5c4d1f]">
            <i class="fas fa-calendar-check mr-2"></i>Staff Attendance
          </h2>
          <p class="text-sm text-gray-500">Track and manage monthly staff attendance records.</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <h3 class="text-lg font-bold text-gray-800">Monthly Attendance</h3>
            <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
              Month
              <input id="attendance-month" type="month" class="border rounded px-2 py-1 text-sm" />
            </label>
            <button
              id="attendance-print-btn"
              class="ml-auto bg-[#c9a749] text-white px-3 py-2 rounded shadow-sm hover:bg-[#b8941f]"
              type="button"
            >
              <i class="fas fa-print mr-2"></i>Print
            </button>
          </div>

          <div class="overflow-x-auto border rounded-lg bg-white">
            <table class="w-full table-fixed border-collapse text-sm">
              <thead class="bg-[#c9a749] text-white">
                <tr id="attendance-header-row"></tr>
              </thead>
              <tbody id="attendance-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="utility-bills-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-[#5c4d1f]">
              <i class="fas fa-file-invoice mr-2"></i>Utility Bills
            </h2>
            <p class="text-sm text-gray-500">Manage pending utility payments.</p>
          </div>

          <div
            class="bg-red-50 border border-red-200 px-6 py-3 rounded-xl flex flex-col items-end min-w-[200px]"
          >
            <span class="text-xs font-bold text-red-600 uppercase tracking-wide"
              >Total Payable</span
            >
            <span id="bill-total-display" class="text-2xl font-extrabold text-red-700">PKR 0</span>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Add New Bill</h3>
            <form onsubmit="addUtilityBill(event)">
              <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                  >Bill Type</label
                >
                <select
                  id="bill-type"
                  class="w-full border bg-gray-50 p-2 rounded focus:ring-2 focus:ring-[#c9a749]"
                  required
                >
                  <option value="Electricity">Electricity (WAPDA)</option>
                  <option value="Gas">Gas (SNGPL)</option>
                  <option value="Internet">Internet / PTCL</option>
                  <option value="Water">Water</option>
                  <option value="Rent">Rent</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                  >Amount (PKR)</label
                >
                <input
                  id="bill-amount"
                  type="number"
                  class="w-full border p-2 rounded"
                  placeholder="0"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Due Date</label>
                <input id="bill-due-date" type="date" class="w-full border p-2 rounded" required />
              </div>

              <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                  >Reference No / Note</label
                >
                <input
                  id="bill-ref"
                  type="text"
                  class="w-full border p-2 rounded"
                  placeholder="e.g. Ref ID or Meter No"
                />
              </div>

              <button
                class="w-full bg-[#c9a749] hover:bg-[#b8941f] text-white py-2 rounded-lg font-bold shadow transition"
              >
                <i class="fas fa-plus mr-2"></i> Add Bill
              </button>
            </form>
          </div>

          <div class="col-span-1 lg:col-span-2">
            <div id="bills-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

            <div
              id="bills-empty-state"
              class="hidden flex flex-col items-center justify-center py-12 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300"
            >
              <i class="fas fa-check-circle text-4xl mb-3 text-green-200"></i>
              <p>No pending bills. Great job!</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= OVERHEADS VIEW SECTION (ADMIN ONLY) ================= -->
      <section id="monthly-overheads-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-[#5c4d1f]">
            <i class="fas fa-calculator mr-2"></i>Monthly Overheads
          </h2>
          <p class="text-sm text-gray-500">
            Track daily expenses, income, and calculate monthly profit (Admin only).
          </p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <!-- Month/Year Selector -->
          <div class="flex flex-wrap items-center gap-4 mb-6">
            <div>
              <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Month</label>
              <select
                id="monthly-overheads-month-select"
                class="border border-gray-300 rounded px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-[#c9a749] focus:border-[#c9a749]"
              >
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Year</label>
              <select
                id="monthly-overheads-year-select"
                class="border border-gray-300 rounded px-3 py-2 bg-gray-50 focus:ring-2 focus:ring-[#c9a749] focus:border-[#c9a749]"
              ></select>
            </div>
            <div class="mt-5">
              <button
                onclick="loadMonthlyOverheadsTable()"
                class="bg-[#c9a749] hover:bg-[#b8941f] text-white px-6 py-2 rounded-lg font-semibold shadow-md transition"
              >
                <i class="fas fa-sync-alt mr-2"></i> Load
              </button>
            </div>
            <div class="ml-auto mt-5 flex flex-col md:flex-row gap-3">
              <div id="monthly-overheads-profit-display" class="text-right">
                <!-- Profit display will be inserted here -->
              </div>
              <div id="monthly-overheads-annual-profit-display" class="text-right">
                <!-- Annual profit display will be inserted here -->
              </div>
            </div>
          </div>

          <!-- Table Container -->
          <div class="overflow-x-auto border rounded-lg bg-white">
            <div id="monthly-overheads-table-container">
              <!-- Table will be dynamically generated here -->
              <div class="text-center py-12 text-gray-400">
                <i class="fas fa-table text-4xl mb-3"></i>
                <p>Select a month and click "Load" to view monthly overheads</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="team-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-[#5c4d1f]">
              <i class="fas fa-users-cog mr-2"></i>Our Team
            </h2>
            <p class="text-sm text-gray-500">Manage staff details, designations, and timings.</p>
          </div>
          <div>
            <button
              onclick="openEmployeeModal()"
              class="bg-[#c9a749] text-white px-4 py-2 rounded-lg hover:bg-[#b8941f] transition font-semibold shadow-md"
            >
              <i class="fas fa-plus mr-2"></i> Add Employee
            </button>
          </div>
        </div>

        <div
          class="kpi-card overflow-hidden"
          style="padding: 0; border-color: rgba(201, 167, 73, 0.2)"
        >
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#c9a749]/30">
              <thead class="bg-gradient-to-r from-[#b8941f] to-[#c9a749] text-white">
                <tr>
                  <th
                    class="px-4 py-3 text-center whitespace-nowrap font-semibold text-xs uppercase"
                  >
                    S.No
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Name
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Designation
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Pay
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Advance
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Duty Timings
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Joining Date
                  </th>
                  <th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">
                    Contact Info
                  </th>
                  <th
                    class="px-4 py-3 text-center whitespace-nowrap font-semibold text-xs uppercase"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="team-table-body" class="divide-y divide-[#c9a749]/10 bg-white"></tbody>
            </table>
          </div>
        </div>
      </section>

      <div
        id="employee-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
      >
        <div
          class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-[#5c4d1f]" id="emp-modal-title">
              <i class="fas fa-user-tie mr-2"></i>Add Employee
            </h3>
            <button
              onclick="closeEmployeeModal()"
              class="text-gray-400 hover:text-gray-600 text-2xl"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <form id="employee-form" onsubmit="saveEmployee(event)">
            <input type="hidden" id="emp-id" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Name *</label>
                <input
                  type="text"
                  id="emp-name"
                  class="w-full border p-2 rounded"
                  placeholder="Full Name"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Designation *</label>
                <input
                  type="text"
                  id="emp-designation"
                  class="w-full border p-2 rounded"
                  placeholder="e.g. CEO, Medical Officer, Cook"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Pay</label>
                <input
                  type="text"
                  id="emp-pay"
                  class="w-full border p-2 rounded"
                  placeholder="Salary Amount"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Advance</label>
                <input
                  type="text"
                  id="emp-advance"
                  class="w-full border p-2 rounded"
                  placeholder="Advance Taken"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Duty Timings</label>
                <input
                  type="text"
                  id="emp-timings"
                  class="w-full border p-2 rounded"
                  placeholder="e.g. 9am to 5pm"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1"
                  >Date of Joining</label
                >
                <input
                  type="text"
                  id="emp-joining"
                  class="w-full border p-2 rounded"
                  placeholder="e.g. September 4, 2024"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">CNIC #</label>
                <input
                  type="text"
                  id="emp-cnic"
                  class="w-full border p-2 rounded"
                  placeholder="XXXXX-XXXXXXX-X"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Phone #</label>
                <input
                  type="text"
                  id="emp-phone"
                  class="w-full border p-2 rounded"
                  placeholder="03XX-XXXXXXX"
                />
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button
                type="submit"
                class="flex-1 bg-[#c9a749] text-white py-3 rounded-lg font-semibold hover:bg-[#b8941f] transition"
              >
                <i class="fas fa-save mr-2"></i>Save Details
              </button>
              <button
                type="button"
                onclick="closeEmployeeModal()"
                class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <div
      id="export-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded shadow w-full max-w-sm mx-4">
        <h3 class="font-bold mb-4">Export Data</h3>
        <button onclick="downloadExcel()" class="bg-[#c9a749] text-white w-full py-2 rounded">
          Download Excel
        </button>
        <button
          onclick="document.getElementById('export-modal').classList.add('hidden')"
          class="w-full py-2 mt-2 text-gray-500"
        >
          Cancel
        </button>
      </div>
    </div>
    <script>
      async function downloadExcel() {
        try {
          console.log('Starting Excel export...');
          const res = await fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: 'all' }),
          });
          console.log('Export response status:', res.status);
          console.log('Export response headers:', {
            contentType: res.headers.get('content-type'),
            contentLength: res.headers.get('content-length'),
          });

          if (res.ok) {
            const b = await res.blob();
            console.log('Received blob, size:', b.size);
            const u = window.URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = 'patients.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(u);
            document.getElementById('export-modal').classList.add('hidden');
            console.log('Export successful!');
          } else {
            const errorData = await res.json();
            console.error('Export error response:', errorData);
            showSuccessModal('Export failed: ' + (errorData.error || 'Unknown error'), true);
          }
        } catch (error) {
          console.error('Export catch error:', error);
          showSuccessModal('Export error: ' + error.message, true);
        }
      }
    </script>

    <div
      id="new-admission-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-[#5c4d1f]">
            <i class="fas fa-user-plus mr-2"></i>New Patient Admission
          </h3>
          <button
            onclick="document.getElementById('new-admission-modal').classList.add('hidden')"
            class="text-gray-400 hover:text-gray-600 text-2xl"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="new-admission-form" onsubmit="addNewPatient(event)">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Patient Name *</label>
              <input
                type="text"
                id="new-patient-name"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter full name"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Father's Name</label>
              <input
                type="text"
                id="new-patient-father"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter father's name"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Admission Date *</label>
              <input
                type="date"
                id="new-patient-admission"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Age</label>
              <input
                type="number"
                id="new-patient-age"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter age"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">CNIC</label>
              <input
                type="text"
                id="new-patient-cnic"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="XXXXX-XXXXXXX-X"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Contact Number</label>
              <input
                type="tel"
                id="new-patient-contact"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="03XX-XXXXXXX"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Area / City</label>
              <input
                type="text"
                id="new-patient-area"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="e.g., DHA Phase 6"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Photo 1</label>
              <input
                type="file"
                accept="image/*"
                id="new-patient-photo1-file"
                class="w-full text-sm"
              />
              <input type="hidden" id="new-patient-photo1-hidden" />
              <div
                class="mt-2 aspect-video rounded border bg-gray-50 overflow-hidden flex items-center justify-center"
              >
                <img
                  id="new-patient-photo1-preview"
                  class="object-cover w-full h-full opacity-40"
                  src="https://via.placeholder.com/300x200?text=No+Photo"
                  alt="No photo"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Photo 2</label>
              <input
                type="file"
                accept="image/*"
                id="new-patient-photo2-file"
                class="w-full text-sm"
              />
              <input type="hidden" id="new-patient-photo2-hidden" />
              <div
                class="mt-2 aspect-video rounded border bg-gray-50 overflow-hidden flex items-center justify-center"
              >
                <img
                  id="new-patient-photo2-preview"
                  class="object-cover w-full h-full opacity-40"
                  src="https://via.placeholder.com/300x200?text=No+Photo"
                  alt="No photo"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Photo 3</label>
              <input
                type="file"
                accept="image/*"
                id="new-patient-photo3-file"
                class="w-full text-sm"
              />
              <input type="hidden" id="new-patient-photo3-hidden" />
              <div
                class="mt-2 aspect-video rounded border bg-gray-50 overflow-hidden flex items-center justify-center"
              >
                <img
                  id="new-patient-photo3-preview"
                  class="object-cover w-full h-full opacity-40"
                  src="https://via.placeholder.com/300x200?text=No+Photo"
                  alt="No photo"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Guardian Name</label>
              <input
                type="text"
                id="new-patient-guardian"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter guardian name"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Monthly Fee</label>
              <input
                type="number"
                id="new-patient-fee"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="0"
                value="0"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold text-gray-700 mb-1">Address</label>
              <textarea
                id="new-patient-address"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter complete address"
                rows="2"
              ></textarea>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Received Amount</label>
              <input
                type="number"
                id="new-patient-received"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="0"
                value="0"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold text-gray-700 mb-1">Drug</label>
              <input
                type="text"
                id="new-patient-drug"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="Enter drug name or details"
              />
            </div>

            <div class="md:col-span-2">
              <div
                class="flex items-center gap-3 p-3 bg-[#fffbf0] border border-[#c9a749] rounded-lg"
              >
                <input
                  type="checkbox"
                  id="new-patient-laundry-status"
                  class="w-5 h-5 text-[#c9a749] border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 cursor-pointer"
                />
                <label for="new-patient-laundry-status" class="flex-1 cursor-pointer">
                  <span class="text-sm font-semibold text-gray-700">Enable Laundry Service</span>
                  <p class="text-xs text-gray-600 mt-0.5">
                    If checked, laundry fee will be set to PKR 3,500 (can be changed later)
                  </p>
                </label>
              </div>
            </div>

            <div id="laundry-amount-container" class="hidden">
              <label class="block text-sm font-semibold text-gray-700 mb-1"
                >Laundry Amount (PKR)</label
              >
              <input
                type="number"
                id="new-patient-laundry-amount"
                class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-[#c9a749] focus:border-transparent"
                placeholder="3500"
                value="3500"
              />
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              type="submit"
              class="flex-1 bg-[#c9a749] text-white py-3 rounded-lg font-semibold hover:bg-[#b8941f] transition"
            >
              <i class="fas fa-check mr-2"></i>Admit Patient
            </button>
            <button
              type="button"
              onclick="
                document.getElementById('new-admission-modal').classList.add('hidden');
                document.getElementById('new-admission-form').reset();
              "
              class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
            >
              <i class="fas fa-times mr-2"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="success-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 text-center transform transition-all"
      >
        <div id="success-icon" class="mb-4">
          <i class="fas fa-check-circle text-6xl text-green-500"></i>
        </div>
        <p id="success-message" class="text-xl font-semibold text-gray-800 mb-6">
          Patient admitted successfully!
        </p>
        <button
          onclick="document.getElementById('success-modal').classList.add('hidden')"
          class="bg-[#c9a749] text-white px-6 py-2 rounded-lg font-semibold hover:bg-[#b8941f] transition"
        >
          OK
        </button>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 text-center transform transition-all"
      >
        <div class="mb-4">
          <i class="fas fa-question-circle text-6xl text-blue-500"></i>
        </div>
        <p id="confirm-message" class="text-xl font-semibold text-gray-800 mb-6">Are you sure?</p>
        <div class="flex gap-3 justify-center">
          <button
            id="confirm-cancel-btn"
            onclick="window.confirmCallback(false)"
            class="bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-600 transition"
          >
            Cancel
          </button>
          <button
            id="confirm-ok-btn"
            onclick="window.confirmCallback(true)"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <div
      id="password-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded shadow w-full max-w-sm mx-4">
        <h3 class="font-bold mb-4">Change Password</h3>
        <form onsubmit="changePassword(event)">
          <input
            name="old-password"
            type="password"
            class="w-full border p-2 mb-2 rounded"
            placeholder="Old Password"
          />
          <input
            name="new-password-user"
            type="password"
            class="w-full border p-2 mb-4 rounded"
            placeholder="New Password"
          />
          <button class="bg-blue-600 text-white w-full py-2 rounded">Update</button>
        </form>
        <button
          onclick="document.getElementById('password-modal').classList.add('hidden')"
          class="w-full py-2 mt-2 text-gray-500"
        >
          Cancel
        </button>
      </div>
    </div>

    <!-- CALL & MEETING ENTRY MODAL -->
    <div
      id="call_meeting_modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Call/Meeting Entry</h2>
        <form onsubmit="saveCallMeetingEntry(event)" id="call_meeting_form">
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Patient Name</label>
            <div class="searchable-dropdown">
              <input
                id="cm-name"
                type="text"
                class="w-full border p-2 rounded"
                placeholder="Search patient name..."
                required
                autocomplete="off"
              />
              <div
                id="cm-name-dropdown"
                class="searchable-dropdown-list"
                style="display: none"
              ></div>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Admission Date</label>
            <input
              id="cm-admission-date"
              type="date"
              class="w-full border p-2 rounded"
              required
              readonly
            />
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Scheduled Date</label>
              <input id="cm-date" type="date" class="w-full border p-2 rounded" required />
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Type</label>
              <select id="cm-status" class="w-full border p-2 rounded" required>
                <option value="Meeting">Meeting (Tick)</option>
                <option value="Call">Call (Cross)</option>
              </select>
            </div>
          </div>
          <button type="submit" class="bg-[#c9a749] text-white w-full py-2 rounded">Save</button>
        </form>
        <button
          onclick="document.getElementById('call_meeting_modal').classList.add('hidden')"
          class="w-full py-2 mt-2 text-gray-500"
        >
          Cancel
        </button>
      </div>
    </div>

    <!-- CALL & MEETING DELETE CONFIRM MODAL (deprecated; inline toggle used instead) -->

    <!-- ADMISSIONS THIS MONTH MODAL -->
    <div
      id="admissions-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl mx-4">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-900">Admissions (This Month)</h3>
            <p class="text-sm text-gray-600">All patients admitted this month.</p>
          </div>
          <button onclick="closeAdmissionsModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>

        <div
          id="admissions-month-body"
          class="max-h-80 overflow-y-auto divide-y divide-[#c9a749]/10"
        ></div>

        <div class="mt-6 text-right">
          <button
            onclick="closeAdmissionsModal()"
            class="px-4 py-2 bg-[#c9a749] text-white rounded-lg font-semibold hover:bg-[#b8941f] transition"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- EXPENSE ENTRY MODAL -->
    <div
      id="expense-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Expense</h2>
        <form onsubmit="saveExpense(event)" id="expense-form">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Type</label>
              <select id="exp-type" class="w-full border p-2 rounded" required>
                <option value="outgoing">Outgoing</option>
                <option value="incoming">Incoming</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">Amount</label>
              <input id="exp-amount" type="number" class="w-full border p-2 rounded" required />
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Category</label>
            <input
              id="exp-category"
              type="text"
              class="w-full border p-2 rounded"
              placeholder="e.g., Utilities, Fees"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Date</label>
            <input id="exp-date" type="date" class="w-full border p-2 rounded" />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Note</label>
            <textarea
              id="exp-note"
              class="w-full border p-2 rounded"
              rows="2"
              placeholder="Optional"
            ></textarea>
          </div>
          <button type="submit" class="bg-[#c9a749] text-white w-full py-2 rounded">Save</button>
        </form>
        <button
          onclick="document.getElementById('expense-modal').classList.add('hidden')"
          class="w-full py-2 mt-2 text-gray-500"
        >
          Cancel
        </button>
      </div>
    </div>

    <script>
      async function changePassword(e) {
        e.preventDefault();
        const f = e.target;
        const res = await fetch('/api/users/change_password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            old_password: f['old-password'].value,
            new_password: f['new-password-user'].value,
          }),
        });
        if (res.ok) {
          showSuccessModal('Password Updated');
          f.reset();
          document.getElementById('password-modal').classList.add('hidden');
        } else {
          showSuccessModal('Error', true);
        }
      }
    </script>

    <div id="printable-discharge-slip" class="hidden bg-white p-8 max-w-4xl mx-auto text-gray-800">
      <!-- TABLE Layout for absolute stability in Header -->
      <table class="w-full border-b-2 border-emerald-600 mb-4" style="border-collapse: collapse">
        <tr style="border: none !important">
          <!-- Left: Logo -->
          <td
            class="text-left align-middle"
            style="width: 20%; border: none !important; padding: 0 0 8px 0"
          >
            <img
              src="/static/RoohLogo.jpg"
              alt="Rooh Logo"
              style="width: 64px; height: 64px; border-radius: 50%; border: 1px solid #c9a749"
            />
          </td>

          <!-- Center: Header Text -->
          <td
            class="text-center align-middle"
            style="width: 60%; border: none !important; padding: 0 0 8px 0"
          >
            <h1
              class="text-2xl font-bold text-gray-900 tracking-tight leading-none whitespace-nowrap"
              style="margin: 0"
            >
              Rooh
            </h1>
            <h2
              class="text-xs font-bold text-[#5c4d1f] tracking-wider leading-none mt-1 whitespace-nowrap"
              style="margin: 4px 0 0 0"
            >
              ROOH
            </h2>
            <p
              class="text-[9px] text-gray-500 mt-1 leading-tight whitespace-nowrap"
              style="margin: 4px 0 0 0"
            >
              Addiction Treatment & Psychological Services
            </p>
            <p class="text-[9px] text-gray-500 leading-tight whitespace-nowrap" style="margin: 0">
              Lahore, Pakistan
            </p>
          </td>

          <!-- Right: Doc Info -->
          <td
            class="text-right align-middle"
            style="width: 20%; border: none !important; padding: 0 0 8px 0"
          >
            <div class="text-xl font-bold text-gray-800 leading-tight whitespace-nowrap">
              DISCHARGE BILL
            </div>
            <p class="text-[10px] text-gray-500 mt-1 whitespace-nowrap" style="margin: 4px 0 0 0">
              Date: <span id="ds-date-print"></span>
            </p>
          </td>
        </tr>
      </table>

      <div class="bg-gray-50 rounded-lg p-6 mb-8 border border-gray-200">
        <div class="grid grid-cols-2 gap-y-4 gap-x-8 text-sm">
          <div class="flex justify-between border-b border-gray-200 pb-1">
            <span class="font-bold text-gray-600">Patient Name:</span>
            <span id="ds-name" class="font-semibold text-gray-900"></span>
          </div>
          <div class="flex justify-between border-b border-gray-200 pb-1">
            <span class="font-bold text-gray-600">Father/Guardian:</span>
            <span id="ds-father" class="font-semibold text-gray-900"></span>
          </div>
          <div class="flex justify-between border-b border-gray-200 pb-1">
            <span class="font-bold text-gray-600">Admission Date:</span>
            <span id="ds-admission" class="font-semibold text-gray-900"></span>
          </div>
          <div class="flex justify-between border-b border-gray-200 pb-1">
            <span class="font-bold text-gray-600">CNIC / ID:</span>
            <span id="ds-cnic" class="font-semibold text-gray-900"></span>
          </div>
        </div>
      </div>

      <h3 class="font-bold text-lg text-gray-800 mb-3 border-l-4 border-[#c9a749] pl-3">
        Account Summary
      </h3>
      <table class="w-full text-sm border-collapse mb-3">
        <thead>
          <tr class="bg-[#c9a749] text-white">
            <th class="p-3 text-left w-1/2">Description</th>
            <th class="p-3 text-right">Amount (PKR)</th>
          </tr>
        </thead>
        <tbody class="border border-gray-200">
          <tr class="border-b">
            <td class="p-3">Monthly Fees (Total Accrued)</td>
            <td class="p-3 text-right font-mono" id="ds-total-fee">0</td>
          </tr>
          <tr class="border-b">
            <td class="p-3">Canteen & Misc Charges</td>
            <td class="p-3 text-right font-mono" id="ds-total-canteen">0</td>
          </tr>
          <tr class="border-b">
            <td class="p-3">Laundry / Other Services</td>
            <td class="p-3 text-right font-mono" id="ds-total-laundry">0</td>
          </tr>
          <tr class="bg-gray-100 font-bold text-gray-900">
            <td class="p-3 text-right">GROSS TOTAL:</td>
            <td class="p-3 text-right font-mono text-lg" id="ds-gross-total">0</td>
          </tr>
        </tbody>
      </table>

      <h3 class="font-bold text-lg text-gray-800 mb-3 border-l-4 border-blue-500 pl-3">
        Payment History (Credits)
      </h3>
      <table class="w-full text-sm border-collapse mb-2">
        <thead>
          <tr class="bg-gray-800 text-white text-xs uppercase">
            <th class="p-1 text-left">Date</th>
            <th class="p-1 text-left">Mode</th>
            <th class="p-1 text-left">Note</th>
            <th class="p-1 text-right">Amount Paid</th>
          </tr>
        </thead>
        <tbody id="ds-payment-history-body" class="border border-gray-200"></tbody>
        <tfoot>
          <tr class="bg-gray-100 font-bold border-t-2 border-gray-300">
            <td colspan="3" class="p-1 text-right">TOTAL RECEIVED:</td>
            <td class="p-1 text-right font-mono text-[#5c4d1f]" id="ds-total-received">0</td>
          </tr>
        </tfoot>
      </table>

      <div class="flex justify-end mt-3 mb-6">
        <div class="bg-gray-900 text-white p-3 rounded-lg shadow-lg text-center w-64">
          <div class="text-xs uppercase tracking-widest text-gray-400 mb-1">
            Net Payable Balance
          </div>
          <div class="text-3xl font-mono font-bold" id="ds-net-balance">PKR 0</div>
        </div>
      </div>

      <div
        class="flex justify-between items-end text-center text-sm text-gray-600 mt-8 pt-6 border-t border-gray-300"
      >
        <div class="w-48">
          <p class="border-b border-gray-400 mb-1 pb-3"></p>
          <p class="font-bold">Accountant Signature</p>
        </div>
        <div class="w-48">
          <p class="border-b border-gray-400 mb-1 pb-3"></p>
          <p class="font-bold">Admin / Authority</p>
        </div>
      </div>
    </div>

    <div id="printable-area">
      <div class="print-container">
        <div class="print-header">
          <img
            src="/static/RoohLogo.jpg"
            alt="Rooh Logo"
            class="print-logo-img"
            style="width: 64px; height: 64px; border-radius: 50%; border: 1px solid #c9a749"
          />
          <div class="print-title-block">
            <div class="print-pro">Rooh</div>
            <div class="print-sub-pro">ROOH</div>
            <div class="print-tagline">Addiction Treatment & Psychological Services</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-x-8 text-sm">
          <div class="print-row">
            <span class="print-label">Patient's Name:</span
            ><span id="pr-name" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Father's Name:</span
            ><span id="pr-father" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Admission Date:</span
            ><span id="pr-admission" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">I.D. No.:</span><span id="pr-id" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Age:</span><span id="pr-age" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">CNIC No.:</span><span id="pr-cnic" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Guardian:</span
            ><span id="pr-guardian" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Relation:</span
            ><span id="pr-relation" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Drug:</span><span id="pr-drug" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Contact:</span
            ><span id="pr-contact" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Marital Status:</span
            ><span id="pr-marital" class="print-value"></span>
          </div>
          <div class="print-row">
            <span class="print-label">Prev Admissions:</span
            ><span id="pr-prev" class="print-value"></span>
          </div>
        </div>
        <div class="print-row mt-4">
          <span class="print-label w-24">Address:</span
          ><span id="pr-address" class="print-value"></span>
        </div>
        <div class="print-row">
          <span class="print-label w-32">Complaint:</span
          ><span id="pr-complaint" class="print-value"></span>
        </div>

        <div class="mt-6 border border-black h-32 p-2"><strong>History:</strong></div>
        <div class="mt-4 border border-black h-32 p-2">
          <strong>General Physical Examination:</strong>
        </div>
        <div class="mt-6">
          <strong>Vitals</strong>
          <table class="print-table">
            <tr>
              <th>Resp</th>
              <td></td>
              <th>BP</th>
              <td></td>
            </tr>
            <tr>
              <th>GIT</th>
              <td></td>
              <th>Pulse</th>
              <td></td>
            </tr>
            <tr>
              <th>CVS</th>
              <td></td>
              <th>Temp</th>
              <td></td>
            </tr>
            <tr>
              <th>CNS</th>
              <td></td>
              <th>R/R</th>
              <td></td>
            </tr>
            <tr>
              <th>BSR</th>
              <td></td>
              <th>Weight</th>
              <td></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="page-break"></div>

      <div class="print-container">
        <h2 class="text-xl font-bold text-center mb-4">Drug Abuse Screening Test, DAST-10</h2>
        <table class="print-table">
          <thead>
            <tr class="bg-gray-100">
              <th class="w-12">#</th>
              <th>Question</th>
              <th class="w-12">Yes</th>
              <th class="w-12">No</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Have you used drugs other than for medical reasons?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>2</td>
              <td>Do you abuse more than one drug at a time?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>3</td>
              <td>Are you unable to stop abusing drugs when you want to?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>4</td>
              <td>Have you ever had blackouts or flashbacks?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>5</td>
              <td>Do you ever feel bad or guilty about your drug use?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>6</td>
              <td>Does your spouse/parents ever complain about your drug use?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>7</td>
              <td>Have you neglected your family because of drugs?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>8</td>
              <td>Have you engaged in illegal activities to obtain drugs?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>9</td>
              <td>Have you ever experienced withdrawal symptoms?</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>10</td>
              <td>Have you had medical problems due to drug use?</td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="page-break"></div>

      <div class="print-container">
        <h2 class="text-center font-bold text-2xl mb-4">Consent Form /  </h2>
        <div class="urdu-text text-right text-lg">
          <p class="urdu-row">
              : <span id="ur-name" class="underline font-bold px-2"></span> :
            <span id="ur-father" class="underline font-bold px-2"></span> :
            <span id="ur-age" class="underline font-bold px-2"></span>
          </p>
          <p class="urdu-row">
             : <span id="ur-cnic" class="underline font-bold px-2"></span>  :
            <span id="ur-contact" class="underline font-bold px-2"></span> :
            <span id="ur-address" class="underline font-bold px-2"></span>
          </p>
          <p class="mb-4 text-justify">
                 /            
            ... (Full Consent Text Restored)
          </p>
          <div class="flex justify-between mt-12 px-8">
            <div class="text-center">
              <p>__________________</p>
              <p>  </p>
            </div>
            <div class="text-center">
              <p>__________________</p>
              <p>/  </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="receipt-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-file-invoice-dollar mr-2"></i>New Payment Receipt
          </h3>
          <button
            onclick="document.getElementById('receipt-modal').classList.add('hidden')"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form onsubmit="handleReceiptGeneration(event)">
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Select Patient</label>
            <input
              id="receipt-patient-input"
              list="receipt-patient-list"
              oninput="handleReceiptPatientInputChange()"
              autocomplete="off"
              class="w-full border p-3 rounded bg-gray-50 focus:ring-2 focus:ring-emerald-500"
              placeholder="Start typing patient name"
              required
            />
            <datalist id="receipt-patient-list"></datalist>
            <input type="hidden" id="receipt-patient-id" />
            <p class="text-xs text-gray-500 mt-1">
              Type a name or ID to filter and then select a match.
            </p>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Receipt Date</label>
            <input
              type="date"
              id="receipt-date"
              class="w-full border p-3 rounded bg-white focus:ring-2 focus:ring-emerald-500"
              required
            />
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1"
              >Amount Paying Now (PKR)</label
            >
            <input
              id="receipt-amount"
              type="number"
              class="w-full border p-3 rounded text-lg font-mono"
              placeholder="e.g. 5000"
              required
            />
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">Payment Mode</label>
            <select
              id="receipt-mode"
              onchange="toggleReceiptScreenshot()"
              class="w-full border p-3 rounded bg-white focus:ring-2 focus:ring-emerald-500"
            >
              <option value="Cash">Cash</option>
              <option value="Online">Online / Bank Transfer</option>
            </select>
          </div>

          <div id="receipt-screenshot-container" class="mb-6 hidden">
            <label class="block text-sm font-bold text-gray-700 mb-1"
              >Upload Payment Screenshot</label
            >
            <input
              type="file"
              id="receipt-screenshot-file"
              accept="image/*"
              class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#fffbf0] file:text-[#5c4d1f] hover:file:bg-[#c9a749]/20"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-[#c9a749] hover:bg-[#b8941f] text-white py-3 rounded-lg font-bold shadow transition"
          >
            Generate & Print
          </button>
        </form>
      </div>
    </div>

    <div id="printable-receipt" class="hidden">
      <div class="p-8 border-2 border-gray-800 m-4 max-w-2xl mx-auto relative">
        <div class="flex items-center justify-center gap-4 border-b-2 border-gray-800 pb-6 mb-6">
          <img
            src="/static/RoohLogo.jpg"
            alt="Rooh Logo"
            class="w-16 h-16 rounded-full border-2 border-gray-800"
          />
          <div class="text-center">
            <h1 class="text-3xl font-bold tracking-wider">Rooh</h1>
            <h2 class="text-xl font-bold">ROOH</h2>
            <p class="text-sm text-gray-600 uppercase tracking-widest">Payment Receipt</p>
          </div>
        </div>

        <div class="flex justify-between items-end mb-8">
          <div>
            <p class="text-sm text-gray-500">Receipt No:</p>
            <p class="font-mono font-bold text-lg" id="rcpt-no">#0000</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-500">Date & Time:</p>
            <div class="font-bold">
              <span id="rcpt-date">--/--/----</span>
              <span id="rcpt-time" class="ml-2 text-sm text-gray-600">--:--</span>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase">Received From</p>
              <p class="text-xl font-bold text-gray-800" id="rcpt-name">Patient Name</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Father's Name</p>
              <p class="text-lg font-semibold text-gray-800" id="rcpt-father">Father Name</p>
            </div>
          </div>
        </div>

        <div class="mb-8">
          <div class="flex justify-between items-center border-b border-gray-300 py-2">
            <span class="text-lg font-medium">Payment Amount:</span>
            <span class="text-2xl font-bold" id="rcpt-amount">PKR 0</span>
          </div>
          <div class="flex justify-between items-center py-2 text-gray-500 text-sm">
            <span>Payment Method:</span>
            <span id="rcpt-mode-display" class="font-bold text-gray-800 uppercase">Cash</span>
          </div>
        </div>

        <div
          id="rcpt-screenshot-area"
          class="mb-8 hidden border border-dashed border-gray-300 p-2 rounded flex flex-col items-center"
        >
          <p class="text-xs text-gray-400 mb-2 uppercase tracking-wide">
            Transaction Proof / Screenshot
          </p>
          <img
            id="rcpt-screenshot-img"
            src=""
            alt="Payment Screenshot"
            class="max-h-64 object-contain"
          />
        </div>

        <div class="flex justify-between mt-12 pt-4">
          <div class="text-center w-40 border-t border-gray-400">
            <p class="text-sm">Accountant</p>
          </div>
          <div class="text-center w-40 border-t border-gray-400">
            <p class="text-sm">Authorized Signature</p>
          </div>
        </div>

        <div class="text-center mt-8 text-xs text-gray-400">
          <p>Thank you for your payment.</p>
          <p>Rooh - Addiction Treatment & Psychological Services</p>
        </div>
      </div>
    </div>

    <!-- Payment Records Modal -->
    <div
      id="payment-records-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col border border-emerald-100"
      >
        <div class="flex justify-between items-center p-6 border-b border-emerald-100">
          <h3 class="text-xl font-bold text-[#5c4d1f]">
            <i class="fas fa-file-invoice-dollar mr-2 text-[#c9a749]"></i>Payment Records
          </h3>
          <div class="flex items-center gap-3">
            <button
              onclick="exportPaymentRecords('six_months')"
              class="flex items-center gap-2 bg-[#fffbf0] text-[#5c4d1f] px-3 py-2 rounded-lg text-sm font-semibold hover:bg-[#c9a749]/20"
              type="button"
            >
              <i class="fas fa-file-excel"></i>
              Last 6 Months
            </button>
            <button
              onclick="exportPaymentRecords('current')"
              class="flex items-center gap-2 bg-[#c9a749] text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-[#b8941f]"
              type="button"
            >
              <i class="fas fa-file-export"></i>
              This Month
            </button>
            <button
              onclick="document.getElementById('payment-records-modal').classList.add('hidden')"
              class="text-gray-400 hover:text-gray-600"
              type="button"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <div class="p-6 overflow-y-auto flex-1">
          <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
              <input
                type="text"
                id="payment-records-search"
                placeholder="Search by patient name..."
                oninput="filterPaymentRecords()"
                class="border border-[#c9a749] rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-emerald-500 w-64"
              />
            </div>
            <div class="text-sm text-gray-600">
              Total Records:
              <span id="payment-records-count" class="font-bold text-[#c9a749]">0</span>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#c9a749]/30">
              <thead class="bg-[#c9a749] text-white">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold">#</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold">Patient Name</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold">Amount (PKR)</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold">Payment Mode</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold">Recorded By</th>
                  <th class="px-4 py-3 text-center text-sm font-semibold">Proof</th>
                </tr>
              </thead>
              <tbody
                id="payment-records-body"
                class="divide-y divide-[#c9a749]/10 bg-white text-sm"
              >
                <tr>
                  <td colspan="7" class="p-8 text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading payment records...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="p-4 border-t border-emerald-100 bg-[#fffbf0] rounded-b-xl">
          <div class="flex justify-between items-center">
            <div class="text-sm text-gray-600">
              Total Amount:
              <span id="payment-records-total" class="font-bold text-[#c9a749]">PKR 0</span>
            </div>
            <button
              onclick="document.getElementById('payment-records-modal').classList.add('hidden')"
              class="bg-[#c9a749] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#b8941f] transition"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Psych Session Note Modal -->
    <div
      id="psych-note-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-[60]"
    >
      <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-[#5c4d1f]">Daily Psychologist Progress Note</h3>
          <button onclick="closePsychNoteModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="text-xs font-semibold text-gray-600">Date</label>
            <input
              type="date"
              id="psych-note-date"
              class="w-full border rounded px-3 py-2"
              disabled
            />
          </div>
          <div class="md:col-span-2">
            <label class="text-xs font-semibold text-gray-600">Here & Now Issue</label>
            <input
              type="text"
              id="psych-note-issue"
              class="w-full border rounded px-3 py-2"
              placeholder="Mood / craving / behavior"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs font-semibold text-gray-600">Intervention</label>
            <textarea
              id="psych-note-intervention"
              class="w-full border rounded px-3 py-2 h-20"
              placeholder="Supportive / CBT / MI"
            ></textarea>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-600">Response / Plan</label>
            <textarea
              id="psych-note-response"
              class="w-full border rounded px-3 py-2 h-20"
              placeholder="Stable / Improving / Continue"
            ></textarea>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button class="px-4 py-2 rounded border" onclick="closePsychNoteModal()">Cancel</button>
          <button class="px-4 py-2 rounded bg-[#c9a749] text-white" onclick="savePsychNote()">
            Save Note
          </button>
        </div>
      </div>
    </div>

    <!-- Screenshot Preview Modal -->
    <div
      id="screenshot-preview-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center z-[60]"
      onclick="this.classList.add('hidden')"
    >
      <div class="bg-white p-4 rounded-xl shadow-2xl max-w-3xl max-h-[90vh] overflow-auto">
        <img
          id="screenshot-preview-img"
          src=""
          alt="Payment Screenshot"
          class="max-w-full h-auto"
        />
      </div>
    </div>
    <script>
      async function renderAttendanceTable(targetMonthValue) {
        const headerRow = document.getElementById('attendance-header-row');
        const tbody = document.getElementById('attendance-table-body');
        const monthInput = document.getElementById('attendance-month');

        if (!headerRow || !tbody) return;

        const baseDate = (() => {
          if (targetMonthValue) return new Date(`${targetMonthValue}-01`);
          if (monthInput?.value) return new Date(`${monthInput.value}-01`);
          return new Date();
        })();

        const year = baseDate.getFullYear();
        const month = baseDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        if (monthInput && !monthInput.value) {
          monthInput.value = `${year}-${String(month + 1).padStart(2, '0')}`;
        }

        // Fetch employees
        let employees = [];
        try {
          const res = await fetch('/api/employees');
          if (res.ok) employees = await res.json();
        } catch (e) {
          console.error('Employee fetch failed', e);
        }

        // Fetch attendance
        let attendance = {};
        try {
          const res = await fetch(`/api/attendance?year=${year}&month=${month + 1}`);
          if (res.ok) attendance = await res.json();
        } catch (e) {
          console.error('Attendance fetch failed', e);
        }

        // Header
        let headerHTML = `
    <th class="sticky left-0 bg-[#c9a749] text-white px-4 py-2 w-48">Employee</th>
  `;
        for (let d = 1; d <= daysInMonth; d++) {
          headerHTML += `<th class="px-2 py-2 text-center bg-[#c9a749] text-white border-l border-[#c9a749]">${d}</th>`;
        }
        headerRow.innerHTML = headerHTML;

        // Body
        tbody.innerHTML = '';
        employees.forEach((emp) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';

          let rowHTML = `
      <td class="sticky left-0 bg-gray-100 px-3 py-2 font-semibold">
        ${emp.name}
      </td>
    `;

          for (let d = 1; d <= daysInMonth; d++) {
            const mark = attendance[emp.id]?.[String(d)] || '';
            const color =
              mark === 'P'
                ? 'bg-green-200'
                : mark === 'A'
                  ? 'bg-red-200'
                  : mark === 'H'
                    ? 'bg-yellow-200'
                    : '';

            rowHTML += `
        <td class="border text-center cursor-pointer ${color}"
            data-emp="${emp.id}" data-day="${d}">
          ${mark === 'P' ? '' : mark === 'A' ? '' : mark === 'H' ? '' : ''}
        </td>
      `;
          }

          tr.innerHTML = rowHTML;
          tbody.appendChild(tr);
        });

        // Click handler
        tbody.querySelectorAll('td[data-emp]').forEach((cell) => {
          cell.onclick = async () => {
            const empId = cell.dataset.emp;
            const day = cell.dataset.day;

            let current = cell.textContent.trim();
            let mark = current === '' ? 'P' : current === '' ? 'A' : current === '' ? 'H' : '';

            cell.textContent = mark === 'P' ? '' : mark === 'A' ? '' : mark === 'H' ? '' : '';
            cell.classList.toggle('bg-green-200', mark === 'P');
            cell.classList.toggle('bg-red-200', mark === 'A');
            cell.classList.toggle('bg-yellow-200', mark === 'H');

            await fetch('/api/attendance', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ empId, day, year, month: month + 1, mark }),
            });
          };
        });
      }
      document.addEventListener('DOMContentLoaded', () => {
        const monthInput = document.getElementById('attendance-month');
        const printBtn = document.getElementById('attendance-print-btn');

        if (monthInput && !monthInput.value) {
          const today = new Date();
          monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(
            2,
            '0'
          )}`;
        }

        if (monthInput) {
          monthInput.addEventListener('change', () => renderAttendanceTable(monthInput.value));
        }

        if (printBtn) {
          printBtn.addEventListener('click', async () => {
            const targetMonth = monthInput ? monthInput.value : undefined;
            await renderAttendanceTable(targetMonth); // ensure latest month is rendered before print

            const section = document.getElementById('attendance-section');
            const clone = section ? section.cloneNode(true) : null;

            if (clone) {
              clone.id = 'attendance-print-clone';
              clone.classList.add('attendance-print-container');
              document.body.appendChild(clone);
            }

            document.body.classList.add('print-attendance');
            window.print();

            setTimeout(() => {
              document.body.classList.remove('print-attendance');
              if (clone) clone.remove();
            }, 300);
          });
        }

        renderAttendanceTable(monthInput ? monthInput.value : undefined);
      });
    </script>

    <div
      id="prescription-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-file-medical mr-2 text-[#c9a749]"></i>Generate Prescription
          </h3>
          <button
            onclick="document.getElementById('prescription-modal').classList.add('hidden')"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <form id="prescription-form" onsubmit="handlePrescriptionGeneration(event)">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-gray-50 p-4 rounded-lg">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
                >Patient Name</label
              >
              <input
                id="prescription-patient-input"
                list="prescription-patient-list"
                oninput="handlePrescriptionInput()"
                autocomplete="off"
                class="w-full border p-2 rounded focus:ring-2 focus:ring-emerald-500"
                placeholder="Search or type name..."
                required
              />
              <datalist id="prescription-patient-list"></datalist>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Age</label>
              <input
                id="prescription-patient-age"
                type="text"
                class="w-full border p-2 rounded focus:ring-2 focus:ring-emerald-500"
                placeholder="e.g. 25"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Diagnosis</label>
              <textarea
                id="prescription-diagnosis"
                class="w-full border p-2 rounded h-20"
                placeholder="Enter diagnosis..."
              ></textarea>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Symptoms</label>
              <textarea
                id="prescription-symptoms"
                class="w-full border p-2 rounded h-20"
                placeholder="Enter symptoms..."
              ></textarea>
            </div>
          </div>

          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label class="block text-xs font-bold text-gray-500 uppercase">Medications</label>
              <button
                type="button"
                onclick="addMedicationRow()"
                class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200"
              >
                <i class="fas fa-plus mr-1"></i> Add Med
              </button>
            </div>

            <div
              class="bg-gray-100 p-2 rounded-t text-xs font-bold text-gray-600 grid grid-cols-12 gap-2"
            >
              <div class="col-span-4">Medicine Name</div>
              <div class="col-span-3">Dosage</div>
              <div class="col-span-2">Duration</div>
              <div class="col-span-2">Instructions</div>
              <div class="col-span-1"></div>
            </div>

            <div
              id="medication-rows-container"
              class="max-h-60 overflow-y-auto border border-t-0 p-2 rounded-b"
            ></div>
          </div>

          <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1"
              >Additional Notes / Follow Up</label
            >
            <textarea
              id="prescription-notes"
              class="w-full border p-2 rounded h-16"
              placeholder="Any special instructions..."
            ></textarea>
          </div>

          <div class="flex gap-3">
            <button
              type="submit"
              class="flex-1 bg-[#c9a749] hover:bg-[#b8941f] text-white py-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"
            >
              <i class="fas fa-print"></i> Generate & Print
            </button>
            <button
              type="button"
              onclick="document.getElementById('prescription-modal').classList.add('hidden')"
              class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="printable-prescription" class="hidden">
      <div class="prescription-container bg-white flex flex-col font-sans text-gray-900">
        <div>
          <div class="flex items-center justify-between border-b-2 border-emerald-800 pb-4 mb-6">
            <div class="flex items-center gap-4">
              <i class="fas fa-brain text-5xl text-[#5c4d1f]"></i>
              <div>
                <h1 class="text-3xl font-bold tracking-wider leading-none">Rooh</h1>
                <h2 class="text-sm font-bold text-[#5c4d1f] tracking-widest uppercase mb-1">
                  Rooh
                </h2>
                <p class="text-xs text-gray-500">Addiction Treatment & Psychological Services</p>
                <p class="text-xs text-gray-500">Lahore, Pakistan</p>
              </div>
            </div>
            <div class="text-right">
              <div
                class="text-3xl font-bold text-gray-800 uppercase tracking-widest"
                style="color: #064e3b"
              >
                Prescription
              </div>
              <div class="mt-2 text-sm font-semibold text-gray-600">
                Date:
                <span
                  id="rx-date-print"
                  class="font-mono text-lg text-gray-900 border-b border-gray-400 px-2 ml-2"
                ></span>
              </div>
            </div>
          </div>

          <div class="bg-[#fffbf0] p-4 rounded-lg border border-emerald-100 mb-6">
            <div class="flex gap-8 items-end text-sm">
              <div class="flex-1">
                <span class="block text-xs font-bold text-[#5c4d1f] uppercase tracking-wide mb-1"
                  >Patient Name</span
                >
                <span
                  id="rx-name-print"
                  class="text-xl font-bold text-gray-900 border-b border-gray-300 w-full block pb-1 min-h-[30px]"
                ></span>
              </div>
              <div class="w-32">
                <span class="block text-xs font-bold text-[#5c4d1f] uppercase tracking-wide mb-1"
                  >Age</span
                >
                <span
                  id="rx-age-print"
                  class="text-xl font-bold text-gray-900 border-b border-gray-300 w-full block pb-1 min-h-[30px]"
                ></span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-10 mb-6">
            <div>
              <h3
                class="font-bold text-[#5c4d1f] uppercase text-xs mb-2 border-b-2 border-emerald-100 inline-block pb-1"
              >
                Diagnosis
              </h3>
              <div id="rx-diagnosis-print" class="text-sm text-gray-800 min-h-[40px]"></div>
            </div>
            <div>
              <h3
                class="font-bold text-[#5c4d1f] uppercase text-xs mb-2 border-b-2 border-emerald-100 inline-block pb-1"
              >
                Symptoms
              </h3>
              <div id="rx-symptoms-print" class="text-sm text-gray-800 min-h-[40px]"></div>
            </div>
          </div>

          <div class="mb-4">
            <div class="flex items-end gap-2 mb-2">
              <span class="text-4xl font-serif font-bold text-[#5c4d1f] leading-none">Rx</span>
            </div>
            <table class="w-full text-sm border-collapse">
              <thead>
                <tr class="bg-gray-100 text-gray-700 uppercase text-[10px] tracking-wider">
                  <th class="border border-gray-400 p-2 text-center w-10">#</th>
                  <th class="border border-gray-400 p-2 text-left w-[35%]">Medicine Name</th>
                  <th class="border border-gray-400 p-2 text-left">Dosage</th>
                  <th class="border border-gray-400 p-2 text-left">Duration</th>
                  <th class="border border-gray-400 p-2 text-left w-[25%]">Instructions</th>
                </tr>
              </thead>
              <tbody id="rx-table-body" class="text-gray-800"></tbody>
            </table>
          </div>

          <div class="mt-4">
            <h3 class="font-bold text-[#5c4d1f] uppercase text-xs mb-1">
              Additional Notes / Follow Up
            </h3>
            <div
              id="rx-notes-print"
              class="text-sm text-gray-800 p-2 border border-gray-200 rounded min-h-[60px]"
            ></div>
          </div>

          <div class="mt-4 pt-2">
            <div class="flex justify-between items-end">
              <div class="text-[10px] text-gray-400">Generated by Rooh System</div>
              <div class="text-center w-48">
                <div class="border-b-2 border-gray-800 mb-2"></div>
                <p class="font-bold text-gray-800 text-sm">Doctor's Signature</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
